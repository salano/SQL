SELECT 
	ACCOUNTNUMBER,
	BID,
	LINE_OF_SERVICE,
	SUBLINE_OF_SERVICE,
	SUBLINE_OF_SERVICE_SEGMENT,
	PRODUCT_NAME,
	CUSTOMER_TYPE_NAME,
	C.BILL_FNAME,
	C.BILL_LNAME,
	C.BILL_COMPANY,
	C.CUST_EMAIL Email,
	C.CUST_PHONE1,
	C.CUST_PHONE2,
    C.CONTACT1_PHONE,
    C.CONTACT2_PHONE,
    C.BILL_ADDRESS1, 
    C.BILL_ADDRESS2, 
    C.BILL_ADDRESS3, 
    C.BILL_ADDRESS4,
    C.BILL_CITY,
	listagg(DISPLAY_VALUE, ', ') offer_list,
	listagg(ACTIVE_DT, ', ') offer_Install_dates
FROM 
	(
	SELECT
	DISTINCT 
	--DATESTART,
	ACCOUNTNUMBER,
	BID,
	LINE_OF_SERVICE,
	SUBLINE_OF_SERVICE,
	SUBLINE_OF_SERVICE_SEGMENT,
	PRODUCT_NAME,
	CUSTOMER_TYPE_NAME,
	DISPLAY_VALUE,
	ins.ACTIVE_DT,
	SUM(BEGINNING_ACTIVE + NET_ACTIVATIONS) AS ENDING_ACTIVE
	FROM
	ATNI_PROD.ATNI_ANALYTICS.SV_SUBSCRIBER_BG_END_WEEKLY_MONTHLY_SNAPSHOT_DAILYACTIVITY A
	LEFT JOIN 
		ATNI_PROD.GTT_REPORTING.OFFER_INST ins 
		ON A.ACCOUNTNUMBER = ins.ACCOUNT_NO AND ins.OFFER_ID IN (11467,11468,11469,11470,11425,11166,11167,11186,10820,10824,10823,11471) AND ins.INACTIVE_DT IS null
	left JOIN
		ATNI_PROD.GTT_REPORTING.OFFER_VALUES O ON INS.OFFER_ID=O.OFFER_ID AND RESELLER_VERSION_ID IN(SELECT MAX(RESELLER_VERSION_ID) FROM ATNI_PROD.GTT_REPORTING.OFFER_VALUES)
	WHERE
	OPERATING_COMPANY_CODE=1 --GTT
	AND DATE_TRUNC ('MONTH', DATESTART) = DATE_TRUNC ('MONTH', CURRENT_DATE())
	AND DATASET_TYPE IN ('BG_MONTHLY_SNAPSHOT', 'DAILY_SUB_ACTIVITY')
	AND SUBLINE_OF_SERVICE_SEGMENT='GPON'
	AND UNIT_COUNTABLE=1
	AND REVENUE_COUNTABLE=1
	AND IS_CURRENTLY_IN_DB = 'Y'
	GROUP BY 1,2,3,4,5,6,7,8,9
) X
LEFT JOIN GTT_REPORTING.CMF_EXTRACT C
	ON X.ACCOUNTNUMBER = C.ACCOUNT_NO  AND date(c.EXTRACT_FILE_DATE) = current_date 	
WHERE ENDING_ACTIVE > 0
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20