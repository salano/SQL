SELECT 
	sub.*,
	O.DISPLAY_VALUE SO_DESCRIPTION,
	SRV.DISPLAY_VALUE AS DISCONNECTION_TYPE,
	ins.disconnect_reason,
	DRV.DISPLAY_VALUE DISCONNECTION_REASON
FROM

	(
	SELECT
			distinct
			a.DATESTART ,
			ifNULL(b.DATEOUT, a.DATESTART) AS DEACT_DATE,
			a.ACCOUNTNUMBER,
			a.BID,
			a.FIRSTNAME,
			a.LASTNAME,
			a.COMPANYNAME,
			a.PRODUCT_NAME,
			abs(a.DEACTIVATIONS) DEACTIVATIONS
			FROM
			ATNI_PROD.ATNI_ANALYTICS.SUBSCRIBER_BG_END_WEEKLY_MONTHLY_SNAPSHOT_DAILYACTIVITY a 
			 LEFT JOIN ATNI_PROD.SC_INPUT.ODSSUBSCRIBERSNAPSHOT b 
			 	ON a.DATESTART = b.DATESTART AND a.ACCOUNTNUMBER = b.ACCOUNTNUMBER  AND a.BID = b.BID AND b.SOURCESYSTEMID=1
			WHERE
			a.DATASET_TYPE='DAILY_SUB_ACTIVITY'
			--AND a.SYSTEMID=24
			AND a.OFFICIALLY_COUNTED_SUBSCRIBER='yes'
			AND a.DEACTIVATIONS<>0
			AND a.DATESTART >= '2021-10-31'		
			
		)sub
				
	left join
		    (SELECT distinct offer_id, ACCOUNT_NO, SUBSCR_NO,disconnect_reason, INACTIVE_DT FROM  ATNI_PROD.GTT_REPORTING.OFFER_INST  WHERE
		    		offer_type =2 AND date(INACTIVE_DT) >= '2021-10-31'::date )   ins		    
		        on sub.ACCOUNTNUMBER = ins.ACCOUNT_NO and date(sub.DEACT_DATE) = date(ins.INACTIVE_DT) 
		        
	left JOIN
				ATNI_PROD.GTT_REPORTING.OFFER_VALUES O ON ins.OFFER_ID=O.OFFER_ID AND RESELLER_VERSION_ID IN(SELECT MAX(RESELLER_VERSION_ID) FROM ATNI_PROD.GTT_REPORTING.OFFER_VALUES)				
 	left join
		        (
		        	SELECT a.SUBSCR_NO,STATUS_REASON_ID , a.extract_file_date, a.INACTIVE_DT FROM   ATNI_PROD.GTT_REPORTING.SUBSCRIBER_STATUS_EXTRACT a
					JOIN  (SELECT SUBSCR_NO,  max(INACTIVE_DT) INACTIVE_DT FROM ATNI_PROD.GTT_REPORTING.SUBSCRIBER_STATUS_EXTRACT WHERE  date(INACTIVE_DT) >= to_date('2021-10-31','YYYY-MM-DD') AND date(extract_file_date) = date(current_date)  GROUP BY 1 ) b 
					ON a.SUBSCR_NO = b.SUBSCR_NO AND a.INACTIVE_DT = b.INACTIVE_DT 
					
					WHERE  date(a.extract_file_date) = date(current_date)
		        )  s
		          
		        on ins.SUBSCR_NO = s.SUBSCR_NO and date(s.INACTIVE_DT) = date(ins.INACTIVE_DT)  
	left join ATNI_PROD.GTT_REPORTING.DISCONNECT_REASON_VALUES DRV
		        on ins.disconnect_reason = DRV.disconnect_reason 
	left join ATNI_DEV.GTT_REPORTING.STATUS_REASON_VALUES SRV
	   		on s.STATUS_REASON_ID = srv.STATUS_REASON_ID