
SELECT 
	GPON.*,
	ll.BID LL_PHONE,
	ll.SUBLINE_OF_SERVICE_SEGMENT
	
FROM

		(
			SELECT
					--DATESTART,
					ACCOUNTNUMBER,
					BID,
					FIRSTNAME,
					LASTNAME,
					COMPANYNAME,
					LINE_OF_SERVICE,
					SUBLINE_OF_SERVICE,
					SUBLINE_OF_SERVICE_SEGMENT,
					PRODUCT_NAME,
					CUSTOMER_TYPE_NAME,
					SERVICEADDRESS1,
					SERVICEADDRESS2,
					SERVICEADDRESS3,
					SERVICEADDRESS4,
					CITY,
					C.CONTACT1_PHONE,
					C.CONTACT2_PHONE, 
					C.CUST_EMAIL, 
					SUM(BEGINNING_ACTIVE + NET_ACTIVATIONS) AS ENDING_ACTIVE
				FROM
					ATNI_PROD.ATNI_ANALYTICS.SV_SUBSCRIBER_BG_END_WEEKLY_MONTHLY_SNAPSHOT_DAILYACTIVITY SS
					LEFT JOIN GTT_REPORTING.CMF_EXTRACT C 
					ON SS.ACCOUNTNUMBER  = C.ACCOUNT_NO  AND date(C.EXTRACT_FILE_DATE) = date(current_date) 
				WHERE
					OPERATING_COMPANY_CODE=1 --GTT
					AND DATE_TRUNC ('MONTH', DATESTART) = DATE_TRUNC ('MONTH', CURRENT_DATE())
					AND DATASET_TYPE IN ('BG_MONTHLY_SNAPSHOT', 'DAILY_SUB_ACTIVITY')
					AND SUBLINE_OF_SERVICE_SEGMENT IN ('Regular Postpaid Landline Phone')
					--AND SUBLINE_OF_SERVICE_SEGMENT='GPON'
					--AND customer_type_name = 'Employee'
					AND UNIT_COUNTABLE=1
					AND REVENUE_COUNTABLE=1
					
					
					
					GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18
		) ll	

JOIN 


(
	SELECT
			--DATESTART,
			ACCOUNTNUMBER,
			BID,
			FIRSTNAME,
			LASTNAME,
			COMPANYNAME,
			LINE_OF_SERVICE,
			SUBLINE_OF_SERVICE,
			SUBLINE_OF_SERVICE_SEGMENT,
			PRODUCT_NAME,
			CUSTOMER_TYPE_NAME,
			SERVICEADDRESS1,
			SERVICEADDRESS2,
			SERVICEADDRESS3,
			SERVICEADDRESS4,
			CITY,
			C.CONTACT1_PHONE,
			C.CONTACT2_PHONE, 
			C.CUST_EMAIL, 
			OV.DISPLAY_VALUE ,
			round(RRC.RATE/100) AS RATE ,
			SUM(BEGINNING_ACTIVE + NET_ACTIVATIONS) AS ENDING_ACTIVE
		FROM
			ATNI_PROD.ATNI_ANALYTICS.SV_SUBSCRIBER_BG_END_WEEKLY_MONTHLY_SNAPSHOT_DAILYACTIVITY SS
			LEFT JOIN GTT_REPORTING.CMF_EXTRACT C 
					ON SS.ACCOUNTNUMBER  = C.ACCOUNT_NO  AND date(C.EXTRACT_FILE_DATE) = date(current_date) 
			LEFT JOIN ATNI_PROD.GTT_REPORTING.EXTERNAL_ID_EQUIP_MAP_EXTRACT eip on SS.ACCOUNTNUMBER = eip.ACCOUNT_NO AND date(eip.EXTRACT_FILE_DATE) = date(CURRENT_DATE())
			LEFT JOIN ATNI_PROD.GTT_REPORTING.OFFER_INST A ON A.SUBSCR_NO = eip.SUBSCR_NO
			JOIN ATNI_PROD.GTT_REPORTING.OFFER_VALUES OV ON A.OFFER_ID = OV.OFFER_ID AND OV.RESELLER_VERSION_ID IN (SELECT MAX(RESELLER_VERSION_ID) FROM ATNI_PROD.GTT_REPORTING.OFFER_VALUES)
  			LEFT JOIN ATNI_PROD.GTT_REPORTING.RATERC RRC ON A.OFFER_ID =  RRC.OFFER_ID AND RRC.RESELLER_VERSION_ID IN (SELECT MAX(RESELLER_VERSION_ID) FROM ATNI_PROD.GTT_REPORTING.RATERC)
		WHERE
			OPERATING_COMPANY_CODE=1 --GTT
			AND DATE_TRUNC ('MONTH', DATESTART) = DATE_TRUNC ('MONTH', CURRENT_DATE())
			AND DATASET_TYPE IN ('BG_MONTHLY_SNAPSHOT', 'DAILY_SUB_ACTIVITY')
			--AND SUBLINE_OF_SERVICE_SEGMENT IN ('Regular Postpaid Landline Phone')
			AND SUBLINE_OF_SERVICE_SEGMENT='GPON'
			--AND customer_type_name = 'Employee'
			AND UNIT_COUNTABLE=1
			AND REVENUE_COUNTABLE=1
			AND A.OFFER_TYPE = 3 -- PRIMARY OFFER
			AND A.ACCOUNT_NO <> 0
			AND round(RRC.RATE/100) > 5000
			AND A.SUBSCR_NO IN( 
							SELECT distinct SUBSCR_NO FROM  ATNI_PROD.GTT_REPORTING.OFFER_INST WHERE  offer_id IN (
										SELECT
										try_TO_NUMERIC(REPLACE(PRODUCTCODE,'MP',''))
										FROM
										ATNI_PROD.SC_OUTPUT.DIMPRODUCT
										WHERE
										LEAFLEVELNAME='Internet'
										AND SOURCESYSTEMID=1
										AND PRODUCTCODE LIKE 'MP%'
								) 
						 ) 
			GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20
) GPON 

ON ll.FIRSTNAME = GPON.FIRSTNAME AND ll.LASTNAME = GPON.LASTNAME AND ll.COMPANYNAME = GPON.COMPANYNAME
WHERE 
	ll.ENDING_ACTIVE > 0