SELECT 
	DISTINCT 
	IFF(GFO.CLOSED IS NULL, 'OPEN','CLOSED') TKT_STS
	,GFO."NUMBER" AS  TICKET_NUM
	,E.EXTERNAL_ID AS  PHONE_NUM
	,CASE WHEN E.EXTERNAL_ID_TYPE = 9 THEN 'Landline'
       WHEN E.EXTERNAL_ID_TYPE = 11 THEN 'DSL'
         WHEN E.EXTERNAL_ID_TYPE = 1 THEN 'Mobile'
         WHEN E.EXTERNAL_ID_TYPE = 27 THEN 'Leased Line'
       WHEN E.EXTERNAL_ID_TYPE in (37,39) THEN 'Blaze'
       ELSE 'Unknown'
  	END  SERV_CAT
	,GFO.OPENED AS DATE_REPORTED
	,GFO.CLOSED AS DATE_COMPLETED
	,GFO.RESOLVED 
	,GFO.SERVICE_PLAN
	,GFO.STATE
	,GFO.TRANSACTION_TYPE
	,GFO.TRANSACTION_SUB_TYPE
	,GFO.DESCRIPTION
	,GFO.DURATION
	,GFO.SUB_RESOLUTION_CODE
	,O.DISPLAY_VALUE AS Bandwidth
	,acv.DISPLAY_VALUE AS  Acc_category
	,GFO.ASSIGNED_TO AS TECHNICIAN_CONTRACTOR
	,GFO.ASSIGNMENT_GROUP

FROM 
	ATNI_PROD.GTT_REPORTING.GPON_FAULT_ORDERS GFO
LEFT JOIN ATNI_PROD.GTT_REPORTING.EXTERNAL_ID_EQUIP_MAP_EXTRACT E
	       ON try_TO_NUMERIC(GFO.ACCOUNT_NUMBER) = E.ACCOUNT_NO  AND date(E.EXTRACT_FILE_DATE) = date(CURRENT_DATE()) AND E.IS_CURRENT = 1
JOIN (SELECT distinct offer_id, ACCOUNT_NO, SUBSCR_NO,disconnect_reason, ACTIVE_DT FROM  ATNI_PROD.GTT_REPORTING.OFFER_INST WHERE  offer_id IN (
										SELECT
										try_TO_NUMERIC(REPLACE(PRODUCTCODE,'MP',''))
										FROM
										ATNI_PROD.SC_OUTPUT.DIMPRODUCT
										WHERE
										LEAFLEVELNAME='Internet'
										AND SOURCESYSTEMID=1
										AND PRODUCTCODE LIKE 'MP%'
									)  )   ins
						ON ins.ACCOUNT_NO = E.ACCOUNT_NO AND E.SUBSCR_NO = ins.SUBSCR_NO
JOIN
		ATNI_PROD.GTT_REPORTING.OFFER_VALUES O ON ins.OFFER_ID=O.OFFER_ID AND RESELLER_VERSION_ID IN(SELECT MAX(RESELLER_VERSION_ID) FROM ATNI_PROD.GTT_REPORTING.OFFER_VALUES)
LEFT JOIN ATNI_PROD.GTT_REPORTING.CMF_EXTRACT  C
	       ON try_TO_NUMERIC(GFO.ACCOUNT_NUMBER) = C.ACCOUNT_NO  AND date(C.EXTRACT_FILE_DATE) = date(CURRENT_DATE())
join 
		ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES acv on c.account_category = acv.account_category and acv.SERVICE_VERSION_ID = (select max(SERVICE_VERSION_ID) from ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES)	       
WHERE 
 E.EXTERNAL_ID_TYPE in (37,39)

 AND date(GFO.LOAD_DATE_TIME) = date(current_date);