
SELECT 
	sv.BILL_FNAME 
	,sv.BILL_LNAME
	,sv.BILL_COMPANY 
	,ACCOUNTNUMBER 
	,BID AS Phone_number
	,CUST_EMAIL Email
    ,c.statement_to_email
  	,CUST_PHONE1
  	,CUST_PHONE2
  	,c.CONTACT1_PHONE
  	,c.CONTACT2_PHONE
	,CUSTOMER_TYPE_NAME 
	, LINE_OF_SERVICE 
	, SUBLINE_OF_SERVICE
	,SUBLINE_OF_SERVICE_SEGMENT 
	,PRODUCT_NAME
	,TECHNOLOGY_NAME 
FROM 
	ATNI_DEV.GTT_REPORTING.SV_GTT_BUSINESS_SUBSCRIBERS sv
	JOIN ATNI_PROD.GTT_REPORTING.CMF_EXTRACT c 
		on sv.ACCOUNTNUMBER = c.ACCOUNT_NO AND date(c.EXTRACT_FILE_DATE) = date(CURRENT_DATE())
		
	LEFT JOIN
 		ATNI_PROD.GTT_REPORTING.tmp_DSL_blaze_area B 
 		ON sv.BID= b.PHONE
WHERE
	date(DATESTART) = add_months(last_day(current_date), -1)
	AND ENDING_ACTIVE = 1
	AND LEFT(BID,4) ='5922'
	AND LINE_OF_SERVICE = 'Voice'
	AND BID IN (

					SELECT 
						CONCAT('592',PHONE_NUMBER)
						--EXCHANGE -- GPON EXCHANGES
					FROM 
						ATNI_PROD.GTT_REPORTING.DSL_DUMPS_DNS_RAW 
					WHERE 
						date(dump_ts) = date(CURRENT_DATE())
					    AND (CONCAT('592',PHONE_NUMBER) IN 
					    (SELECT 
							PHONE 
						FROM 
							ATNI_PROD.GTT_REPORTING.tmp_DSL_blaze_area
						WHERE 
							"GPON AREA" ='Y'
							AND (upper(OFFER_DESCRIPT) LIKE '%CONSUMER%' OR upper(OFFER_DESCRIPT) LIKE '%EMPLOYEE%')
						)
					 or EXCHANGE in ('Amelia\'s Ward'))
							
			)