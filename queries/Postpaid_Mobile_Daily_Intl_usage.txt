--Postpaid Mobile Daily International usage
SELECT
	TO_CHAR(Detail.TRANS_DT,'mm/dd/yyyy') AS CALL_DT,
	TO_CHAR(Detail.TRANS_DT,'Dy') AS CALL_DAY,
	COUNT(DISTINCT CASE WHEN Detail.DESCRIPTION = 'International' THEN Detail.EXTERNAL_ID END) AS INT_SUBS,
	SUM(CASE WHEN Detail.DESCRIPTION = 'International' THEN Detail.CALL_COUNT ELSE 0 END) AS INT_CALLS,
	SUM(CASE WHEN Detail.DESCRIPTION = 'International' THEN Detail.PRIMARY_UNITS ELSE 0 END) / 60 AS INT_MINUTES,
	SUM(CASE WHEN Detail.DESCRIPTION = 'International' AND Detail.BALANCE_ID = 90 THEN Detail.PRIMARY_UNITS ELSE 0 END) / 60 AS INT_PLAN_MIN,
	SUM(CASE WHEN Detail.DESCRIPTION = 'International' AND Detail.BALANCE_ID = 101 THEN Detail.PRIMARY_UNITS ELSE 0 END) / 60 AS INT_CRLMT_MIN,
	SUM(CASE WHEN Detail.DESCRIPTION = 'International' AND Detail.BALANCE_ID NOT IN (90,101) THEN Detail.PRIMARY_UNITS ELSE 0 END) / 60 AS INT_OTHER_MIN,
	SUM(CASE WHEN Detail.DESCRIPTION = 'International' AND Detail.UNIT_TYPE = 1 AND Detail.TOTAL_TAX != 0 THEN Detail.AMOUNT ELSE 0 END) AS INT_AMOUNT,
	SUM(CASE WHEN Detail.DESCRIPTION = 'International' AND Detail.UNIT_TYPE = 1 AND Detail.TOTAL_TAX != 0 AND Detail.BALANCE_ID = 101 THEN Detail.AMOUNT ELSE 0 END) AS INT_CRLMT,
	SUM(CASE WHEN Detail.DESCRIPTION = 'International' AND Detail.UNIT_TYPE = 1 AND Detail.TOTAL_TAX != 0 AND Detail.BALANCE_ID != 101 THEN Detail.AMOUNT ELSE 0 END) AS INT_OTHER,
	--Roaming	
	COUNT(DISTINCT CASE WHEN Detail.DESCRIPTION = 'Roaming' THEN Detail.EXTERNAL_ID END) AS ROAM_SUBS,
	SUM(CASE WHEN Detail.DESCRIPTION = 'Roaming' THEN Detail.CALL_COUNT ELSE 0 END) AS ROAM_CALLS,
	SUM(CASE WHEN Detail.DESCRIPTION = 'Roaming' AND Detail.EXTERNAL_ID = Detail.POINT_TARGET THEN Detail.PRIMARY_UNITS ELSE 0 END) / 60 AS ROAM_INMIN,
	SUM(CASE WHEN Detail.DESCRIPTION = 'Roaming' AND Detail.EXTERNAL_ID = Detail.POINT_ORIGIN THEN Detail.PRIMARY_UNITS ELSE 0 END) / 60 AS ROAM_OUTMIN,
	SUM(CASE WHEN Detail.DESCRIPTION = 'Roaming' THEN Detail.PRIMARY_UNITS ELSE 0 END) / 60 AS ROAM_TOTMIN,
	SUM(CASE WHEN Detail.DESCRIPTION = 'Roaming' AND Detail.BALANCE_ID = 90 THEN Detail.PRIMARY_UNITS ELSE 0 END) / 60 AS ROAM_PLAN_MIN,
	SUM(CASE WHEN Detail.DESCRIPTION = 'Roaming' AND Detail.BALANCE_ID = 101 THEN Detail.PRIMARY_UNITS ELSE 0 END) / 60 AS ROAM_CRLMT_MIN,
	SUM(CASE WHEN Detail.DESCRIPTION = 'Roaming' AND Detail.BALANCE_ID NOT IN (90,101) THEN Detail.PRIMARY_UNITS ELSE 0 END) / 60 AS ROAM_OTHER_MIN,
	SUM(CASE WHEN Detail.DESCRIPTION = 'Roaming' AND Detail.UNIT_TYPE = 1 AND Detail.EXTERNAL_ID = Detail.POINT_TARGET THEN Detail.AMOUNT ELSE 0 END) AS ROAM_INAMT,
	SUM(CASE WHEN Detail.DESCRIPTION = 'Roaming' AND Detail.UNIT_TYPE = 1 AND Detail.EXTERNAL_ID = Detail.POINT_ORIGIN THEN Detail.AMOUNT ELSE 0 END) AS ROAM_OUTAMT,
	SUM(CASE WHEN Detail.DESCRIPTION = 'Roaming' AND Detail.UNIT_TYPE = 1 THEN Detail.AMOUNT ELSE 0 END) AS ROAM_TOTAMT,
	SUM(CASE WHEN Detail.DESCRIPTION = 'Roaming' AND Detail.UNIT_TYPE = 1 AND Detail.AMOUNT != 0 AND Detail.BALANCE_ID = 101 THEN Detail.AMOUNT ELSE 0 END) AS ROAM_CRLMT,
	SUM(CASE WHEN Detail.DESCRIPTION = 'Roaming' AND Detail.UNIT_TYPE = 1 AND Detail.AMOUNT != 0 AND Detail.BALANCE_ID != 101 THEN Detail.AMOUNT ELSE 0 END) AS ROAM_OTHER
FROM (
	SELECT 
		CASE WHEN AGM.AUT_GROUP_ID = 18 THEN 'International'
			WHEN AGM.AUT_GROUP_ID = 40 THEN 'Roaming'
			ELSE 'Unknown' END AS DESCRIPTION,
		AGM.AUT_GROUP_ID,
		CASE WHEN CD.BALANCE_ID = 89 THEN 'Core' 
			WHEN CD.BALANCE_ID = 101 THEN 'CrLimit'
			WHEN CD.BALANCE_ID NOT IN (89,101) AND BF.UNIT_TYPE = 1 THEN 'Promo' 
			WHEN CD.BALANCE_ID NOT IN (89,101) AND BF.UNIT_TYPE = 2 THEN 'Free Seconds' 
			WHEN CD.BALANCE_ID NOT IN (89,101) AND BF.UNIT_TYPE = 3 THEN 'Octet' 
			WHEN CD.BALANCE_ID NOT IN (89,101) AND BF.UNIT_TYPE = 4 THEN 'SMS' 
			WHEN CD.BALANCE_ID NOT IN (89,101) AND BF.UNIT_TYPE = 5001 THEN 'Quantity' 
			ELSE 'Unknown' END AS BALANCE_TYPE,
		'C' AS TABLE_ID,
		CD.MSG_ID,
		CD.MSG_ID2,
		CD.TRANS_DT,
		1 AS CALL_COUNT,
		CD.EXTERNAL_ID,
		CD.POINT_ORIGIN,
		CD.POINT_TARGET,
		CD.BALANCE_ID,
		BF.UNIT_TYPE,
		CD.AUT_ID,
		AV.DISPLAY_VALUE,
		CD.PRIMARY_UNITS,
		NVL(AMOUNT_POSTPAID,0) / 100 AS AMOUNT,
		NVL(TOTAL_TAX_POSTPAID,0) / 100 AS TOTAL_TAX,
		NVL(CD.CHARGED_AMOUNT_POSTPAID,0) / 100 AS CHARGED_AMOUNT
		FROM CDR_DATA CD
			JOIN AUT_FINAL_VALUES AV
			ON CD.AUT_ID = AV.AUT_ID AND AV.RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM AUT_FINAL_VALUES)
			LEFT JOIN BALANCE_REF BF
			ON CD.BALANCE_ID = BF.BALANCE_ID AND BF.RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM BALANCE_REF)
			JOIN AUT_GROUP_MAP AGM
			ON AGM.AUT_ID = CD.AUT_ID
			AND AGM.RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM AUT_GROUP_MAP)
		WHERE CD.APPLICATION_ID = 1 AND CD.PRIMARY_UNITS > 0 AND NVL(CD.PAYMENT_MODE,0) != 1
		AND CD.EXTERNAL_ID_TYPE = 1 AND NVL(CD.AMOUNT,0) > 0 AND CD.BALANCE_ID IS NOT NULL
		AND (CD.EXTERNAL_ID IN (CD.POINT_ORIGIN,CD.POINT_TARGET))
		AND AGM.AUT_GROUP_ID IN (18,40)
		AND DATE(CD.TRANS_DT) BETWEEN ADD_MONTHS(CURRENT_DATE - DAY(CURRENT_DATE),-1) + 1 AND CURRENT_DATE - DAY(CURRENT_DATE)
		--AND DATE(trans_dt) BETWEEN ${start_dt} AND ${end_dt}
	UNION ALL
	SELECT 
		CASE WHEN AGM.AUT_GROUP_ID = 18 THEN 'International'
			WHEN AGM.AUT_GROUP_ID = 40 THEN 'Roaming'
			ELSE 'Unknown' END AS DESCRIPTION,
		--CASE WHEN upper(AV.DISPLAY_VALUE) LIKE '%ROAM%' THEN 'Roaming'
		--	WHEN ((C2.AUT_ID BETWEEN 1646 AND 1797) OR (C2.AUT_ID BETWEEN 1810 AND 1905) OR (C2.AUT_ID BETWEEN 4680 AND 4681) OR C2.AUT_ID IN (4959,5028,5043,5047,5068)) THEN 'International'
		--	ELSE 'Unknown' END AS DESCRIPTION,
		AGM.AUT_GROUP_ID,
		CASE WHEN CB.BALANCE_ID = 89 THEN 'Core' 
			WHEN CB.BALANCE_ID = 101 THEN 'CrLimit'
			WHEN CB.BALANCE_ID NOT IN (89,101) AND CB.UNIT_TYPE = 1 THEN 'Promo' 
			WHEN CB.BALANCE_ID NOT IN (89,101) AND CB.UNIT_TYPE = 2 THEN 'Free Seconds' 
			WHEN CB.BALANCE_ID NOT IN (89,101) AND CB.UNIT_TYPE = 3 THEN 'Octet' 
			WHEN CB.BALANCE_ID NOT IN (89,101) AND CB.UNIT_TYPE = 4 THEN 'SMS' 
			WHEN CB.BALANCE_ID NOT IN (89,101) AND CB.UNIT_TYPE = 5001 THEN 'Quantity' 
			ELSE 'Unknown' END AS BALANCE_TYPE,
		'B' AS TABLE_ID,
		CB.MSG_ID,
		CB.MSG_ID2,
		C2.TRANS_DT,
		CASE WHEN CB.BALANCE_COUNTER = 1 THEN 1 ELSE 0 END AS CALL_COUNT,
		C2.EXTERNAL_ID,
		C2.POINT_ORIGIN,
		C2.POINT_TARGET,
		CB.BALANCE_ID,
		CB.UNIT_TYPE,
		C2.AUT_ID,
		AV.DISPLAY_VALUE,
		CASE WHEN CB.UNIT_TYPE = 2 THEN CB.UNITS ELSE C2.PRIMARY_UNITS - CB2.UNITS END AS PRIMARY_UNITS,
		CASE WHEN NVL(C2.TOTAL_TAX_PREPAID,0) > 0 THEN (CASE WHEN C2.REFUND_FLAG != 'Y' THEN (CASE WHEN CB.UNIT_TYPE = 1 THEN CB.BALANCE_AMOUNT / 1.14 
		ELSE 0 END) ELSE (0 - CB.BALANCE_AMOUNT) / 1.14 END) ELSE (CASE WHEN C2.REFUND_FLAG != 'Y' THEN CB.BALANCE_AMOUNT ELSE 0 - CB.BALANCE_AMOUNT 
		END) END / 100 AS AMOUNT,
		NVL(C2.TOTAL_TAX_POSTPAID,0) / 100 AS TOTAL_TAX,
		CASE WHEN NVL(CB.BALANCE_AMOUNT,0) > 0 THEN (CASE WHEN C2.REFUND_FLAG != 'Y' THEN (CASE WHEN CB.UNIT_TYPE = 1 THEN CB.BALANCE_AMOUNT ELSE 0 
		END) ELSE 0 - CB.BALANCE_AMOUNT END) END /100 AS CHARGED_AMOUNT
		FROM CDR_DATA C2
			JOIN CDR_BALANCE CB
			ON C2.MSG_ID = CB.MSG_ID AND C2.MSG_ID2 = CB.MSG_ID2
			JOIN AUT_FINAL_VALUES AV
			ON C2.AUT_ID = AV.AUT_ID AND AV.RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM AUT_FINAL_VALUES)
			JOIN CDR_BALANCE CB2
			ON CB.MSG_ID = CB2.MSG_ID AND CB.MSG_ID2 = CB2.MSG_ID2 AND CB2.UNIT_TYPE = 2
			JOIN AUT_GROUP_MAP AGM
			ON AGM.AUT_ID = C2.AUT_ID
			AND AGM.RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM AUT_GROUP_MAP)
		WHERE C2.APPLICATION_ID = 1 AND C2.BALANCE_ID IS NULL AND NVL(CB.PAYMENT_MODE,0) != 1
		AND C2.EXTERNAL_ID_TYPE = 1 AND C2.PRIMARY_UNITS > 0 AND NVL(C2.AMOUNT,0) > 0
		AND (C2.EXTERNAL_ID IN (C2.POINT_ORIGIN,C2.POINT_TARGET))
		AND AGM.AUT_GROUP_ID IN (18,40)
		AND DATE(C2.TRANS_DT) BETWEEN ADD_MONTHS(CURRENT_DATE - DAY(CURRENT_DATE),-1) + 1 AND CURRENT_DATE - DAY(CURRENT_DATE)
		--AND DATE(C2.TRANS_DT) BETWEEN ${start_dt} AND ${end_dt}
		) Detail
GROUP BY 1,2
ORDER BY 1,2;
