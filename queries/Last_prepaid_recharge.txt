SELECT
	RH.ACCOUNT_NO,
	EIEM.EXTERNAL_ID,
	max(RH.RECHARGE_DATE_TIME) OVER 
	  			(PARTITION BY RH.ACCOUNT_NO,EIEM.EXTERNAL_ID ORDER BY RH.RECHARGE_DATE_TIME 
	  			RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
	  			) AS Last_recharge_date
FROM RECHARGE_HISTORY RH
	JOIN RECHARGE_HISTORY_BALANCE RHB
	ON RH.RECHARGE_ID = RHB.RECHARGE_ID AND RH.RECHARGE_ID2 = RHB.RECHARGE_ID2
	LEFT JOIN (
		SELECT DISTINCT 
			SUBSCR_NO, EXTERNAL_ID
		FROM EXTERNAL_ID_EQUIP_MAP
		WHERE DATE(EFFECTIVE_DT)-1 <= date(current_date) AND DATE(EXPIRY_DT)-1 > date(current_date)
		AND EXTERNAL_ID_TYPE = 1 AND IS_CURRENT = 1) EIEM
	ON RH.SUBSCR_NO = EIEM.SUBSCR_NO
WHERE DATE(RH.RECHARGE_DATE_TIME) >= ADD_MONTHS(current_date, -6)
AND substring(nvl(RH.RECHARGE_COMMMENT,' '),1,8) != 'inswitch' AND nvl(RHB.AMOUNT,0) < 0
AND substring(EIEM.EXTERNAL_ID,1,4) = '5926'
AND RHB.BALANCE_ID = 89 AND RHB.PAYMENT_MODE = 1