SELECT 
	sub.*,
	 EN.EXCHANGE
FROM 
	(
	SELECT
		DATESTART,
		ACCOUNTNUMBER,
		BID,
		FIRSTNAME,
		LASTNAME,
		COMPANYNAME,
		LINE_OF_SERVICE,
		SUBLINE_OF_SERVICE,
		SUBLINE_OF_SERVICE_SEGMENT,
		PRODUCT_NAME,
		CUSTOMER_TYPE_NAME,
		SERVICEADDRESS1,
		SERVICEADDRESS2,
		SERVICEADDRESS3,
		SERVICEADDRESS4,
		CITY,
		C.CONTACT1_PHONE,
		C.CONTACT2_PHONE, 
		C.CUST_EMAIL, 
		SUM(BEGINNING_ACTIVE + NET_ACTIVATIONS) AS ENDING_ACTIVE
	FROM
		ATNI_PROD.ATNI_ANALYTICS.SV_SUBSCRIBER_BG_END_WEEKLY_MONTHLY_SNAPSHOT_DAILYACTIVITY SS
		LEFT JOIN GTT_REPORTING.CMF_EXTRACT C 
					ON SS.ACCOUNTNUMBER  = C.ACCOUNT_NO  AND date(C.EXTRACT_FILE_DATE) = date(current_date) 
	WHERE
		OPERATING_COMPANY_CODE=1 --GTT
		AND DATE_TRUNC ('MONTH', DATESTART) = DATE_TRUNC ('MONTH', CURRENT_DATE())
		AND DATASET_TYPE IN ('BG_MONTHLY_SNAPSHOT', 'DAILY_SUB_ACTIVITY')
		AND SUBLINE_OF_SERVICE_SEGMENT='Regular Postpaid Landline Phone'
		AND customer_type_name = 'Employee'
		AND UNIT_COUNTABLE=1
		AND REVENUE_COUNTABLE=1
		GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19
) SUB
LEFT JOIN ATNI_DEV.GTT_REPORTING.EXCHANGE_NAMES EN
	ON SUBSTRING(SUB.BID, 4, 3) = EN.prefix AND SUBSTRING(SUB.BID, 7, 1) >= EN.LOWER_RANGE AND SUBSTRING(SUB.BID, 7, 1) <= EN.UPPER_RANGE
WHERE ENDING_ACTIVE > 0
AND (EN.EXCHANGE IN (
	
				SELECT 
					EXCHANGE -- GPON EXCHANGES
				FROM 
					ATNI_PROD.GTT_REPORTING.DSL_DUMPS_DNS_RAW 
				WHERE 
					date(dump_ts) = date(CURRENT_DATE())
				    AND CONCAT('592',PHONE_NUMBER) IN 
				    (SELECT 
						PHONE 
					FROM 
						ATNI_PROD.GTT_REPORTING.tmp_DSL_blaze_area
					WHERE 
						"GPON AREA" ='Y'
						--AND (upper(OFFER_DESCRIPT) LIKE '%CONSUMER%' OR upper(OFFER_DESCRIPT) LIKE '%EMPLOYEE%')
					)
						
	)
	
OR EN.EXCHANGE in ('Amelia''s Ward','V/Hoop (Poudroyen)','Non Pariel (ECD)','New Amsterdam'))