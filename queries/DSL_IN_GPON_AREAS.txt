SELECT 
	A.CCT_ID,
	A.PHONE_NUMBER,
	EIP.ACCOUNT_NO,
	,acv.DISPLAY_VALUE cust_type
	A.FULL_NAME,
	A.SERVICE_NAME,
	A.STATUS,
	A.EXCHANGE,
	A.DSL_START_TS,
	B.*
FROM 
 ATNI_PROD.GTT_REPORTING.DSL_DUMPS_DNS_RAW A
 LEFT JOIN
 	ATNI_PROD.GTT_REPORTING.tmp_DSL_blaze_area B 
 	ON CONCAT('592',A.PHONE_NUMBER)= b.PHONE
  JOIN ATNI_PROD.GTT_REPORTING.EXTERNAL_ID_EQUIP_MAP_EXTRACT eip on CONCAT('592',A.PHONE_NUMBER) = eip.EXTERNAL_ID AND date(eip.EXTRACT_FILE_DATE) = date(CURRENT_DATE())
					AND EIP.IS_CURRENT = 1
  JOIN ATNI_PROD.GTT_REPORTING.CMF_EXTRACT c
						   ON EIP.ACCOUNT_NO = C.ACCOUNT_NO AND date(c.EXTRACT_FILE_DATE) = date(current_date)
						   join ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES acv on c.account_category = acv.account_category and acv.SERVICE_VERSION_ID = (select max(SERVICE_VERSION_ID) from ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES)
WHERE 
 	(EXCHANGE IN (

			SELECT 
				EXCHANGE -- GPON EXCHANGES
			FROM 
				ATNI_PROD.GTT_REPORTING.DSL_DUMPS_DNS_RAW 
			WHERE 
				date(dump_ts) = date(CURRENT_DATE())
			    AND CONCAT('592',PHONE_NUMBER) IN 
			    (SELECT 
					PHONE 
				FROM 
					ATNI_PROD.GTT_REPORTING.tmp_DSL_blaze_area
				WHERE 
					"GPON AREA" ='Y')
					
) OR A.EXCHANGE in ('Amelia''s Ward','V/Hoop (Poudroyen)','Non Pariel (ECD)','New Amsterdam','Mahaica','Enterprise (ECD)'))
AND date(A.dump_ts) = date(CURRENT_DATE())
--AND upper(A.SERVICE_NAME) LIKE '%BUS%'
AND Eip.EXTERNAL_ID_TYPE IN (11)
ORDER BY 
	EXCHANGE