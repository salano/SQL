--Postpaid Mobile SMS Usage
SELECT
	TO_CHAR(Detail.TRANS_DT,'mm/dd/yyyy') AS CALL_DT,
	TO_CHAR(Detail.TRANS_DT,'Dy') AS CALL_DAY,
	COUNT(DISTINCT CASE WHEN Detail.REFUND_FLAG = 'N' THEN Detail.EXTERNAL_ID END) AS SUBS,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' THEN TEXT_COUNT ELSE 0 END) AS TEXTS,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.BALANCE_ID IN (89,101) THEN (Detail.AMOUNT) ELSE 0 END) / 100 AS AMOUNT,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.BALANCE_ID NOT IN (89,101) AND Detail.BALANCE_TYPE = 'Promo' THEN Detail.AMOUNT ELSE 0 END) / 100 AS TOTAL_PROMO,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.BALANCE_ID NOT IN (89,101) AND Detail.BALANCE_TYPE = 'SMS' THEN Detail.PRIMARY_UNITS ELSE 0 END) AS TOTAL_SMS,
	COUNT(DISTINCT CASE WHEN Detail.REFUND_FLAG = 'Y' THEN Detail.EXTERNAL_ID END) AS REFUND_SUBS,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'Y' THEN TEXT_COUNT ELSE 0 END) AS REFUND_TEXTS,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'Y' AND Detail.BALANCE_ID IN (89,101) THEN Detail.AMOUNT ELSE 0 END) / 100 AS REFUND_AMT,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'Y' AND Detail.BALANCE_ID NOT IN (89,101) AND Detail.BALANCE_TYPE = 'Promo' THEN Detail.AMOUNT ELSE 0 END) / 100 AS REFUND_PROMO,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'Y' AND Detail.BALANCE_ID NOT IN (89,101) AND Detail.BALANCE_TYPE = 'SMS' THEN Detail.PRIMARY_UNITS ELSE 0 END) AS REFUND_SMS,
	COUNT(DISTINCT CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'OnNet' THEN Detail.EXTERNAL_ID END) AS ONNET_SUBS,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'OnNet' THEN TEXT_COUNT ELSE 0 END) AS ONNET_TEXTS,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'OnNet' AND Detail.BALANCE_ID IN (89,101) THEN Detail.AMOUNT ELSE 0 END) / 100 AS ONNET_AMT,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'OnNet' AND Detail.BALANCE_ID NOT IN (89,101) AND Detail.BALANCE_TYPE = 'Promo' THEN Detail.AMOUNT ELSE 0 END) / 100 AS ONNET_PROMO,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'OnNet' AND Detail.BALANCE_ID NOT IN (89,101) AND Detail.BALANCE_TYPE = 'SMS' THEN Detail.PRIMARY_UNITS ELSE 0 END) AS ONNET_SMS,
	COUNT(DISTINCT CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'OffNet Digicel' THEN Detail.EXTERNAL_ID END) AS OFFNET_SUBS,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'OffNet Digicel' THEN TEXT_COUNT ELSE 0 END) AS OFFNET_TEXTS,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'OffNet Digicel' AND Detail.BALANCE_ID IN (89,101) THEN Detail.AMOUNT ELSE 0 END) / 100 AS OFFNET_AMT,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'OffNet Digicel' AND Detail.BALANCE_ID NOT IN (89,101) AND Detail.BALANCE_TYPE = 'Promo' THEN Detail.AMOUNT ELSE 0 END) / 100 AS OFFNET_PROMO,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'OffNet Digicel' AND Detail.BALANCE_ID NOT IN (89,101) AND Detail.BALANCE_TYPE = 'SMS' THEN Detail.PRIMARY_UNITS ELSE 0 END) AS OFFNET_SMS,
	COUNT(DISTINCT CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'International' THEN Detail.EXTERNAL_ID END) AS INTL_SUBS,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'International' THEN TEXT_COUNT ELSE 0 END) AS INTL_TEXTS,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'International' AND Detail.BALANCE_ID IN (89,101) THEN Detail.AMOUNT ELSE 0 END) / 100 AS INTL_AMT,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'International' AND Detail.BALANCE_ID NOT IN (89,101) AND Detail.BALANCE_TYPE = 'Promo' THEN Detail.AMOUNT ELSE 0 END) / 100 AS INTL_PROMO,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'International' AND Detail.BALANCE_ID NOT IN (89,101) AND Detail.BALANCE_TYPE = 'SMS' THEN Detail.PRIMARY_UNITS ELSE 0 END) AS INTL_SMS,
	COUNT(DISTINCT CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'SMPP Text' THEN Detail.EXTERNAL_ID END) AS SMPP_SUBS,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'SMPP Text' THEN TEXT_COUNT ELSE 0 END) AS SMPP_TEXTS,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'SMPP Text' AND Detail.BALANCE_ID IN (89,101) THEN Detail.AMOUNT ELSE 0 END) / 100 AS SMPP_AMT,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'SMPP Text' AND Detail.BALANCE_ID NOT IN (89,101) AND Detail.BALANCE_TYPE = 'Promo' THEN Detail.AMOUNT ELSE 0 END) / 100 AS SMPP_PROMO,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'SMPP Text' AND Detail.BALANCE_ID NOT IN (89,101) AND Detail.BALANCE_TYPE = 'SMS' THEN Detail.PRIMARY_UNITS ELSE 0 END) AS SMPP_SMS,
	COUNT(DISTINCT CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'Scripture' THEN Detail.EXTERNAL_ID END) AS RLG_SUBS,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'Scripture' THEN TEXT_COUNT ELSE 0 END) AS RLG_TEXTS,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'Scripture' AND Detail.BALANCE_ID IN (89,101) THEN Detail.AMOUNT ELSE 0 END) / 100 AS RLG_AMT,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'Scripture' AND Detail.BALANCE_ID NOT IN (89,101) AND Detail.BALANCE_TYPE = 'Promo' THEN Detail.AMOUNT ELSE 0 END) / 100 AS RLG_PROMO,
	SUM(CASE WHEN Detail.REFUND_FLAG = 'N' AND Detail.DESCRIPTION = 'Scripture' AND Detail.BALANCE_ID NOT IN (89,101) AND Detail.BALANCE_TYPE = 'SMS' THEN Detail.PRIMARY_UNITS ELSE 0 END) AS RLG_SMS
FROM
		(SELECT 
		CD.MSG_ID,
		CD.MSG_ID2,
		CASE WHEN CD.REFUND_FLAG = 'Y' THEN 'Refund'
			WHEN AV.DISPLAY_VALUE = 'SMS_OnNet' THEN 'OnNet'
			WHEN AV.DISPLAY_VALUE = 'SMS_OffNet' THEN 'OffNet Digicel'
			WHEN AV.DISPLAY_VALUE LIKE 'SMS_Int%' THEN 'International' 
			WHEN (upper(AV.DISPLAY_VALUE) LIKE '%SMPP%' OR upper(AV.DISPLAY_VALUE) LIKE '%IM2GO%') AND CD.POINT_ORIGIN != '6209673' THEN 'SMPP Text'
			WHEN upper(AV.DISPLAY_VALUE) LIKE '%SMPP%' AND CD.POINT_ORIGIN = '6209673' THEN 'Scripture' 
			ELSE 'Unknown' END AS DESCRIPTION,
		CASE WHEN CD.BALANCE_ID = 89 THEN 'Core' 
			WHEN CD.BALANCE_ID = 101 THEN 'CrLimit'
			WHEN CD.BALANCE_ID NOT IN (89,101) AND BF.UNIT_TYPE = 1 THEN 'Promo' 
			WHEN CD.BALANCE_ID NOT IN (89,101) AND BF.UNIT_TYPE = 2 THEN 'Free Seconds' 
			WHEN CD.BALANCE_ID NOT IN (89,101) AND BF.UNIT_TYPE = 3 THEN 'Octet' 
			WHEN CD.BALANCE_ID NOT IN (89,101) AND BF.UNIT_TYPE = 4 THEN 'SMS' 
			WHEN CD.BALANCE_ID NOT IN (89,101) AND BF.UNIT_TYPE = 5 THEN 'MMS' 
			WHEN CD.BALANCE_ID NOT IN (89,101) AND BF.UNIT_TYPE = 5001 THEN 'Quantity' 
			ELSE 'Unknown' END AS BALANCE_TYPE,
		'C' AS TABLE_ID,
		CD.TRANS_DT,
		1 AS TEXT_COUNT,
		CD.EXTERNAL_ID,
		CD.POINT_ORIGIN,
		CD.POINT_TARGET,
		CD.REFUND_FLAG,
		CD.BALANCE_ID,
		CD.BALANCE_COUNT,
		BF.UNIT_TYPE,
		CD.AUT_ID,
		CD.APPLICATION_ID,
		AV.DISPLAY_VALUE,
		CD.PRIMARY_UNITS,
		NVL(AMOUNT,0) AS AMOUNT,
		NVL(CD.CHARGED_AMOUNT,0) AS CHARGED_AMOUNT,
		CD.DISCOUNT_OFFER_ID,
		CD.PAYMENT_MODE,
		CD.TARIFF_PLAN_OFFER_ID
	FROM CDR_DATA CD
		JOIN AUT_FINAL_VALUES AV
		ON CD.AUT_ID = AV.AUT_ID AND AV.RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM AUT_FINAL_VALUES)
		LEFT JOIN BALANCE_REF BF
		ON CD.BALANCE_ID = BF.BALANCE_ID AND BF.RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM BALANCE_REF)
	WHERE CD.APPLICATION_ID = 2 AND CD.BALANCE_ID IS NOT NULL
	AND CD.TARIFF_PLAN_OFFER_ID in (SELECT OFFER_ID FROM OFFER_REF
	WHERE SERVICE_CATEGORY_ID = 4 AND PAYMENT_MODE != 1
	AND RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM OFFER_REF))
	AND CD.EXTERNAL_ID_TYPE = 1 AND ((CD.EXTERNAL_ID = CD.POINT_ORIGIN) OR (CD.EXTERNAL_ID = CD.POINT_TARGET AND NVL(CD.CHARGED_AMOUNT,0) != 0))
	AND CD.COMP_STATUS IN (16,400) AND NVL(CD.REFUND_FLAG,' ') != 'P'
	AND DATE(trans_dt) BETWEEN ADD_MONTHS(CURRENT_DATE - DAY(CURRENT_DATE),-1) + 1 AND CURRENT_DATE - DAY(CURRENT_DATE)
	UNION ALL
	SELECT 
		C2.MSG_ID,
		C2.MSG_ID2,
		CASE WHEN C2.REFUND_FLAG = 'Y' THEN 'Refund'
			WHEN AV.DISPLAY_VALUE = 'SMS_OnNet' THEN 'OnNet'
			WHEN AV.DISPLAY_VALUE = 'SMS_OffNet' THEN 'OffNet Digicel'
			WHEN AV.DISPLAY_VALUE LIKE 'SMS_Int%' THEN 'International' 
			WHEN (upper(AV.DISPLAY_VALUE) LIKE '%SMPP%' OR upper(AV.DISPLAY_VALUE) LIKE '%IM2GO%') AND C2.POINT_ORIGIN != '6209673' THEN 'SMPP Text'
			WHEN upper(AV.DISPLAY_VALUE) LIKE '%SMPP%' AND C2.POINT_ORIGIN = '6209673' THEN 'Scripture' 
			ELSE 'Unknown' END AS DESCRIPTION,
		CASE WHEN CB.BALANCE_ID = 89 THEN 'Core'
			WHEN CB.BALANCE_ID = 101 THEN 'CrLimit'
			WHEN CB.BALANCE_ID NOT IN (89,101) AND CB.UNIT_TYPE = 1 THEN 'Promo' 
			WHEN CB.BALANCE_ID NOT IN (89,101) AND CB.UNIT_TYPE = 2 THEN 'Free Seconds' 
			WHEN CB.BALANCE_ID NOT IN (89,101) AND CB.UNIT_TYPE = 3 THEN 'Octet' 
			WHEN CB.BALANCE_ID NOT IN (89,101) AND CB.UNIT_TYPE = 4 THEN 'SMS' 
			WHEN CB.BALANCE_ID NOT IN (89,101) AND CB.UNIT_TYPE = 5 THEN 'MMS' 
			WHEN CB.BALANCE_ID NOT IN (89,101) AND CB.UNIT_TYPE = 5001 THEN 'Quantity' 
			ELSE 'Unknown' END AS BALANCE_TYPE,
		'B' AS TABLE_ID,
		C2.TRANS_DT,
		CASE WHEN CB.BALANCE_COUNTER = 1 THEN 0 ELSE 0 END AS TEXT_COUNT,
		C2.EXTERNAL_ID,
		C2.POINT_ORIGIN,
		C2.POINT_TARGET,
		C2.REFUND_FLAG,
		CB.BALANCE_ID,
		CB.BALANCE_COUNTER AS BALANCE_COUNT,
		CB.UNIT_TYPE,
		C2.AUT_ID,
		C2.APPLICATION_ID,
		AV.DISPLAY_VALUE,
		(CB.BALANCE_AMOUNT / CASE WHEN CB.UNIT_TYPE = 1 THEN 30.16 ELSE 26.45 END) * 0.60 AS PRIMARY_UNITS,
		CASE WHEN NVL(C2.TOTAL_TAX,0) > 0 THEN (CASE WHEN C2.REFUND_FLAG != 'Y' THEN (CASE WHEN CB.UNIT_TYPE = 1 THEN CB.BALANCE_AMOUNT / 1.14 ELSE 0 END) ELSE (0 - CB.BALANCE_AMOUNT) / 1.14 END) ELSE (CASE WHEN C2.REFUND_FLAG != 'Y' THEN CB.BALANCE_AMOUNT ELSE 0 - CB.BALANCE_AMOUNT END) END AS AMOUNT,
		CASE WHEN NVL(CB.BALANCE_AMOUNT,0) > 0 THEN (CASE WHEN C2.REFUND_FLAG != 'Y' THEN (CASE WHEN CB.UNIT_TYPE = 1 THEN CB.BALANCE_AMOUNT ELSE 0 END) ELSE 0 - CB.BALANCE_AMOUNT END) END AS CHARGED_AMOUNT,
		C2.DISCOUNT_OFFER_ID,
		CB.PAYMENT_MODE,
		C2.TARIFF_PLAN_OFFER_ID
	FROM CDR_DATA C2
		JOIN CDR_BALANCE CB
		ON C2.MSG_ID = CB.MSG_ID AND C2.MSG_ID2 = CB.MSG_ID2
		JOIN AUT_FINAL_VALUES AV
		ON C2.AUT_ID = AV.AUT_ID AND AV.RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM AUT_FINAL_VALUES)
	WHERE C2.APPLICATION_ID = 2 AND C2.BALANCE_ID IS NULL AND C2.BALANCE_COUNT > 1
	AND C2.TARIFF_PLAN_OFFER_ID in (SELECT OFFER_ID FROM OFFER_REF
	WHERE SERVICE_CATEGORY_ID = 4 AND PAYMENT_MODE != 1
	AND RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM OFFER_REF))
	AND C2.EXTERNAL_ID_TYPE = 1 AND ((C2.EXTERNAL_ID = C2.POINT_ORIGIN) OR (C2.EXTERNAL_ID = C2.POINT_TARGET AND NVL(C2.CHARGED_AMOUNT,0) != 0))
	AND C2.COMP_STATUS IN (16,400) AND NVL(C2.REFUND_FLAG,' ') != 'P'
	AND DATE(C2.TRANS_DT) BETWEEN ADD_MONTHS(CURRENT_DATE - DAY(CURRENT_DATE),-1) + 1 AND CURRENT_DATE - DAY(CURRENT_DATE)) Detail
GROUP BY 1,2
ORDER BY 1,2