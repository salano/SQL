SELECT

  'Recharges' AS RECHARGES,
   DATE(TRANS_DT) DATE,
   SUM(RECHARGES) DAY_TOTAL

FROM(

   SELECT
         TO_CHAR(RH.RECHARGE_DATE_TIME, 'YYYY-MM-DD') AS TRANS_DT,
         AE.RANGE_MAP_EXTERNAL_ID AS EXTERNAL_ID,
         RH.SUBSCR_NO,
         CASE WHEN NVL(RH.RECHARGE_USER,'') IN ('cbs_owner','ussd') THEN 'CARD'
                WHEN NVL(RH.RECHARGE_USER,'') = 'EMIDA' THEN 'EMIDA' --'C-POINT'
                WHEN NVL(RH.RECHARGE_USER,'') = 'mms' THEN 'MMS'
                WHEN NVL(RH.RECHARGE_USER,'') = 'mmguser' THEN 'MMG'
                WHEN NVL(RH.RECHARGE_USER,'') = 'gttsapi' AND NVL(RH.RECHARGE_COMMMENT,'') LIKE 'QTU%' THEN 'ONLINE'
                WHEN NVL(RH.RECHARGE_USER,'') = 'awarex' THEN 'MYGTT'
                ELSE 'OTHERS' END AS METHOD,

        'CORE' AS BALANCE,
         COUNT(DISTINCT RH.RECHARGE_ID) AS RECHARGES,
         SUM(RB.AMOUNT/-100) AS AMOUNT

   FROM RECHARGE_HISTORY RH
         JOIN RECHARGE_HISTORY_BALANCE RB
         ON RH.RECHARGE_ID = RB.RECHARGE_ID AND RH.RECHARGE_ID2 = RB.RECHARGE_ID2
         LEFT JOIN ACCOUNT_SUBSCRIBER_EXTRACT AE
         ON AE.SUBSCR_NO = RH.SUBSCR_NO
         AND DATE(AE.EXTRACT_FILE_DATE) = CURRENT_DATE

   WHERE RB.PAYMENT_MODE = 1 AND RB.BALANCE_ID = 89
         AND DATE(RH.RECHARGE_DATE_TIME) BETWEEN '2019-01-01'::DATE AND CURRENT_DATE-1
         AND SUBSTRING(AE.RANGE_MAP_EXTERNAL_ID,1,4) = '5926'
         AND RB.AMOUNT < 0
         AND SUBSTRING(NVL(RH.RECHARGE_COMMMENT,''),1,8) != 'inswitch'

   GROUP BY 1,2,3,4,5
   ORDER BY 1,2,3,4,5) RCHG

GROUP BY 1, 2
ORDER BY 2 ASC

;
