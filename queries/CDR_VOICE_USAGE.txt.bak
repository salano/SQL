
----------------------Get GENBAND INCOMING AND OUTGOING CALLS-----------------------
WITH GEN_RECORDS (u_month,BID,ACCOUNT_NO,SUBSCR_NO,SERVICE_TYPE, cust_type,DURATION_SEC, outgoing,incoming ) AS (
		SELECT 
			DISTINCT
			GEND.u_month
			,GEND.BID
			,GEND.ACCOUNT_NO
			,GEND.SUBSCR_NO
			,GEND.SERVICE_TYPE
			,GEND.cust_type
			,sum(GEND.O_ELAPSED_TIME + GEND.I_ELAPSED_TIME) DURATION_SEC
			,sum(GEND.O_ELAPSED_TIME) outgoing
			,sum(GEND.I_ELAPSED_TIME) incoming
			
		FROM 
			(
		
				SELECT 
				/* 
				 * OUTGOING CALLS
				 * */
				   to_char(CDR.CONNECT_DATETIME, 'YYYY-MM') u_month
				   ,ORIGINATING_NUMBER BID
				   ,E.ACCOUNT_NO 
				   ,E.SUBSCR_NO
				   ,CASE WHEN E.EXTERNAL_ID_TYPE = 1 THEN 'MOBILE'
				   		WHEN E.EXTERNAL_ID_TYPE = 9 THEN 'LANDLINE'
				   		WHEN E.EXTERNAL_ID_TYPE = 37 THEN 'FIBRE'
				   	END SERVICE_TYPE
				   	,acv.DISPLAY_VALUE cust_type
				   ,ELAPSED_TIME O_ELAPSED_TIME
				   ,0 I_ELAPSED_TIME
				 FROM 
				 	ATNI_PROD.GTT_REPORTING.GENBAND_CDR CDR
				 	LEFT JOIN ATNI_PROD.GTT_REPORTING.EXTERNAL_ID_EQUIP_MAP_EXTRACT E
					 	  ON E.EXTERNAL_ID = CDR.ORIGINATING_NUMBER AND date(E.EXTRACT_FILE_DATE) = date(current_date) AND E.IS_CURRENT = 1
					 JOIN ATNI_PROD.GTT_REPORTING.CMF_EXTRACT c
				   ON E.ACCOUNT_NO = C.ACCOUNT_NO AND date(c.EXTRACT_FILE_DATE) = date(current_date)
				   join ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES acv on c.account_category = acv.account_category and acv.SERVICE_VERSION_ID = (select max(SERVICE_VERSION_ID) from ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES)
				 WHERE 
				 date(CONNECT_DATETIME)	>= ADD_MONTHS(CURRENT_date, -13)
				 AND ELAPSED_TIME > 0
				 --AND CDR.ORIGINATING_NUMBER = '5922750261'
				 AND E.EXTERNAL_ID_TYPE IN (1,9,37)
				 AND (SUBSTRING(ORIGINATING_NUMBER,1,6) IN (SELECT DISTINCT PREFIX_LONG FROM ATNI_PROD.GTT_REPORTING.GTT_PREFIXES)
				     OR SUBSTRING(ORIGINATING_NUMBER,1,4) = '5925' -- Blaze calls
				     OR SUBSTRING(ORIGINATING_NUMBER,1,6) IN (SELECT distinct CONCAT('592', PREFIX) FROM ATNI_DEV.GTT_REPORTING.EXCHANGE_NAMES) -- LANDLINE_INTER 
				 )
		
				 
				 UNION 
				 
				 SELECT 
				/* 
				 * INCOMING CALLS
				 * */
				 to_char(CDR.CONNECT_DATETIME, 'YYYY-MM') u_month
				   ,concat('592',TERMINATING_NUMBER) BID
				   ,E.ACCOUNT_NO 
				   ,E.SUBSCR_NO
				   ,CASE WHEN E.EXTERNAL_ID_TYPE = 1 THEN 'MOBILE'
				   		WHEN E.EXTERNAL_ID_TYPE = 9 THEN 'LANDLINE'
				   		WHEN E.EXTERNAL_ID_TYPE = 37 THEN 'FIBRE'
				   	END SERVICE_TYPE
				   	,acv.DISPLAY_VALUE cust_type
				   ,0 O_ELAPSED_TIME
				   ,ELAPSED_TIME I_ELAPSED_TIME
				 FROM 
				 	ATNI_PROD.GTT_REPORTING.GENBAND_CDR CDR
				 	LEFT JOIN ATNI_PROD.GTT_REPORTING.EXTERNAL_ID_EQUIP_MAP_EXTRACT E
					 	  ON E.EXTERNAL_ID = concat('592',CDR.TERMINATING_NUMBER) AND date(E.EXTRACT_FILE_DATE) = date(current_date) AND E.IS_CURRENT = 1
					JOIN ATNI_PROD.GTT_REPORTING.CMF_EXTRACT c
				   ON E.ACCOUNT_NO = C.ACCOUNT_NO AND date(c.EXTRACT_FILE_DATE) = date(current_date)
				   join ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES acv on c.account_category = acv.account_category and acv.SERVICE_VERSION_ID = (select max(SERVICE_VERSION_ID) from ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES)
				 WHERE 
				 date(CONNECT_DATETIME)	>= ADD_MONTHS(CURRENT_date, -13)
				 AND ELAPSED_TIME > 0
				  --AND concat('592',CDR.TERMINATING_NUMBER) = '5922750261'
				 AND E.EXTERNAL_ID_TYPE IN (1,9,37)
				 AND (concat('592',SUBSTRING(TERMINATING_NUMBER,1,3)) IN (SELECT DISTINCT PREFIX_LONG FROM ATNI_PROD.GTT_REPORTING.GTT_PREFIXES)
				     OR SUBSTRING(TERMINATING_NUMBER,1,2) = '50' -- Blaze calls
				     OR SUBSTRING(TERMINATING_NUMBER,1,3) IN (SELECT distinct PREFIX FROM ATNI_DEV.GTT_REPORTING.EXCHANGE_NAMES) -- LANDLINE_INTER 
				 )
		
		 	) GEND
		 	GROUP BY 1,2,3,4,5,6
	), 
	
	
----------------------Get AIRSPAN INCOMING AND OUTGOING CALLS-----------------------
 AIRSPAN_RECORDS  (u_month,BID,ACCOUNT_NO,SUBSCR_NO,SERVICE_TYPE, cust_type,DURATION_SEC, outgoing,incoming ) AS (
		SELECT 
					DISTINCT
					AIR.u_month
					,AIR.BID
					,AIR.ACCOUNT_NO
					,AIR.SUBSCR_NO
					,AIR.SERVICE_TYPE
					,AIR.cust_type
					,sum(AIR.O_ELAPSED_TIME + AIR.I_ELAPSED_TIME) DURATION_SEC
					,sum(AIR.O_ELAPSED_TIME) outgoing
					,sum(AIR.I_ELAPSED_TIME) incoming
					
				FROM 
					(
				
						SELECT 
						/* 
						 * OUTGOING CALLS
						 * */
						   to_char(CDR.CALL_START_DATETIME, 'YYYY-MM') u_month
						   ,CALLING_PARTY_NUMBER BID
						   ,E.ACCOUNT_NO 
						   ,E.SUBSCR_NO
						   ,CASE WHEN E.EXTERNAL_ID_TYPE = 1 THEN 'MOBILE'
						   		WHEN E.EXTERNAL_ID_TYPE = 9 THEN 'LANDLINE'
						   		WHEN E.EXTERNAL_ID_TYPE = 37 THEN 'FIBRE'
						   	END SERVICE_TYPE
						   	,acv.DISPLAY_VALUE cust_type
						   ,DURATION O_ELAPSED_TIME
						   ,0 I_ELAPSED_TIME
						 FROM 
						 	ATNI_PROD.GTT_REPORTING.AIRSPAN_CDR CDR
						 	LEFT JOIN ATNI_PROD.GTT_REPORTING.EXTERNAL_ID_EQUIP_MAP_EXTRACT E
							 	  ON E.EXTERNAL_ID = CDR.CALLING_PARTY_NUMBER AND date(E.EXTRACT_FILE_DATE) = date(current_date) AND E.IS_CURRENT = 1
							 JOIN ATNI_PROD.GTT_REPORTING.CMF_EXTRACT c
						   ON E.ACCOUNT_NO = C.ACCOUNT_NO AND date(c.EXTRACT_FILE_DATE) = date(current_date)
						   join ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES acv on c.account_category = acv.account_category and acv.SERVICE_VERSION_ID = (select max(SERVICE_VERSION_ID) from ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES)
						 WHERE 
						 date(CALL_START_DATETIME)	>= ADD_MONTHS(CURRENT_date, -13)
						 AND DURATION > 0
						 --AND CDR.ORIGINATING_NUMBER = '5922750261'
						 AND E.EXTERNAL_ID_TYPE IN (1,9,37)
						 AND (SUBSTRING(CALLING_PARTY_NUMBER,1,6) IN (SELECT DISTINCT PREFIX_LONG FROM ATNI_PROD.GTT_REPORTING.GTT_PREFIXES)
						     OR SUBSTRING(CALLING_PARTY_NUMBER,1,4) = '5925' -- Blaze calls
						     OR SUBSTRING(CALLING_PARTY_NUMBER,1,6) IN (SELECT distinct CONCAT('592', PREFIX) FROM ATNI_DEV.GTT_REPORTING.EXCHANGE_NAMES) -- LANDLINE_INTER 
						 )
				
						 
						 UNION 
						 
						 SELECT 
						/* 
						 * INCOMING CALLS
						 * */
						 to_char(CDR.CALL_START_DATETIME, 'YYYY-MM') u_month
						   ,CALLED_PARTY_NUMBER_NP BID
						   ,E.ACCOUNT_NO 
						   ,E.SUBSCR_NO
						   ,CASE WHEN E.EXTERNAL_ID_TYPE = 1 THEN 'MOBILE'
						   		WHEN E.EXTERNAL_ID_TYPE = 9 THEN 'LANDLINE'
						   		WHEN E.EXTERNAL_ID_TYPE = 37 THEN 'FIBRE'
						   	END SERVICE_TYPE
						   	,acv.DISPLAY_VALUE cust_type
						   ,0 O_ELAPSED_TIME
						   ,DURATION I_ELAPSED_TIME
						 FROM 
						 	ATNI_PROD.GTT_REPORTING.AIRSPAN_CDR CDR
						 	LEFT JOIN ATNI_PROD.GTT_REPORTING.EXTERNAL_ID_EQUIP_MAP_EXTRACT E
							 	  ON E.EXTERNAL_ID = CDR.CALLED_PARTY_NUMBER_NP AND date(E.EXTRACT_FILE_DATE) = date(current_date) AND E.IS_CURRENT = 1
							JOIN ATNI_PROD.GTT_REPORTING.CMF_EXTRACT c
						   ON E.ACCOUNT_NO = C.ACCOUNT_NO AND date(c.EXTRACT_FILE_DATE) = date(current_date)
						   join ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES acv on c.account_category = acv.account_category and acv.SERVICE_VERSION_ID = (select max(SERVICE_VERSION_ID) from ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES)
						 WHERE 
						 date(CALL_START_DATETIME)	>= ADD_MONTHS(CURRENT_date, -13)
						 AND DURATION > 0
						  --AND concat('592',CDR.TERMINATING_NUMBER) = '5922750261'
						 AND E.EXTERNAL_ID_TYPE IN (1,9,37)
						 AND (SUBSTRING(CALLED_PARTY_NUMBER_NP,1,6) IN (SELECT DISTINCT PREFIX_LONG FROM ATNI_PROD.GTT_REPORTING.GTT_PREFIXES)
						     OR SUBSTRING(CALLED_PARTY_NUMBER_NP,1,4) = '5925' -- Blaze calls
						     OR SUBSTRING(CALLED_PARTY_NUMBER_NP,1,6) IN (SELECT distinct PREFIX FROM ATNI_DEV.GTT_REPORTING.EXCHANGE_NAMES) -- LANDLINE_INTER 
						 )
				
				 	) AIR
				 	GROUP BY 1,2,3,4,5, 6
				 	
				) 
				 SELECT 
					u_month -- Month of usage
					,BID -- Service phone number
					,ACCOUNT_NO -- ACCOUNT number OF service
					,SUBSCR_NO -- subscriber number OF service
					,SERVICE_TYPE -- TYPE OF service
					,cust_type ACCOUNT_TYPE --- TYPE OF account
					,sum(DURATION_SEC) DURATION_SEC -- total incoming AND outgoing calls
					,sum(outgoing) OUTGOING_SEC -- total outgoing calls
					,sum(incoming) INCOMING_SEC -- total incoming calls
				FROM 
					(
						SELECT * FROM AIRSPAN_RECORDS
						  UNION ALL
						SELECT * FROM GEN_RECORDS
					) ALL_ACTIVITIES
				GROUP BY 1,2,3,4,5,6