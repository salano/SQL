--Prepaid Daily Recharges
SELECT
	TO_CHAR(Detail.RECHARGE_DATE_TIME,'MM/DD/YYYY') RCHG_DT,
	TO_CHAR(Detail.RECHARGE_DATE_TIME,'Dy') RCHG_DAY,
	COUNT(DISTINCT Detail.SUBSCR_NO) TOT_SUB,
	COUNT(1) TOT_CNT,
	SUM(Detail.AMOUNT) TOT_AMT,
	COUNT (DISTINCT CASE WHEN Detail.RECHARGE_TYPE = 'CARD' THEN Detail.SUBSCR_NO END) AS CARD_SUB,
	SUM(CASE WHEN Detail.RECHARGE_TYPE = 'CARD' THEN 1 ELSE 0 END) CARD_CNT,
	SUM(CASE WHEN Detail.RECHARGE_TYPE = 'CARD' THEN Detail.AMOUNT ELSE 0 END) CARD_AMT,
	COUNT (DISTINCT CASE WHEN Detail.RECHARGE_TYPE = 'EMIDA' THEN Detail.SUBSCR_NO END) AS EMIDA_SUB,
	SUM(CASE WHEN Detail.RECHARGE_TYPE = 'EMIDA' THEN 1 ELSE 0 END) EMIDA_CNT,
	SUM(CASE WHEN Detail.RECHARGE_TYPE = 'EMIDA' THEN Detail.AMOUNT ELSE 0 END) EMIDA_AMT,
	COUNT (DISTINCT CASE WHEN Detail.RECHARGE_TYPE = 'MMG' THEN Detail.SUBSCR_NO END) AS MMG_SUB,
	SUM(CASE WHEN Detail.RECHARGE_TYPE = 'MMG' THEN 1 ELSE 0 END) MMG_CNT,
	SUM(CASE WHEN Detail.RECHARGE_TYPE = 'MMG' THEN Detail.AMOUNT ELSE 0 END) MMG_AMT,
	COUNT (DISTINCT CASE WHEN Detail.RECHARGE_TYPE = 'MMS' THEN Detail.SUBSCR_NO END) AS MMS_SUB,
	SUM(CASE WHEN Detail.RECHARGE_TYPE = 'MMS' THEN 1 ELSE 0 END) MMS_CNT,
	SUM(CASE WHEN Detail.RECHARGE_TYPE = 'MMS' THEN Detail.AMOUNT ELSE 0 END) MMS_AMT,
	COUNT (DISTINCT CASE WHEN Detail.RECHARGE_TYPE = 'OTHERS' THEN Detail.SUBSCR_NO END) AS OTHER_SUB,
	SUM(CASE WHEN Detail.RECHARGE_TYPE = 'OTHERS' THEN 1 ELSE 0 END) OTHER_CNT,
	SUM(CASE WHEN Detail.RECHARGE_TYPE = 'OTHERS' THEN Detail.AMOUNT ELSE 0 END) OTHER_AMT,
	COUNT (DISTINCT CASE WHEN Detail.AMOUNT BETWEEN 0.01 AND 200 THEN Detail.SUBSCR_NO END) AS R200_SUB,
	SUM(CASE WHEN Detail.AMOUNT BETWEEN 0.01 AND 200 THEN 1 ELSE 0 END) R200_CNT,
	SUM(CASE WHEN Detail.AMOUNT BETWEEN 0.01 AND 200 THEN Detail.AMOUNT ELSE 0 END) R200_AMT,
	COUNT (DISTINCT CASE WHEN Detail.AMOUNT BETWEEN 200.01 AND 500 THEN Detail.SUBSCR_NO END) AS R500_SUB,
	SUM(CASE WHEN Detail.AMOUNT BETWEEN 200.01 AND 500 THEN 1 ELSE 0 END) R500_CNT,
	SUM(CASE WHEN Detail.AMOUNT BETWEEN 200.01 AND 500 THEN Detail.AMOUNT ELSE 0 END) R500_AMT,
	COUNT (DISTINCT CASE WHEN Detail.AMOUNT BETWEEN 500.01 AND 1000 THEN Detail.SUBSCR_NO END) AS R1000_SUB,
	SUM(CASE WHEN Detail.AMOUNT BETWEEN 500.01 AND 1000 THEN 1 ELSE 0 END) R1000_CNT,
	SUM(CASE WHEN Detail.AMOUNT BETWEEN 500.01 AND 1000 THEN Detail.AMOUNT ELSE 0 END) R1000_AMT,
	COUNT (DISTINCT CASE WHEN Detail.AMOUNT BETWEEN 1000.01 AND 2000 THEN Detail.SUBSCR_NO END) AS R2000_SUB,
	SUM(CASE WHEN Detail.AMOUNT BETWEEN 1000.01 AND 2000 THEN 1 ELSE 0 END) R2000_CNT,
	SUM(CASE WHEN Detail.AMOUNT BETWEEN 1000.01 AND 2000 THEN Detail.AMOUNT ELSE 0 END) R2000_AMT,
	COUNT (DISTINCT CASE WHEN Detail.AMOUNT BETWEEN 2000.01 AND 5000 THEN Detail.SUBSCR_NO END) AS R5000_SUB,
	SUM(CASE WHEN Detail.AMOUNT BETWEEN 2000.01 AND 5000 THEN 1 ELSE 0 END) R5000_CNT,
	SUM(CASE WHEN Detail.AMOUNT BETWEEN 2000.01 AND 5000 THEN Detail.AMOUNT ELSE 0 END) R5000_AMT,
	COUNT (DISTINCT CASE WHEN Detail.AMOUNT > 5000 THEN Detail.SUBSCR_NO END) AS RREST_SUB,
	SUM(CASE WHEN Detail.AMOUNT > 5000 THEN 1 ELSE 0 END) RREST_CNT,
	SUM(CASE WHEN Detail.AMOUNT > 5000 THEN Detail.AMOUNT ELSE 0 END) RREST_AMT
FROM
(SELECT
	RH.RECHARGE_ID,
	RH.RECHARGE_ID2,
	RH.SUBSCR_NO,
	EIEM.EXTERNAL_ID,
	RH.RECHARGE_DATE_TIME,
	RH.RECHARGE_USER,
	RH.RECHARGE_COMMMENT,
	RHB.BALANCE_ID,
	RHB.AMOUNT / -100 AS AMOUNT,
	CASE WHEN RHB.AMOUNT < 0 AND RH.RECHARGE_USER IN ('cbs_owner','ussd') THEN 'CARD'
		WHEN RHB.AMOUNT < 0 AND RH.RECHARGE_USER = 'EMIDA' THEN 'EMIDA'
		WHEN RHB.AMOUNT < 0 AND RH.RECHARGE_USER = 'mmguser' THEN 'MMG'
		WHEN RHB.AMOUNT < 0 AND RH.RECHARGE_USER = 'mms' THEN 'MMS'
		ELSE 'OTHERS' END AS RECHARGE_TYPE
FROM RECHARGE_HISTORY RH
	JOIN RECHARGE_HISTORY_BALANCE RHB
	ON RH.RECHARGE_ID = RHB.RECHARGE_ID AND RH.RECHARGE_ID2 = RHB.RECHARGE_ID2
	LEFT JOIN (
		SELECT DISTINCT 
			SUBSCR_NO, EXTERNAL_ID
		FROM EXTERNAL_ID_EQUIP_MAP
		WHERE DATE(EFFECTIVE_DT)-1 <= ${end_dt} AND DATE(EXPIRY_DT)-1 > ${end_dt}
		AND EXTERNAL_ID_TYPE = 1 AND IS_CURRENT = 1) EIEM
	ON RH.SUBSCR_NO = EIEM.SUBSCR_NO
WHERE DATE(RH.RECHARGE_DATE_TIME) BETWEEN ${begin_dt}::DATE AND ${end_dt}::DATE
AND substring(nvl(RH.RECHARGE_COMMMENT,' '),1,8) != 'inswitch' AND nvl(RHB.AMOUNT,0) < 0
AND substring(EIEM.EXTERNAL_ID,1,4) = '5926'
AND RHB.BALANCE_ID = 89 AND RHB.PAYMENT_MODE = 1) Detail
GROUP BY 1,2 ORDER BY 1;