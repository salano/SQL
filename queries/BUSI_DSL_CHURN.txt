SELECT 

LAST_DAY(score.DEACT_DATE) AS REPORT_MONTH,
 bus_sub.EXCHANGE,
DIV0(SUM(score.NET_DEACTIVATIONS), SUM(score.BEGINNING_ACTIVE))*100 AS CHRUN_RATE,
SUM(score.NET_DEACTIVATIONS) AS CHURN_TOTAL,
SUM(score.BEGINNING_ACTIVE) AS BEGINNING_ACTIVE,
SUM(CASE
WHEN DATE_TRUNC('MONTH', score.DEACT_DATE)=DATE_TRUNC('MONTH', CURRENT_DATE) THEN score.BEGINNING_ACTIVE + score.NET_ACTIVATIONS
ELSE
score.ENDING_ACTIVE
END) AS ENDING_ACTIVE

 

FROM 
(
	SELECT 
	  PHONE_NUMBER,
	  EXCHANGE
	  
	 FROM 
	(
		SELECT 
		    DISTINCT
			A.CCT_ID,
			A.PHONE_NUMBER,
			A.FULL_NAME,
			A.SERVICE_NAME,
			A.STATUS,
			A.EXCHANGE,
			--A.DSL_START_TS,
			--C.ACCOUNT_NO,
			C.CUST_EMAIL Email,
		    C.CUST_PHONE1,
		    C.CUST_PHONE2,
		    C.CONTACT1_PHONE,
		    C.CONTACT2_PHONE
			--B.*
		FROM 
		 ATNI_PROD.GTT_REPORTING.DSL_DUMPS_DNS_RAW A
		 LEFT JOIN
		 	ATNI_PROD.GTT_REPORTING.tmp_DSL_blaze_area B 
		 	ON CONCAT('592',A.PHONE_NUMBER)= b.PHONE
		 LEFT JOIN 
		 	ATNI_PROD.GTT_REPORTING.CMF_EXTRACT c
		 	  ON B.ACCOUNT_NO = C.ACCOUNT_NO AND date(c.EXTRACT_FILE_DATE) = date(current_date)
		WHERE 
		 	EXCHANGE NOT  IN (
		
					SELECT 
						EXCHANGE -- GPON EXCHANGES
					FROM 
						ATNI_PROD.GTT_REPORTING.DSL_DUMPS_DNS_RAW 
					WHERE 
						date(dump_ts) = date(CURRENT_DATE())
					    AND CONCAT('592',PHONE_NUMBER) IN 
					    (SELECT 
							PHONE 
						FROM 
							ATNI_PROD.GTT_REPORTING.tmp_DSL_blaze_area
						WHERE 
							"GPON AREA" ='Y'
							--AND (upper(OFFER_DESCRIPT) LIKE '%CONSUMER%' OR upper(OFFER_DESCRIPT) LIKE '%EMPLOYEE%')
						)
							
		)
		--or EXCHANGE NOT in ('Amelia''s Ward','V/Hoop (Poudroyen)','Non Pariel (ECD)','New Amsterdam'))
		AND A.SERVICE_NAME LIKE '%BUS%'
		AND c.DATE_INACTIVE is  NULL
		AND A.STATUS = TRUE 
		AND date(dump_ts) = date(CURRENT_DATE())
		--AND EXCHANGE = 'Hague / Fellowship'
		--AND B."GPON AREA" ='Y'
		--AND B."GPON AREA" IS NOT NULL
		--AND (upper(B.OFFER_DESCRIPT) LIKE '%CONSUMER%' OR upper(B.OFFER_DESCRIPT) LIKE '%EMPLOYEE%')
		ORDER BY 
			EXCHANGE
	) sub 
	WHERE EXCHANGE NOT in ('Amelia''s Ward','V/Hoop (Poudroyen)','Non Pariel (ECD)','New Amsterdam')
)bus_sub
 JOIN 
(
SELECT
		distinct
		a.DATESTART ,
		ifNULL(b.DATEOUT, a.DATESTART) AS DEACT_DATE,
		a.BID,
		a.BEGINNING_ACTIVE,
		a.NET_ACTIVATIONS,
		a.NET_DEACTIVATIONS,
		a.ENDING_ACTIVE 
		FROM
		ATNI_PROD.ATNI_ANALYTICS.SUBSCRIBER_BG_END_WEEKLY_MONTHLY_SNAPSHOT_DAILYACTIVITY a 
		 LEFT JOIN ATNI_PROD.SC_INPUT.ODSSUBSCRIBERSNAPSHOT b 
		 	ON a.DATESTART = b.DATESTART AND a.ACCOUNTNUMBER = b.ACCOUNTNUMBER  AND a.BID = b.BID AND b.SOURCESYSTEMID=1
		WHERE
		a.SOURCESYSTEMID=1
		AND a.SUBLINE_OF_SERVICE_SEGMENT='DSL'
		AND a.UNIT_COUNTABLE=1
		AND a.REVENUE_COUNTABLE=1
		AND a.DATASET_TYPE IN('BG_MONTHLY_SNAPSHOT', 'END_MONTHLY_SNAPSHOT', 'DAILY_SUB_ACTIVITY')
		--AND date(a.DATESTART) BETWEEN to_date('2021-01-01','YYYY-MM-DD') AND to_date('2021-12-31','YYYY-MM-DD')
				
) score

ON concat('592',bus_sub.PHONE_NUMBER) = score.BID
WHERE date(score.DEACT_DATE)  BETWEEN to_date('2021-01-01','YYYY-MM-DD') AND to_date('2021-12-31','YYYY-MM-DD')
GROUP BY 1,2
Order BY 1,2