SELECT DISTINCT
date(ES2.DATEFORSTARTOFCHARGE) || ' ' || TO_TIME(ES2.TIMEFORSTARTOFCHARGE) AS CALL_DT,
ES2.DATEFORSTARTOFCHARGE,
ES2.TIMEFORSTARTOFCHARGE,
ES2.CALLINGPARTYNUMBER AS SOURCE_ID,
ES2.CALLEDPARTYNUMBER AS TARGET_ID,
ES2.CALLEDSUBSCRIBERIMEI,
ES2.CHARGEABLEDURATION,
CASE WHEN ES2.CHARGEABLEDURATION = '0:0:0' THEN 0
WHEN SUBSTRING(ES2.CHARGEABLEDURATION,1,4) = '0:0:' THEN to_number(SUBSTRING(ES2.CHARGEABLEDURATION,5))
WHEN SUBSTRING(ES2.CHARGEABLEDURATION,1,2) = '0:' THEN
(CASE WHEN SUBSTRING(ES2.CHARGEABLEDURATION,4,1) = ':' THEN to_number(SUBSTRING(ES2.CHARGEABLEDURATION,3,1)) * 60 + to_number(SUBSTRING(ES2.CHARGEABLEDURATION,5))
ELSE to_number(SUBSTRING(ES2.CHARGEABLEDURATION,3,2)) * 60 + to_number(SUBSTRING(ES2.CHARGEABLEDURATION,6)) END)
ELSE 86400 END AS SECONDS,
ES2.FIRSTCALLEDLOCATIONINFORMATION_LAC AS TARGET_LAC,
ES2.FIRSTCALLEDLOCATIONINFORMATION_CI AS TARGET_CI,
GCS2.DESCRIPTION AS TARGET_LOCATION
FROM ATNI_PROD.STAGING.ERICSSON_GSM ES2
LEFT JOIN GTT_REPORTING.GSM_CELL_SITES GCS2
ON GCS2.LAC = ES2.FIRSTCALLEDLOCATIONINFORMATION_LAC AND GCS2.CID = ES2.FIRSTCALLEDLOCATIONINFORMATION_CI
WHERE date(ES2.DATEFORSTARTOFCHARGE) BETWEEN ${date_from}::DATE AND ${date_to}::DATE
AND ES2.MODULE = 'MSTerminating'
AND (ES2.CALLEDPARTYNUMBER IN (${phone},SUBSTRING(${phone},4,7)) OR ES2.CALLINGPARTYNUMBER IN (${phone},SUBSTRING(${phone},4,7)))) T_CALL
ON T_CAll.DATEFORSTARTOFCHARGE = ERC.DATEFORSTARTOFCHARGE AND T_CALL.TIMEFORSTARTOFCHARGE = ERC.TIMEFORSTARTOFCHARGE
AND T_CALL.SOURCE_ID = ERC.CALLINGPARTYNUMBER
AND NVL(T_CALL.TARGET_ID,'') = NVL(ERC.CALLEDPARTYNUMBER,'')
AND T_CALL.CHARGEABLEDURATION = ERC.CHARGEABLEDURATION
WHERE date(ERC.DATEFORSTARTOFCHARGE) BETWEEN ${date_from}::DATE AND ${date_to}::DATE
AND ERC.MODULE = 'MSOriginating' --IN ('MSOriginating','MSTerminating') --removed because of duplicates
AND (ERC.CALLEDPARTYNUMBER IN (${phone},SUBSTRING(${phone},4,7)) OR ERC.CALLINGPARTYNUMBER IN (${phone},SUBSTRING(${phone},4,7)))
ORDER BY 1;



SELECT 
	CALLINGPARTYNUMBER,
	CALLEDPARTYNUMBER,
	DATEFORSTARTOFCHARGE,
	TIMEFORSTARTOFCHARGE,
	CHARGEABLEDURATION duration,
	CASE WHEN ES2.CHARGEABLEDURATION = '0:0:0' THEN 0
	WHEN SUBSTRING(ES2.CHARGEABLEDURATION,1,4) = '0:0:' THEN to_number(SUBSTRING(ES2.CHARGEABLEDURATION,5))
	WHEN SUBSTRING(ES2.CHARGEABLEDURATION,1,2) = '0:' THEN
	(CASE WHEN SUBSTRING(ES2.CHARGEABLEDURATION,4,1) = ':' THEN to_number(SUBSTRING(ES2.CHARGEABLEDURATION,3,1)) * 60 + to_number(SUBSTRING(ES2.CHARGEABLEDURATION,5))
	ELSE to_number(SUBSTRING(ES2.CHARGEABLEDURATION,3,2)) * 60 + to_number(SUBSTRING(ES2.CHARGEABLEDURATION,6)) END)
	ELSE 86400 END AS SECONDS
FROM 
	ATNI_PROD.CDR.GTT_ERICSSON_GSM ES2
WHERE (CALLEDPARTYNUMBER IN (
							'5926537236',
							'5926531359',
							'5922657236' 
							)
	 OR CALLINGPARTYNUMBER IN (
	 						'5926537236',
							'5926531359',
							'5922657236' 
	 						))
	 						
     AND MODULE = 'MSOriginating' 
     AND date(DATEFORSTARTOFCHARGE) BETWEEN  to_date('01-08-2021','DD-MM-YYYY') AND to_date('31-08-2021','DD-MM-YYYY')
ORDER BY 1,2,3,4