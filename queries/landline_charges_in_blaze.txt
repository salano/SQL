SELECT 
	to_char(TRANS_DT, 'YYYY-MM') month,
	X.ACCOUNT_NO,
	EXTERNAL_ID,
	SUBSCR_NO,
	C.BILL_FNAME ,
	C.BILL_LNAME ,
	C.BILL_COMPANY ,
	round(sum(NVL(AMOUNT_POSTPAID,0) / 100),2) AS AMOUNT_POSTPAID,
	round(sum(PRIMARY_UNITS / 60),2)  AS TOTAL_MINUTES
FROM 

	(


		SELECT 
				CD.TRANS_DT,
				CD.MSG_ID,
				CD.MSG_ID2,
				'C' AS TABLE_ID,
				1 AS CALL_COUNT,
				CD.EXTERNAL_ID,
				CD.ACCOUNT_NO,
				CD.SUBSCR_NO,
				CD.POINT_TARGET,
				CD.BALANCE_ID,
				CD.PRIMARY_UNITS,
				NVL(CD.AMOUNT_POSTPAID,0) / 100 AS AMOUNT_POSTPAID,
				CD.AUT_ID,
				AFV.DISPLAY_VALUE AS AUT_DESCRIPTION,
				AGM.AUT_GROUP_ID,
				AGV.DISPLAY_VALUE AS GROUP_DESC,
				CD.ACCOUNT_CATEGORY,
				EXC.EXC_DESC AS EXCHANGE
			FROM CDR_DATA CD
				JOIN AUT_FINAL_VALUES AFV
				ON AFV.AUT_ID = CD.AUT_ID
				AND AFV.RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM AUT_FINAL_VALUES)
				LEFT JOIN AUT_GROUP_MAP AGM
				ON AGM.AUT_ID = AFV.AUT_ID
				AND AGM.RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM AUT_GROUP_MAP)
				LEFT JOIN AUT_GROUP_VALUES AGV
				ON AGV.AUT_GROUP_ID = AGM.AUT_GROUP_ID
				AND AGV.RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM AUT_GROUP_VALUES)
				LEFT JOIN LAND_EXCHANGES EXC
				ON SUBSTRING(CD.EXTERNAL_ID,1,7) = EXC.EXC_CODE
			WHERE CD.EXTERNAL_ID_TYPE IN (9,27) 
			AND CD.APPLICATION_ID = 1
			AND CD.EXTERNAL_ID = CD.POINT_ORIGIN
			AND NVL(CD.PRIMARY_UNITS,0) > 0
			AND CD.BALANCE_ID IS NOT NULL
			--AND AGM.AUT_GROUP_ID != 16
			AND DATE(CD.TRANS_DT) BETWEEN ADD_MONTHS(CURRENT_DATE - DAY(CURRENT_DATE),-1) + 1 AND CURRENT_DATE - DAY(CURRENT_DATE)
			UNION ALL 
			SELECT 
				C2.TRANS_DT,
				C2.MSG_ID,
				C2.MSG_ID2,
				'B' AS TABLE_ID,
				CASE WHEN CB.BALANCE_COUNTER = 1 THEN 1 ELSE 0 END AS CALL_COUNT,
				C2.EXTERNAL_ID,
				C2.ACCOUNT_NO,
				C2.SUBSCR_NO,
				C2.POINT_TARGET,
				CB.BALANCE_ID,
				(C2.PRIMARY_UNITS / C2.CHARGED_AMOUNT_POSTPAID) * CB.BALANCE_AMOUNT AS PRIMARY_UNITS,
				CASE WHEN CB.UNIT_TYPE = 1 THEN NVL(CB.UNITS,0) ELSE 0 END / 100 AS AMOUNT_POSTPAID,
				C2.AUT_ID,
				AFV.DISPLAY_VALUE AS AUT_DESCRIPTION,
				AGM.AUT_GROUP_ID,
				AGV.DISPLAY_VALUE AS GROUP_DESC,
				C2.ACCOUNT_CATEGORY,
				EXC.EXC_DESC AS EXCHANGE
			FROM CDR_DATA C2
				JOIN CDR_BALANCE CB
				ON CB.MSG_ID = C2.MSG_ID AND CB.MSG_ID2 = C2.MSG_ID2
				AND DATE(CB.EXPECTED_CUTOFF_DT) BETWEEN ADD_MONTHS(CURRENT_DATE - DAY(CURRENT_DATE),-1) AND CURRENT_DATE - DAY(CURRENT_DATE) + 2
				JOIN AUT_FINAL_VALUES AFV
				ON AFV.AUT_ID = C2.AUT_ID
				AND AFV.RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM AUT_FINAL_VALUES)
				LEFT JOIN AUT_GROUP_MAP AGM
				ON AGM.AUT_ID = AFV.AUT_ID
				AND AGM.RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM AUT_GROUP_MAP)
				LEFT JOIN AUT_GROUP_VALUES AGV
				ON AGV.AUT_GROUP_ID = AGM.AUT_GROUP_ID
				AND AGV.RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM AUT_GROUP_VALUES)
				LEFT JOIN LAND_EXCHANGES EXC
				ON SUBSTRING(C2.EXTERNAL_ID,1,7) = EXC.EXC_CODE
			WHERE C2.EXTERNAL_ID_TYPE IN (9,27) 
			AND C2.APPLICATION_ID = 1
			AND C2.EXTERNAL_ID = C2.POINT_ORIGIN
			AND NVL(C2.PRIMARY_UNITS,0) > 0
			AND C2.BALANCE_ID IS NULL
			--AND AGM.AUT_GROUP_ID != 16
			AND DATE(C2.TRANS_DT) BETWEEN ADD_MONTHS(CURRENT_DATE - DAY(CURRENT_DATE),-1) + 1 AND CURRENT_DATE - DAY(CURRENT_DATE)
		)X
		LEFT JOIN GTT_REPORTING.CMF_EXTRACT C
		ON X.ACCOUNT_NO = C.ACCOUNT_NO  AND date(c.EXTRACT_FILE_DATE) = current_date  
		LEFT JOIN ATNI_DEV.GTT_REPORTING.EXCHANGE_NAMES EN
				ON try_to_numeric(SUBSTRING(X.EXTERNAL_ID, 4, 3)) = EN.prefix AND try_to_numeric(SUBSTRING(X.EXTERNAL_ID, 7, 1)) >= EN.LOWER_RANGE AND try_to_numeric(SUBSTRING(X.EXTERNAL_ID, 7, 1)) <= EN.UPPER_RANGE
			WHERE (EN.EXCHANGE IN (
				
							SELECT 
								EXCHANGE -- GPON EXCHANGES
							FROM 
								ATNI_PROD.GTT_REPORTING.DSL_DUMPS_DNS_RAW 
							WHERE 
								date(dump_ts) = date(CURRENT_DATE())
							    AND CONCAT('592',PHONE_NUMBER) IN 
							    (SELECT 
									PHONE 
								FROM 
									ATNI_PROD.GTT_REPORTING.tmp_DSL_blaze_area
								WHERE 
									"GPON AREA" ='Y'
									--AND (upper(OFFER_DESCRIPT) LIKE '%CONSUMER%' OR upper(OFFER_DESCRIPT) LIKE '%EMPLOYEE%')
								)
									
				)
				
			OR EN.EXCHANGE in ('Amelia''s Ward','V/Hoop (Poudroyen)','Non Pariel (ECD)','New Amsterdam','Mahaica'))
			AND C.ACCOUNT_CATEGORY IN (3,4)
GROUP BY 1,2,3,4,5,6,7