SELECT
    CD.ACCOUNT_NO,
    CD.EXTERNAL_ID,
    to_char(CD.TRANS_DT, 'YYYY-MM') u_month,
    count(1) num_calls,
    round(sum(CASE WHEN CD.Balance_id=154 THEN CD.PRIMARY_UNITS/60 ELSE 0 END),2) Free_blaze_to_Blaze,
    round(sum(CASE WHEN CD.Balance_id=155 THEN CD.PRIMARY_UNITS/60 ELSE 0 END),2) Free_blaze_to_landline,
    round(sum(CD.PRIMARY_UNITS/60),2) AS metered_minutes,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=47 THEN CD.PRIMARY_UNITS/60 ELSE 0 END),2) Free_blaze_to_International,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=51 THEN CD.PRIMARY_UNITS/60 ELSE 0 END),2) Blaze_to_Blaze,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=50 THEN CD.PRIMARY_UNITS/60 ELSE 0 END),2) Blaze_to_landline,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=48 THEN CD.PRIMARY_UNITS/60 ELSE 0 END),2) Blaze_to_gtt_mobile,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=49 THEN CD.PRIMARY_UNITS/60 ELSE 0 END),2) Blaze_to_digicel_mobile,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID NOT IN (47,48,49,50,51,154,155) THEN CD.PRIMARY_UNITS/60 ELSE 0 END),2) Blaze_other,
    round(sum(CD.AMOUNT / 100),2) AS metered_revenue,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=47 THEN CD.AMOUNT / 100 ELSE 0 END),2) Free_blaze_to_International_revenue,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=51 THEN CD.AMOUNT / 100 ELSE 0 END),2) Blaze_to_Blaze_revenue,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=50 THEN CD.AMOUNT / 100 ELSE 0 END),2) Blaze_to_landline_revenue,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=48 THEN CD.AMOUNT / 100 ELSE 0 END),2) Blaze_to_gtt_mobile_revenue,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=49 THEN CD.AMOUNT / 100 ELSE 0 END),2) Blaze_to_digicel_mobile_revenue,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID NOT IN (47,48,49,50,51) THEN CD.AMOUNT / 100 ELSE 0 END),2) Blaze_other_revenue
    

FROM ATNI_PROD.GTT_REPORTING.CDR_DATA CD
    JOIN ATNI_PROD.GTT_REPORTING.AUT_FINAL_VALUES AFV
    ON AFV.AUT_ID = CD.AUT_ID
    AND AFV.RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM ATNI_PROD.GTT_REPORTING.AUT_FINAL_VALUES)
    LEFT JOIN ATNI_PROD.GTT_REPORTING.AUT_GROUP_MAP AGM
        ON AGM.AUT_ID = CD.AUT_ID
        AND AGM.RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM ATNI_PROD.GTT_REPORTING.AUT_GROUP_MAP)
WHERE DATE(CD.TRANS_DT) BETWEEN to_date('2019-01-01','YYYY-MM-DD') AND to_date('2019-12-31','YYYY-MM-DD') 
AND CD.EXTERNAL_ID_TYPE = 37
AND CD.PRIMARY_UNITS > 0
AND AFV.DISPLAY_VALUE LIKE '%Voice_GPON%'
GROUP BY 1,2,3
ORDER BY 12,3
--LIMIT 100
;