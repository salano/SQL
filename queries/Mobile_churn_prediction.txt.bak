
SELECT 
	OPERATING_COMPANY_CODE
	,OPERATING_COMPANY_NAME
	,Sc.ACCOUNTNUMBER
	,SC.BID
	,PRODUCT_CODE
	,PRODUCT_NAME
	,p.PAYMENT_CHANNEL_NAME
	,tenure_days
	,sp.days_suspended
	
FROM 
 (

		SELECT DATEADD('DAY',-1,DATEADD('MONTH',1,DATE_TRUNC('MONTH',DATESTART)))AS DATESTART_MONTH_ENDING
									, SUB.OPERATING_COMPANY_CODE
									, SUB.OPERATING_COMPANY_NAME 
									, SUB.ACCOUNTNUMBER
									,LINE_OF_SERVICE
									,SUBLINE_OF_SERVICE
									,SUBLINE_OF_SERVICE_SEGMENT
									,CUSTOMER_TYPE_NAME
									,PRODUCT_CODE
									,PRODUCT_NAME 
									, datediff(day, DATESTART , current_date) tenure_days
									, RTRIM(SUB.BID) AS BID
									, SUB.UNIT_COUNTABLE
									, SUB.REVENUE_COUNTABLE
									, SUB.OFFICIALLY_COUNTED_SUBSCRIBER
									, SUB.SYSTEMID
									, MIN(SUB.DATEIN) AS DATEIN
									--, SUB.DATASET_TYPE 
									, SUM(SUB.BEGINNING_ACTIVE) AS BEGINNING_ACTIVE
									, SUM(CASE WHEN DATE_TRUNC('MONTH',DATESTART)=DATE_TRUNC('MONTH',CURRENT_DATE) THEN BEGINNING_ACTIVE+NET_ACTIVATIONS
									      ELSE
									       SUB.ENDING_ACTIVE
									      END) AS ENDING_ACTIVE
									, SUM(SUB.DEACTIVATIONS) AS DEACTIVATIONS
									, SUM(SUB.REACTIVATIONS) AS REACTIVATIONS
									, SUM(SUB.NET_DEACTIVATIONS) AS NET_DEACTIVATIONS
									, SUM(SUB.ACTIVATIONS) AS ACTIVATIONS
									, SUM(SUB.NET_ACTIVATIONS) AS NET_ACTIVATIONS
									, SUM(SUB.NET_SUSPENDS) AS NET_SUSPENDS
									, SUM(SUB.ENDING_SUSPEND) AS ENDING_SUSPEND
									, SUM(SUB.ENDING_PENDING_DEACTIVATION) AS ENDING_PENDING_DEACTIVATION
									, SUM(SUB.ENDING_PENDING_ACTIVE) AS ENDING_PENDING_ACTIVE
									, SUM(SUB.BEGINNING_PENDING_ACTIVE) AS BEGINNING_PENDING_ACTIVE
									, SUM(SUB.BEGINNING_PENDING_DEACTIVATION) AS BEGINNING_PENDING_DEACTIVATION
								FROM ATNI_PROD.ATNI_ANALYTICS.SUBSCRIBER_BG_END_WEEKLY_MONTHLY_SNAPSHOT_DAILYACTIVITY SUB
								WHERE SUB.DATASET_TYPE IN ('END_MONTHLY_SNAPSHOT', 'DAILY_SUB_ACTIVITY')
									AND SUB.OPERATING_COMPANY_CODE = 1 --GTT
									--AND SUB.OFFICIALLY_COUNTED_SUBSCRIBER = 'yes'
									AND SUBLINE_OF_SERVICE_SEGMENT != 'DSL'
									AND date(DATESTART) >= ADD_MONTHS(current_date, -6)
									AND SUBLINE_OF_SERVICE IN ('Mobile Prepaid')
									--AND SUB.SYSTEMID IN (4,8,18,24)
									--AND LINE_OF_SERVICE  IN ('Voice','Mobile')
								GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16
								
								
						UNION 
						
							SELECT DATEADD('DAY',-1,DATEADD('MONTH',1,DATE_TRUNC('MONTH',DATESTART)))AS DATESTART_MONTH_ENDING
									, SUB.OPERATING_COMPANY_CODE
									, SUB.OPERATING_COMPANY_NAME 
									, SUB.ACCOUNTNUMBER
									,LINE_OF_SERVICE
									,SUBLINE_OF_SERVICE
									,SUBLINE_OF_SERVICE_SEGMENT
									,CUSTOMER_TYPE_NAME
									,PRODUCT_CODE
									,PRODUCT_NAME 
									, datediff(day, DATESTART , current_date) tenure_days
									, RTRIM(SUB.BID) AS BID
									, SUB.UNIT_COUNTABLE
									, SUB.REVENUE_COUNTABLE
									, SUB.OFFICIALLY_COUNTED_SUBSCRIBER
									, SUB.SYSTEMID
									, MIN(SUB.DATEIN) AS DATEIN
									--, SUB.DATASET_TYPE 
									, SUM(SUB.BEGINNING_ACTIVE) AS BEGINNING_ACTIVE
									, SUM(CASE WHEN DATE_TRUNC('MONTH',DATESTART)=DATE_TRUNC('MONTH',CURRENT_DATE) THEN BEGINNING_ACTIVE+NET_ACTIVATIONS
									      ELSE
									       SUB.ENDING_ACTIVE
									      END) AS ENDING_ACTIVE
									, SUM(SUB.DEACTIVATIONS) AS DEACTIVATIONS
									, SUM(SUB.REACTIVATIONS) AS REACTIVATIONS
									, SUM(SUB.NET_DEACTIVATIONS) AS NET_DEACTIVATIONS
									, SUM(SUB.ACTIVATIONS) AS ACTIVATIONS
									, SUM(SUB.NET_ACTIVATIONS) AS NET_ACTIVATIONS
									, SUM(SUB.NET_SUSPENDS) AS NET_SUSPENDS
									, SUM(SUB.ENDING_SUSPEND) AS ENDING_SUSPEND
									, SUM(SUB.ENDING_PENDING_DEACTIVATION) AS ENDING_PENDING_DEACTIVATION
									, SUM(SUB.ENDING_PENDING_ACTIVE) AS ENDING_PENDING_ACTIVE
									, SUM(SUB.BEGINNING_PENDING_ACTIVE) AS BEGINNING_PENDING_ACTIVE
									, SUM(SUB.BEGINNING_PENDING_DEACTIVATION) AS BEGINNING_PENDING_DEACTIVATION
								FROM ATNI_PROD.ATNI_ANALYTICS.SUBSCRIBER_BG_END_WEEKLY_MONTHLY_SNAPSHOT_DAILYACTIVITY SUB
								WHERE SUB.DATASET_TYPE IN ('BG_MONTHLY_SNAPSHOT', 'DAILY_SUB_ACTIVITY') -- IN ('BG_MONTHLY_SNAPSHOT','END_MONTHLY_SNAPSHOT', 'DAILY_SUB_ACTIVITY')
									AND SUB.OPERATING_COMPANY_CODE = 1 --GTT
									--AND SUB.OFFICIALLY_COUNTED_SUBSCRIBER = 'yes'
									AND SUBLINE_OF_SERVICE_SEGMENT != 'DSL'
									AND DATE_TRUNC('MONTH',DATESTART)=DATE_TRUNC('MONTH',CURRENT_DATE)
									AND date(DATESTART) >= ADD_MONTHS(current_date, -6)
									AND SUBLINE_OF_SERVICE IN ('Mobile Prepaid')
									--AND SUB.SYSTEMID IN (4,8,18,24)
									--AND LINE_OF_SERVICE  IN ('Voice','Mobile')
								GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16
	)SC
	LEFT JOIN (
			SELECT 
				ACCOUNTNUMBER 
				,BID 
				,sum(datediff(day, DATEIN , DATEOUT)) days_suspended
			FROM 
				ATNI_PROD.ATNI_ANALYTICS.SV_SUBSCRIBER_BG_END_WEEKLY_MONTHLY_SNAPSHOT_DAILYACTIVITY
			WHERE
				DATASET_TYPE='DAILY_SUB_ACTIVITY'
				AND OPERATING_COMPANY_CODE=1
				AND OFFICIALLY_COUNTED_SUBSCRIBER='yes'
				AND SUSPEND_TO_ACTIVE<>0
				AND date(DATESTART) >= ADD_MONTHS(current_date, -6)
			GROUP BY 1,2
	)SP
	
ON SC.ACCOUNTNUMBER = SP.ACCOUNTNUMBER AND SC.BID = SP.BID
LEFT JOIN ATNI_DEV.GTT_REPORTING.SV_GTT_PAYMENT P
	ON SC.ACCOUNTNUMBER = P.ACCOUNTNUMBER AND SC.BID = P.BID AND date(p.DATESTART) >= ADD_MONTHS(current_date, -6) AND P.OPERATING_COMPANY_CODE=1
	
	WHERE 
	SC.ENDING_ACTIVE = 1
	AND SC.REVENUE_COUNTABLE=1