
----------------------Get GENBAND INCOMING AND OUTGOING CALLS-----------------------
WITH GEN_RECORDS (u_month,BID,ACCOUNT_NO,SUBSCR_NO,SERVICE_TYPE, cust_type,DURATION_SEC, outgoing,incoming ) AS (
		SELECT 
			DISTINCT
			GEND.u_month
			,GEND.BID
			,GEND.ACCOUNT_NO
			,GEND.SUBSCR_NO
			,GEND.SERVICE_TYPE
			,GEND.cust_type
			,sum(GEND.O_ELAPSED_TIME + GEND.I_ELAPSED_TIME) DURATION_SEC
			,sum(GEND.O_ELAPSED_TIME) outgoing
			,sum(GEND.I_ELAPSED_TIME) incoming
			
		FROM 
			(
		
				SELECT 
				/* 
				 * OUTGOING CALLS
				 * */
				   to_char(CDR.CONNECT_DATETIME, 'YYYY-MM') u_month
				   ,ORIGINATING_NUMBER BID
				   ,E.ACCOUNT_NO 
				   ,E.SUBSCR_NO
				   ,CASE WHEN E.EXTERNAL_ID_TYPE = 1 THEN 'MOBILE'
				   		WHEN E.EXTERNAL_ID_TYPE = 9 THEN 'LANDLINE'
				   		WHEN E.EXTERNAL_ID_TYPE = 37 THEN 'FIBRE'
				   	END SERVICE_TYPE
				   	,acv.DISPLAY_VALUE cust_type
				   ,ELAPSED_TIME O_ELAPSED_TIME
				   ,0 I_ELAPSED_TIME
				 FROM 
				 	ATNI_PROD.GTT_REPORTING.GENBAND_CDR CDR
				 	LEFT JOIN ATNI_PROD.GTT_REPORTING.EXTERNAL_ID_EQUIP_MAP_EXTRACT E
					 	  ON E.EXTERNAL_ID = CDR.ORIGINATING_NUMBER AND date(E.EXTRACT_FILE_DATE) = date(current_date) AND E.IS_CURRENT = 1
					 JOIN ATNI_PROD.GTT_REPORTING.CMF_EXTRACT c
				   ON E.ACCOUNT_NO = C.ACCOUNT_NO AND date(c.EXTRACT_FILE_DATE) = date(current_date)
				   join ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES acv on c.account_category = acv.account_category and acv.SERVICE_VERSION_ID = (select max(SERVICE_VERSION_ID) from ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES)
				 WHERE 
				 date(CONNECT_DATETIME)	>= ADD_MONTHS(CURRENT_date, -13)
				 AND ELAPSED_TIME > 0
				 --AND CDR.ORIGINATING_NUMBER = '5922750261'
				 AND E.EXTERNAL_ID_TYPE IN (1,9,37)
				 AND (SUBSTRING(ORIGINATING_NUMBER,1,6) IN (SELECT DISTINCT PREFIX_LONG FROM ATNI_PROD.GTT_REPORTING.GTT_PREFIXES)
				     OR SUBSTRING(ORIGINATING_NUMBER,1,4) = '5925' -- Blaze calls
				     OR SUBSTRING(ORIGINATING_NUMBER,1,6) IN (SELECT distinct CONCAT('592', PREFIX) FROM ATNI_DEV.GTT_REPORTING.EXCHANGE_NAMES) -- LANDLINE_INTER 
				 )
		
				 
				 UNION 
				 
				 SELECT 
				/* 
				 * INCOMING CALLS
				 * */
				 to_char(CDR.CONNECT_DATETIME, 'YYYY-MM') u_month
				   ,concat('592',TERMINATING_NUMBER) BID
				   ,E.ACCOUNT_NO 
				   ,E.SUBSCR_NO
				   ,CASE WHEN E.EXTERNAL_ID_TYPE = 1 THEN 'MOBILE'
				   		WHEN E.EXTERNAL_ID_TYPE = 9 THEN 'LANDLINE'
				   		WHEN E.EXTERNAL_ID_TYPE = 37 THEN 'FIBRE'
				   	END SERVICE_TYPE
				   	,acv.DISPLAY_VALUE cust_type
				   ,0 O_ELAPSED_TIME
				   ,ELAPSED_TIME I_ELAPSED_TIME
				 FROM 
				 	ATNI_PROD.GTT_REPORTING.GENBAND_CDR CDR
				 	LEFT JOIN ATNI_PROD.GTT_REPORTING.EXTERNAL_ID_EQUIP_MAP_EXTRACT E
					 	  ON E.EXTERNAL_ID = concat('592',CDR.TERMINATING_NUMBER) AND date(E.EXTRACT_FILE_DATE) = date(current_date) AND E.IS_CURRENT = 1
					JOIN ATNI_PROD.GTT_REPORTING.CMF_EXTRACT c
				   ON E.ACCOUNT_NO = C.ACCOUNT_NO AND date(c.EXTRACT_FILE_DATE) = date(current_date)
				   join ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES acv on c.account_category = acv.account_category and acv.SERVICE_VERSION_ID = (select max(SERVICE_VERSION_ID) from ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES)
				 WHERE 
				 date(CONNECT_DATETIME)	>= ADD_MONTHS(CURRENT_date, -13)
				 AND ELAPSED_TIME > 0
				  --AND concat('592',CDR.TERMINATING_NUMBER) = '5922750261'
				 AND E.EXTERNAL_ID_TYPE IN (1,9,37)
				 AND (concat('592',SUBSTRING(TERMINATING_NUMBER,1,3)) IN (SELECT DISTINCT PREFIX_LONG FROM ATNI_PROD.GTT_REPORTING.GTT_PREFIXES)
				     OR SUBSTRING(TERMINATING_NUMBER,1,2) = '50' -- Blaze calls
				     OR SUBSTRING(TERMINATING_NUMBER,1,3) IN (SELECT distinct PREFIX FROM ATNI_DEV.GTT_REPORTING.EXCHANGE_NAMES) -- LANDLINE_INTER 
				 )
		
		 	) GEND
		 	GROUP BY 1,2,3,4,5,6
	), 
	
	
----------------------Get AIRSPAN INCOMING AND OUTGOING CALLS-----------------------
 AIRSPAN_RECORDS  (u_month,BID,ACCOUNT_NO,SUBSCR_NO,SERVICE_TYPE, cust_type,DURATION_SEC, outgoing,incoming ) AS (
		SELECT 
					DISTINCT
					AIR.u_month
					,AIR.BID
					,AIR.ACCOUNT_NO
					,AIR.SUBSCR_NO
					,AIR.SERVICE_TYPE
					,AIR.cust_type
					,sum(AIR.O_ELAPSED_TIME + AIR.I_ELAPSED_TIME) DURATION_SEC
					,sum(AIR.O_ELAPSED_TIME) outgoing
					,sum(AIR.I_ELAPSED_TIME) incoming
					
				FROM 
					(
				
						SELECT 
						/* 
						 * OUTGOING CALLS
						 * */
						   to_char(CDR.CALL_START_DATETIME, 'YYYY-MM') u_month
						   ,CALLING_PARTY_NUMBER BID
						   ,E.ACCOUNT_NO 
						   ,E.SUBSCR_NO
						   ,CASE WHEN E.EXTERNAL_ID_TYPE = 1 THEN 'MOBILE'
						   		WHEN E.EXTERNAL_ID_TYPE = 9 THEN 'LANDLINE'
						   		WHEN E.EXTERNAL_ID_TYPE = 37 THEN 'FIBRE'
						   	END SERVICE_TYPE
						   	,acv.DISPLAY_VALUE cust_type
						   ,DURATION O_ELAPSED_TIME
						   ,0 I_ELAPSED_TIME
						 FROM 
						 	ATNI_PROD.GTT_REPORTING.AIRSPAN_CDR CDR
						 	LEFT JOIN ATNI_PROD.GTT_REPORTING.EXTERNAL_ID_EQUIP_MAP_EXTRACT E
							 	  ON E.EXTERNAL_ID = CDR.CALLING_PARTY_NUMBER AND date(E.EXTRACT_FILE_DATE) = date(current_date) AND E.IS_CURRENT = 1
							 JOIN ATNI_PROD.GTT_REPORTING.CMF_EXTRACT c
						   ON E.ACCOUNT_NO = C.ACCOUNT_NO AND date(c.EXTRACT_FILE_DATE) = date(current_date)
						   join ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES acv on c.account_category = acv.account_category and acv.SERVICE_VERSION_ID = (select max(SERVICE_VERSION_ID) from ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES)
						 WHERE 
						 date(CALL_START_DATETIME)	>= ADD_MONTHS(CURRENT_date, -13)
						 AND DURATION > 0
						 --AND CDR.ORIGINATING_NUMBER = '5922750261'
						 AND E.EXTERNAL_ID_TYPE IN (1,9,37)
						 AND (SUBSTRING(CALLING_PARTY_NUMBER,1,6) IN (SELECT DISTINCT PREFIX_LONG FROM ATNI_PROD.GTT_REPORTING.GTT_PREFIXES)
						     OR SUBSTRING(CALLING_PARTY_NUMBER,1,4) = '5925' -- Blaze calls
						     OR SUBSTRING(CALLING_PARTY_NUMBER,1,6) IN (SELECT distinct CONCAT('592', PREFIX) FROM ATNI_DEV.GTT_REPORTING.EXCHANGE_NAMES) -- LANDLINE_INTER 
						 )
				
						 
						 UNION 
						 
						 SELECT 
						/* 
						 * INCOMING CALLS
						 * */
						 to_char(CDR.CALL_START_DATETIME, 'YYYY-MM') u_month
						   ,CALLED_PARTY_NUMBER_NP BID
						   ,E.ACCOUNT_NO 
						   ,E.SUBSCR_NO
						   ,CASE WHEN E.EXTERNAL_ID_TYPE = 1 THEN 'MOBILE'
						   		WHEN E.EXTERNAL_ID_TYPE = 9 THEN 'LANDLINE'
						   		WHEN E.EXTERNAL_ID_TYPE = 37 THEN 'FIBRE'
						   	END SERVICE_TYPE
						   	,acv.DISPLAY_VALUE cust_type
						   ,0 O_ELAPSED_TIME
						   ,DURATION I_ELAPSED_TIME
						 FROM 
						 	ATNI_PROD.GTT_REPORTING.AIRSPAN_CDR CDR
						 	LEFT JOIN ATNI_PROD.GTT_REPORTING.EXTERNAL_ID_EQUIP_MAP_EXTRACT E
							 	  ON E.EXTERNAL_ID = CDR.CALLED_PARTY_NUMBER_NP AND date(E.EXTRACT_FILE_DATE) = date(current_date) AND E.IS_CURRENT = 1
							JOIN ATNI_PROD.GTT_REPORTING.CMF_EXTRACT c
						   ON E.ACCOUNT_NO = C.ACCOUNT_NO AND date(c.EXTRACT_FILE_DATE) = date(current_date)
						   join ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES acv on c.account_category = acv.account_category and acv.SERVICE_VERSION_ID = (select max(SERVICE_VERSION_ID) from ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES)
						 WHERE 
						 date(CALL_START_DATETIME)	>= ADD_MONTHS(CURRENT_date, -13)
						 AND DURATION > 0
						  --AND concat('592',CDR.TERMINATING_NUMBER) = '5922750261'
						 AND E.EXTERNAL_ID_TYPE IN (1,9,37)
						 AND (SUBSTRING(CALLED_PARTY_NUMBER_NP,1,6) IN (SELECT DISTINCT PREFIX_LONG FROM ATNI_PROD.GTT_REPORTING.GTT_PREFIXES)
						     OR SUBSTRING(CALLED_PARTY_NUMBER_NP,1,4) = '5925' -- Blaze calls
						     OR SUBSTRING(CALLED_PARTY_NUMBER_NP,1,6) IN (SELECT distinct PREFIX FROM ATNI_DEV.GTT_REPORTING.EXCHANGE_NAMES) -- LANDLINE_INTER 
						 )
				
				 	) AIR
				 	GROUP BY 1,2,3,4,5, 6
				 	
				),
	---------Merge with scorecard data for segmentation			
	SCORECARD_RECORDS (
						DATESTART_MONTH_ENDING
						,OPERATING_COMPANY_CODE
						,OPERATING_COMPANY_NAME 
						,ACCOUNTNUMBER
						,LINE_OF_SERVICE
						,SUBLINE_OF_SERVICE
						,SUBLINE_OF_SERVICE_SEGMENT
						,CUSTOMER_TYPE_NAME
						,BID
						,UNIT_COUNTABLE
						,REVENUE_COUNTABLE
						,OFFICIALLY_COUNTED_SUBSCRIBER
						,SYSTEMID
						,DATEIN
						,BEGINNING_ACTIVE
						, ENDING_ACTIVE
						, DEACTIVATIONS
						,REACTIVATIONS
						, NET_DEACTIVATIONS
						,ACTIVATIONS
						,NET_ACTIVATIONS
						,NET_SUSPENDS
						,ENDING_SUSPEND
						,ENDING_PENDING_DEACTIVATION
						,ENDING_PENDING_ACTIVE
						,BEGINNING_PENDING_ACTIVE
						, BEGINNING_PENDING_DEACTIVATION
					) AS 
	
	(SELECT DATEADD('DAY',-1,DATEADD('MONTH',1,DATE_TRUNC('MONTH',DATESTART)))AS DATESTART_MONTH_ENDING
							, SUB.OPERATING_COMPANY_CODE
							, SUB.OPERATING_COMPANY_NAME 
							, SUB.ACCOUNTNUMBER
							,LINE_OF_SERVICE
							,SUBLINE_OF_SERVICE
							,SUBLINE_OF_SERVICE_SEGMENT
							,CUSTOMER_TYPE_NAME
							, RTRIM(SUB.BID) AS BID
							, SUB.UNIT_COUNTABLE
							, SUB.REVENUE_COUNTABLE
							, SUB.OFFICIALLY_COUNTED_SUBSCRIBER
							, SUB.SYSTEMID
							, MIN(SUB.DATEIN) AS DATEIN
							--, SUB.DATASET_TYPE 
							, SUM(SUB.BEGINNING_ACTIVE) AS BEGINNING_ACTIVE
							, SUM(CASE WHEN DATE_TRUNC('MONTH',DATESTART)=DATE_TRUNC('MONTH',CURRENT_DATE) THEN BEGINNING_ACTIVE+NET_ACTIVATIONS
							      ELSE
							       SUB.ENDING_ACTIVE
							      END) AS ENDING_ACTIVE
							, SUM(SUB.DEACTIVATIONS) AS DEACTIVATIONS
							, SUM(SUB.REACTIVATIONS) AS REACTIVATIONS
							, SUM(SUB.NET_DEACTIVATIONS) AS NET_DEACTIVATIONS
							, SUM(SUB.ACTIVATIONS) AS ACTIVATIONS
							, SUM(SUB.NET_ACTIVATIONS) AS NET_ACTIVATIONS
							, SUM(SUB.NET_SUSPENDS) AS NET_SUSPENDS
							, SUM(SUB.ENDING_SUSPEND) AS ENDING_SUSPEND
							, SUM(SUB.ENDING_PENDING_DEACTIVATION) AS ENDING_PENDING_DEACTIVATION
							, SUM(SUB.ENDING_PENDING_ACTIVE) AS ENDING_PENDING_ACTIVE
							, SUM(SUB.BEGINNING_PENDING_ACTIVE) AS BEGINNING_PENDING_ACTIVE
							, SUM(SUB.BEGINNING_PENDING_DEACTIVATION) AS BEGINNING_PENDING_DEACTIVATION
						FROM ATNI_PROD.ATNI_ANALYTICS.SUBSCRIBER_BG_END_WEEKLY_MONTHLY_SNAPSHOT_DAILYACTIVITY SUB
						WHERE SUB.DATASET_TYPE = 'END_MONTHLY_SNAPSHOT'-- IN ('BG_MONTHLY_SNAPSHOT','END_MONTHLY_SNAPSHOT', 'DAILY_SUB_ACTIVITY')
							AND SUB.OPERATING_COMPANY_CODE = 1 --GTT
							AND SUB.OFFICIALLY_COUNTED_SUBSCRIBER = 'yes'
							AND SUBLINE_OF_SERVICE_SEGMENT IN ('Regular Postpaid Landline Phone','GPON','DSL')
						GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13
						
					
	)
				SELECT 
				   SR.D_MONTH
					,SR.CUSTOMER_TYPE_NAME
					,SR.LINE_OF_SERVICE
					,SR.SUBLINE_OF_SERVICE
					,SR.SUBLINE_OF_SERVICE_SEGMENT
					,CU.Voice_usage_count
					, SR.END_ACTIVE
					, SR. BILLED_COUNT
					, CU.DURATION_SEC Voice_usage_count_in_and_out
				FROM 
				
				 (SELECT 
							u_month d_month -- Month of usage
							,BID -- Service phone number
							,ACCOUNT_NO -- ACCOUNT number OF service
							,SUBSCR_NO -- subscriber number OF service
							--,SERVICE_TYPE -- TYPE OF service
							--,cust_type ACCOUNT_TYPE --- TYPE OF ACCOUNT
							,count(DISTINCT BID) Voice_usage_count -- count OF voice USAGE subscriber per month
							,sum(DURATION_SEC) DURATION_SEC -- total incoming AND outgoing calls
							,sum(outgoing) OUTGOING_SEC -- total outgoing calls
							,sum(incoming) INCOMING_SEC -- total incoming calls
						FROM 
							(
								SELECT * FROM AIRSPAN_RECORDS
								  UNION ALL
								SELECT * FROM GEN_RECORDS
							) ALL_ACTIVITIES
						GROUP BY 1,2,3,4
						ORDER BY 1
				) CU
				LEFT JOIN (
					SELECT 
					   to_char(SC.DATESTART_MONTH_ENDING, 'YYYY-MM') AS D_MONTH
					   ,SC.CUSTOMER_TYPE_NAME
					   ,SC.BID
					   ,SC.ACCOUNTNUMBER
					   ,SC.LINE_OF_SERVICE
					   ,SC.SUBLINE_OF_SERVICE
					   ,SC.SUBLINE_OF_SERVICE_SEGMENT
					   , sum(ENDING_ACTIVE) END_ACTIVE
						, count(DISTINCT BR.ACCOUNTNUMBER) BILLED_COUNT
					FROM 
						SCORECARD_RECORDS SC
						LEFT JOIN ( 
								SELECT 
									DISTINCT 
									date_trunc('MONTH', ADD_MONTHS(DATESTART_MONTH_ENDING, -1)) DATESTART_MONTH_ENDING,
									nvl(BID,'')BID  ,
									ACCOUNTNUMBER 
								FROM  
									ATNI_DEV.GTT_REPORTING.SV_GTT_BILLED_REVENUE
								WHERE 
									date(DATESTART_MONTH_ENDING) >= ADD_MONTHS(CURRENT_date, -14)
								) BR 
					ON SC.ACCOUNTNUMBER =  BR.ACCOUNTNUMBER AND SC.BID = BR.BID AND date_trunc('MONTH',SC.DATESTART_MONTH_ENDING) = date_trunc('MONTH',BR.DATESTART_MONTH_ENDING)
					
			WHERE 
				SC.ENDING_ACTIVE = 1
				AND SC.REVENUE_COUNTABLE=1
			GROUP BY 1,2,3,4,5,6,7		
				)			
				SR  
				ON SR.ACCOUNTNUMBER = CU.ACCOUNT_NO AND SR.BID = CU.BID AND SR.d_month = CU.d_month