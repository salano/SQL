SELECT
CASE WHEN A.SYSTEMID = 8 THEN 'Wireline'
WHEN A.SYSTEMID = 12 THEN 'DSL'
WHEN A.SYSTEMID = 15 THEN 'Leased Line'
WHEN A.SYSTEMID = 17 THEN 'Calling Card'
WHEN A.SYSTEMID = 18 THEN 'WiMax'
WHEN A.SYSTEMID = 22 THEN 'Interconnect'
WHEN A.SYSTEMID = 24 THEN 'GPON'
WHEN A.SYSTEMID = 4 THEN 'Mobile'
END PRODUCT,
date(EXTRACT_FILE_DATE) EXTRACT_FILE_DATE,
count(CASE WHEN statement_to_email LIKE '%_@__%.__%' THEN 1 END) Valid_statement_email,
count(CASE WHEN  
	(statement_to_email not LIKE '%_@__%.__%' AND statement_to_email IS NOT NULL)  THEN 1 END) Invalid_statement_email,
count(CASE WHEN statement_to_email IS null THEN 1 END) Empty_statement_email,

count(CASE WHEN
((LEFT(CONTACT1_PHONE, 1) = '6' OR LEFT(CONTACT2_PHONE, 1) = '6') AND (LEN(CONTACT1_PHONE) = 7 OR LEN(CONTACT2_PHONE) = 7))
OR ((LEFT(CONTACT1_PHONE, 4) = '5926' OR LEFT(CONTACT2_PHONE, 4) = '5926') AND (LEN(CONTACT1_PHONE) = 10 OR LEN(CONTACT2_PHONE) = 10))

THEN 1 END) Valid_contact_no,
count(CASE WHEN CONTACT1_PHONE IS null AND CONTACT2_PHONE IS NULL THEN 1 END) Empty_contact_no,
count(1) sub_count

FROM
SC_INPUT.ODSSUBSCRIBERSNAPSHOT A
INNER JOIN SC_OUTPUT.DIMPRODUCT B ON
A.RATEPLANCODE::STRING = B.PRODUCTCODE
--AND B.LEAFLEVELNAME ='Mobile Prepaid Combo'
AND B.SOURCESYSTEMID = 1
AND B.REVENUECOUNTABLE = 1
INNER JOIN GTT_REPORTING.GTT_SAA_SUBSCRIBER_FEED_DETAIL C ON ---GET SUBSCR_NO
A.ACCOUNTNUMBER=C.ACCOUNTNUMBER AND A.BID=C.BID
AND C.DATESTART = current_Date()-1
LEFT JOIN GTT_REPORTING.CMF_EXTRACT D ON A.ACCOUNTNUMBER = D.ACCOUNT_NO
LEFT JOIN GTT_REPORTING.BILL_DISP_METH_VALUES F ON D.BILL_DISP_METH = F.BILL_DISP_METH
WHERE
--date(EXTRACT_FILE_DATE) BETWEEN to_date('2021-09-19','YYYY-MM-DD') AND to_date('2021-09-20','YYYY-MM-DD')
A.SOURCESYSTEMID = 1
AND A.DATESTART = current_Date()-1
--AND A.SYSTEMID <> 4
--AND date(D.created_date) = current_Date()
AND A.STATUSCODE NOT IN('D','P')
AND A.CUSTOMERTYPE NOT IN(12, 8)
AND date(D.EXTRACT_FILE_DATE) IN
(
select *
FROM
(
select
dateadd(day, '-' || seq4(), current_date()) as dte
from
table
(generator(rowcount => 1095))
)q
where dayname(dte)='Sun'
AND date(dte) between date_trunc('YEAR', CURRENT_DATE() ) and date(current_date)
ORDER BY 1 desc
)
AND (STATEMENT_TO_EMAIL NOT LIKE '%@gtt.co.gy' OR STATEMENT_TO_EMAIL IS NULL) 
GROUP BY
2,1
ORDER BY 2,1 descs