SELECT 
    DISTINCT 
	a.SID,
	CONCAT('592',c.PHONE_NUMBER) PHONE_NUMBER,
	E.ACCOUNT_NO,
	b.*
FROM 
	(
		SELECT 
			a1.SID,
			IFF(substr(a1.CONTACT_NUMBER,1,3) !='592', concat('592',a1.CONTACT_NUMBER) ,a1.CONTACT_NUMBER) CONTACT_NUMBER
		FROM  
			ATNI_PROD.GTT_REPORTING.VW_GTT_WEBSITE_LANDLINE_AND_BROADBAND_APPLICATION_SUBMISSION_V2 a1
		 JOIN (SELECT CONTACT_NUMBER, max(SUBMITTED) SUBMITTED FROM  ATNI_PROD.GTT_REPORTING.VW_GTT_WEBSITE_LANDLINE_AND_BROADBAND_APPLICATION_SUBMISSION_V2 GROUP BY 1) a2
			ON a1.CONTACT_NUMBER = a2.CONTACT_NUMBER AND a1.SUBMITTED = a2.SUBMITTED
		WHERE SERVICES_APPLYING_FOR IN ('dsl_only', 'dsl_landline')
	) a
RIGHT JOIN
	ATNI_DEV.GTT_REPORTING.DSL_FIBRE_NUMBERS_TMP b 
	ON trim(a.CONTACT_NUMBER) = trim(b.Contact)
LEFT JOIN  ATNI_PROD.GTT_REPORTING.DSL_DUMPS_DNS_RAW c 
	ON upper(b.CustomerName) = upper(c.FULL_NAME)  AND date(c.dump_ts) = date(CURRENT_DATE())
LEFT JOIN GTT_REPORTING.EXTERNAL_ID_EQUIP_MAP_EXTRACT E
						ON CONCAT('592',c.PHONE_NUMBER)  = E.EXTERNAL_ID  AND date(E.EXTRACT_FILE_DATE) = date(current_date) 