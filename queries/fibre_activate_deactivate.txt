SELECT 
  DISTINCT 
  min(SUB.ACT_DATE) OVER (PARTITION BY SUB.ACCOUNTNUMBER, SUB.BID ) AS ACTIVATE_DATE,
  FIRST_VALUE(O.DISPLAY_VALUE) OVER (PARTITION BY SUB.ACCOUNTNUMBER, SUB.BID ORDER BY  SUB.ACCOUNTNUMBER, SUB.BID) AS ACTIVATE_SERVICE,
  LAST_VALUE(SUB.DEACT_DATE) OVER (PARTITION BY SUB.ACCOUNTNUMBER, SUB.BID ORDER BY  SUB.ACCOUNTNUMBER, SUB.BID) AS DEACTIVATE_DATE,
  LAST_VALUE(O.DISPLAY_VALUE) OVER (PARTITION BY SUB.ACCOUNTNUMBER, SUB.BID ORDER BY  SUB.ACCOUNTNUMBER, SUB.BID) AS DEACTIVATE_SERVICE,
  CASE WHEN SUB.STATUSCODE =  'A' THEN 'NO' WHEN SUB.STATUSCODE =  'D' THEN 'YES'  ELSE 'UNKNOWN' END DEACTIVATED,
  SUB.ACCOUNTNUMBER,
  SUB.BID,
  SUB.FIRSTNAME,
  SUB.LASTNAME,
  SUB.COMPANYNAME
FROM 

	(
	SELECT
			distinct
			a.DATEIN AS ACT_DATE,
			--ifNULL(b.DATEOUT, a.DATESTART) AS DEACT_DATE,
			b.DATEOUT AS DEACT_DATE,
			a.ACCOUNTNUMBER,
			a.BID,
			a.FIRSTNAME,
			a.LASTNAME,
			a.COMPANYNAME,
			b.STATUSCODE 
			--a.PRODUCT_NAME,
			--abs(a.DEACTIVATIONS) DEACTIVATIONS
			FROM
			ATNI_PROD.ATNI_ANALYTICS.SUBSCRIBER_BG_END_WEEKLY_MONTHLY_SNAPSHOT_DAILYACTIVITY a 
			 LEFT JOIN ATNI_PROD.SC_INPUT.ODSSUBSCRIBERSNAPSHOT b 
			 	ON a.ACCOUNTNUMBER = b.ACCOUNTNUMBER  AND a.BID = b.BID AND b.SOURCESYSTEMID=1
			WHERE
			a.DATASET_TYPE='DAILY_SUB_ACTIVITY'
			AND a.SYSTEMID=24
			AND a.OFFICIALLY_COUNTED_SUBSCRIBER='yes'
			--AND a.DEACTIVATIONS<>0
			AND a.DATESTART <= '2021-12-31'	
			AND  date(b.DATESTART) = date(current_date) -1
			
		) sub 
		
		left join
		    (SELECT distinct offer_id, ACCOUNT_NO, SUBSCR_NO,disconnect_reason, INACTIVE_DT FROM  ATNI_PROD.GTT_REPORTING.OFFER_INST WHERE  offer_id IN (
										SELECT
										try_TO_NUMERIC(REPLACE(PRODUCTCODE,'MP',''))
										FROM
										ATNI_PROD.SC_OUTPUT.DIMPRODUCT
										WHERE
										LEAFLEVELNAME='Internet'
										AND SOURCESYSTEMID=1
										AND PRODUCTCODE LIKE 'MP%'
									)  )   ins
		    
		    
		        on sub.ACCOUNTNUMBER = ins.ACCOUNT_NO --and date(sub.DEACT_DATE) = date(ins.INACTIVE_DT) 
		       left JOIN
				ATNI_PROD.GTT_REPORTING.OFFER_VALUES O ON ins.OFFER_ID=O.OFFER_ID AND RESELLER_VERSION_ID IN(SELECT MAX(RESELLER_VERSION_ID) FROM ATNI_PROD.GTT_REPORTING.OFFER_VALUES)
WHERE 
	upper(O.DISPLAY_VALUE) LIKE '%BIZ%'
	
ORDER BY 
	SUB.ACCOUNTNUMBER,
    SUB.BID