SELECT 
		DISTINCT 
		to_char(X.DATESTART_MONTH_ENDING, 'YYYY-MM') AS D_MONTH
		,X.CUSTOMER_TYPE_NAME
		,X.LINE_OF_SERVICE
		,X.SUBLINE_OF_SERVICE
		,X.SUBLINE_OF_SERVICE_SEGMENT
		, count(CASE WHEN  USD.RAWDURATION > 0 THEN 1 END) SUB_COUNT
		, sum(ENDING_ACTIVE) END_ACTIVE
		, count(DISTINCT BR.ACCOUNTNUMBER) BILLED_COUNT
	FROM 
		(	SELECT DATEADD('DAY',-1,DATEADD('MONTH',1,DATE_TRUNC('MONTH',DATESTART))) AS DATESTART_MONTH_ENDING
				, SUB.OPERATING_COMPANY_CODE
				, SUB.OPERATING_COMPANY_NAME 
				, SUB.ACCOUNTNUMBER
				,LINE_OF_SERVICE
				,SUBLINE_OF_SERVICE
				,SUBLINE_OF_SERVICE_SEGMENT
				,CUSTOMER_TYPE_NAME
				, RTRIM(SUB.BID) AS BID
				, SUB.UNIT_COUNTABLE
				, SUB.REVENUE_COUNTABLE
				, SUB.OFFICIALLY_COUNTED_SUBSCRIBER
				, SUB.SYSTEMID
				, MIN(SUB.DATEIN) AS DATEIN
				--, SUB.DATASET_TYPE 
				, SUM(SUB.BEGINNING_ACTIVE) AS BEGINNING_ACTIVE
				, SUM(CASE WHEN DATE_TRUNC('MONTH',DATESTART)=DATE_TRUNC('MONTH',CURRENT_DATE) THEN BEGINNING_ACTIVE+NET_ACTIVATIONS
				      ELSE
				       SUB.ENDING_ACTIVE
				      END) AS ENDING_ACTIVE
				, SUM(SUB.DEACTIVATIONS) AS DEACTIVATIONS
				, SUM(SUB.REACTIVATIONS) AS REACTIVATIONS
				, SUM(SUB.NET_DEACTIVATIONS) AS NET_DEACTIVATIONS
				, SUM(SUB.ACTIVATIONS) AS ACTIVATIONS
				, SUM(SUB.NET_ACTIVATIONS) AS NET_ACTIVATIONS
				, SUM(SUB.NET_SUSPENDS) AS NET_SUSPENDS
				, SUM(SUB.ENDING_SUSPEND) AS ENDING_SUSPEND
				, SUM(SUB.ENDING_PENDING_DEACTIVATION) AS ENDING_PENDING_DEACTIVATION
				, SUM(SUB.ENDING_PENDING_ACTIVE) AS ENDING_PENDING_ACTIVE
				, SUM(SUB.BEGINNING_PENDING_ACTIVE) AS BEGINNING_PENDING_ACTIVE
				, SUM(SUB.BEGINNING_PENDING_DEACTIVATION) AS BEGINNING_PENDING_DEACTIVATION
			FROM ATNI_PROD.ATNI_ANALYTICS.SUBSCRIBER_BG_END_WEEKLY_MONTHLY_SNAPSHOT_DAILYACTIVITY SUB
			WHERE SUB.DATASET_TYPE = 'END_MONTHLY_SNAPSHOT'-- IN ('BG_MONTHLY_SNAPSHOT','END_MONTHLY_SNAPSHOT', 'DAILY_SUB_ACTIVITY')
				AND SUB.OPERATING_COMPANY_CODE = 1 --GTT
				AND SUB.OFFICIALLY_COUNTED_SUBSCRIBER = 'yes'
			GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13
			
		)X
		LEFT JOIN (
				SELECT 
				   DISTINCT 
				   date_trunc('MONTH',DATESTART) DATESTART,
				   EXTERNAL_ID,
				   ACCOUNT_NO,
				   --SUBSCR_NO,
				   sum(RAWDURATION) RAWDURATION
				FROM 
					ATNI_PROD.GTT_REPORTING.SV_GTT_RAA_USAGE_DETAIL
				WHERE 
					date(DATESTART) >= ADD_MONTHS(CURRENT_date, -14)
				GROUP BY 1,2,3
		
		
		) USD 
		ON date_trunc('MONTH',X.DATESTART_MONTH_ENDING) = date_trunc('MONTH',USD.DATESTART) AND X.ACCOUNTNUMBER = USD.ACCOUNT_NO AND X.BID = USD.EXTERNAL_ID
		LEFT JOIN ( 
					SELECT 
						DISTINCT 
						date_trunc('MONTH', ADD_MONTHS(DATESTART_MONTH_ENDING, -1)) DATESTART_MONTH_ENDING,
						nvl(BID,'')BID  ,
						ACCOUNTNUMBER 
					FROM  
						ATNI_DEV.GTT_REPORTING.SV_GTT_BILLED_REVENUE
					WHERE 
						date(DATESTART_MONTH_ENDING) >= ADD_MONTHS(CURRENT_date, -14)
					) BR 
		ON X.ACCOUNTNUMBER =  BR.ACCOUNTNUMBER AND X.BID = BR.BID AND date_trunc('MONTH',X.DATESTART_MONTH_ENDING) = date_trunc('MONTH',BR.DATESTART_MONTH_ENDING)
		
WHERE 
	X.ENDING_ACTIVE = 1
	AND X.REVENUE_COUNTABLE=1
GROUP BY 1,2,3,4,5
ORDER BY 1, 2,3,4 desc