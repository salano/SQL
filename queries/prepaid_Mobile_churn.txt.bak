SELECT 
	DISTINCT
	ACCOUNTNUMBER,
	BID,
    IFF(Y.Last_charge_event > X.DEACTIVED_DATE, NULL ,X.DEACTIVED_DATE) DEACTIVED_DATE,
    IFF(Y.Last_charge_event > X.DEACTIVED_DATE, 0,1) churn
FROM 
	(

		SELECT 
		 
			score.ACCOUNTNUMBER,
			score.BID,
			sum(score.NET_DEACTIVATIONS) OVER 
							  			(PARTITION BY score.ACCOUNTNUMBER,score.BID ORDER BY score.NET_DEACTIVATIONS
							  			RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
							  			) AS churn,
			max(score.DEACT_DATE) OVER 
							  			(PARTITION BY score.ACCOUNTNUMBER,score.BID ORDER BY score.DEACT_DATE
							  			RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
							  			) AS DEACTIVED_DATE
			FROM 
			(
			SELECT
					distinct
					a.DATESTART ,
					ifNULL(b.DATEOUT, a.DATESTART) AS DEACT_DATE,
					a.BID,
					a.ACCOUNTNUMBER, 
					a.BEGINNING_ACTIVE,
					a.NET_ACTIVATIONS,
					a.NET_DEACTIVATIONS,
					a.ENDING_ACTIVE 
					FROM
					ATNI_PROD.ATNI_ANALYTICS.SUBSCRIBER_BG_END_WEEKLY_MONTHLY_SNAPSHOT_DAILYACTIVITY a 
					 LEFT JOIN ATNI_PROD.SC_INPUT.ODSSUBSCRIBERSNAPSHOT b 
					 	ON a.DATESTART = b.DATESTART AND a.ACCOUNTNUMBER = b.ACCOUNTNUMBER  AND a.BID = b.BID AND b.SOURCESYSTEMID=1
					WHERE
					a.SOURCESYSTEMID=1
					AND SUBLINE_OF_SERVICE IN ('Mobile Prepaid')
					AND a.UNIT_COUNTABLE=1
					AND a.REVENUE_COUNTABLE=1
					AND a.DATASET_TYPE IN('BG_MONTHLY_SNAPSHOT', 'END_MONTHLY_SNAPSHOT', 'DAILY_SUB_ACTIVITY')
					--AND date(a.DATESTART) BETWEEN to_date('2021-01-01','YYYY-MM-DD') AND to_date('2021-12-31','YYYY-MM-DD')
							
			) score
			WHERE date(score.DEACT_DATE)  < ADD_MONTHS(current_date, -3)
		) X
		LEFT JOIN 
		( 
			SELECT 
				DISTINCT 
					CD.ACCOUNT_NO 
					,CD.EXTERNAL_ID 
					,max(CD.TRANS_DT) OVER 
					  			(PARTITION BY CD.ACCOUNT_NO ,CD.EXTERNAL_ID ORDER BY CD.TRANS_DT 
					  			RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
					  			) AS Last_charge_event
				FROM 
					GTT_REPORTING.CDR_DATA CD

				WHERE 
					CD.EXTERNAL_ID_TYPE=1
					AND DATE(CD.TRANS_DT) >= ADD_MONTHS(current_date, -12)
					AND CD.CHARGED_AMOUNT > 0
		
		)Y
		ON X.ACCOUNTNUMBER = Y.ACCOUNT_NO AND X.BID = Y.EXTERNAL_ID
	WHERE churn > 0
	AND ACCOUNTNUMBER = '17481558'
	AND BID = '5926540706'