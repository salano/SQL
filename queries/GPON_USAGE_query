SELECT  
	MSIDN AS Subscriber,
	to_char(DATE_PERIOD, 'YYYY-MM') usage_month,
	round(sum(CASE WHEN upper(PROTOCOL) LIKE '%FACEBOOK%' THEN total_received_bytes /1024/1024 END)) FACEBOOK_SERVICES_RECEIVED,
	round(sum(CASE WHEN upper(PROTOCOL) LIKE '%FACEBOOK%' THEN total_transmitted_bytes /1024/1024 END)) FACEBOOK_SERVICES_TRANSMITTED,
	round(sum(CASE WHEN upper(PROTOCOL) LIKE '%FACEBOOK%' THEN total_bytes /1024/1024 END)) FACEBOOK_SERVICES_TOTAL,
	round(count(CASE WHEN upper(PROTOCOL) LIKE '%FACEBOOK%' THEN total_new_connections END)) FACEBOOK_connections,
	
	round(sum(CASE WHEN upper(PROTOCOL) LIKE '%GOOGLE%' THEN total_received_bytes /1024/1024 END)) GOOGLE_SERVICES_RECEIVED,
	round(sum(CASE WHEN upper(PROTOCOL) LIKE '%GOOGLE%' THEN total_transmitted_bytes /1024/1024 END)) GOOGLE_SERVICES_TRANSMITTED,
	round(sum(CASE WHEN upper(PROTOCOL) LIKE '%GOOGLE%' THEN total_bytes /1024/1024 END)) GOOGLE_SERVICES_TOTAL,
	round(count(CASE WHEN upper(PROTOCOL) LIKE '%GOOGLE%' THEN total_new_connections END)) GOOGLE_connections,
	
	round(sum(CASE WHEN upper(PROTOCOL) LIKE '%WHATSAPP%' THEN total_received_bytes /1024/1024 END)) WHATSAPP_SERVICES_RECEIVED,
	round(sum(CASE WHEN upper(PROTOCOL) LIKE '%WHATSAPP%' THEN total_transmitted_bytes /1024/1024 END)) WHATSAPP_SERVICES_TRANSMITTED,
	round(sum(CASE WHEN upper(PROTOCOL) LIKE '%WHATSAPP%' THEN total_bytes /1024/1024 END)) WHATSAPP_SERVICES_TOTAL,
	round(count(CASE WHEN upper(PROTOCOL) LIKE '%WHATSAPP%' THEN total_new_connections END)) WHATSAPP_connections,
	
	round(sum(CASE WHEN upper(PROTOCOL) LIKE '%YOUTUBE%' THEN total_received_bytes /1024/1024 END)) YOUTUBE_SERVICES_RECEIVED,
	round(sum(CASE WHEN upper(PROTOCOL) LIKE '%YOUTUBE%' THEN total_transmitted_bytes /1024/1024 END)) YOUTUBE_SERVICES_TRANSMITTED,
	round(sum(CASE WHEN upper(PROTOCOL) LIKE '%YOUTUBE%' THEN total_bytes /1024/1024 END)) YOUTUBE_SERVICES_TOTAL,
	round(count(CASE WHEN upper(PROTOCOL) LIKE '%YOUTUBE%' THEN total_new_connections END)) YOUTUBE_connections,
	
	round(sum(CASE WHEN upper(PROTOCOL) LIKE '%NETFLIX%' THEN total_received_bytes /1024/1024 END)) NETFLIX_SERVICES_RECEIVED,
	round(sum(CASE WHEN upper(PROTOCOL) LIKE '%NETFLIX%' THEN total_transmitted_bytes /1024/1024 END)) NETFLIX_SERVICES_TRANSMITTED,
	round(sum(CASE WHEN upper(PROTOCOL) LIKE '%NETFLIX%' THEN total_bytes /1024/1024 END)) NETFLIX_SERVICES_TOTAL,
	round(count(CASE WHEN upper(PROTOCOL) LIKE '%NETFLIX%' THEN total_new_connections END)) NETFLIX_connections,
	
	
	round(sum(CASE WHEN upper(PROTOCOL) LIKE '%FACEBOOK%' THEN total_received_bytes /1024/1024 END)) FACEBOOK_SERVICES_RECEIVED,
	round(sum(CASE WHEN upper(PROTOCOL) LIKE '%FACEBOOK%' THEN total_transmitted_bytes /1024/1024 END)) FACEBOOK_SERVICES_TRANSMITTED,
	round(sum(CASE WHEN upper(PROTOCOL) LIKE '%FACEBOOK%' THEN total_bytes /1024/1024 END)) FACEBOOK_SERVICES_TOTAL,
	round(count(CASE WHEN upper(PROTOCOL) LIKE '%FACEBOOK%' THEN total_new_connections END)) FACEBOOK_connections,
	
	
	round(sum(CASE WHEN upper(PROTOCOL) NOT LIKE '%FACEBOOK%' OR  upper(PROTOCOL) NOT LIKE '%GOOGLE%' OR  upper(PROTOCOL) NOT LIKE '%WHATSAPP%' OR  upper(PROTOCOL) NOT LIKE '%YOUTUBE%' OR  upper(PROTOCOL) NOT LIKE '%NETFLIX%' THEN total_received_bytes /1024/1024 END)) OTHER_SERVICES_RECEIVED,
	round(sum(CASE WHEN upper(PROTOCOL) NOT LIKE '%FACEBOOK%' OR  upper(PROTOCOL) NOT LIKE '%GOOGLE%' OR  upper(PROTOCOL) NOT LIKE '%WHATSAPP%' OR  upper(PROTOCOL) NOT LIKE '%YOUTUBE%' OR  upper(PROTOCOL) NOT LIKE '%NETFLIX%'  THEN total_transmitted_bytes /1024/1024 END)) OTHER_SERVICES_TRANSMITTED,
	round(sum(CASE WHEN upper(PROTOCOL) NOT LIKE '%FACEBOOK%' OR  upper(PROTOCOL) NOT LIKE '%GOOGLE%' OR  upper(PROTOCOL) NOT LIKE '%WHATSAPP%' OR  upper(PROTOCOL) NOT LIKE '%YOUTUBE%' OR  upper(PROTOCOL) NOT LIKE '%NETFLIX%'  THEN total_bytes /1024/1024 END)) OTHER_SERVICES_TOTAL,
	round(count(CASE WHEN upper(PROTOCOL) NOT LIKE '%FACEBOOK%' OR  upper(PROTOCOL) NOT LIKE '%GOOGLE%' OR  upper(PROTOCOL) NOT LIKE '%WHATSAPP%' OR  upper(PROTOCOL) NOT LIKE '%YOUTUBE%' OR  upper(PROTOCOL) NOT LIKE '%NETFLIX%'  THEN total_new_connections END)) OTHER_connections
FROM 

	ATNI_PROD.CDR.GTT_SANDVINE_WIRELINE	
WHERE 
	DATE(DATE_PERIOD) BETWEEN '2021-01-31'::date AND '2021-05-31'::date

GROUP BY 
	MSIDN,
	to_char(DATE_PERIOD, 'YYYY-MM')