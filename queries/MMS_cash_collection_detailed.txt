SELECT
DISTINCT
GL_ACC_NUMBER,
GL_ACC_DESCRIPTION,
PRD_TYPE,
PRD_TYPE_DESCRIPTION,
MAS_RAW AS "MAS RAW",
NS_ID AS "NS ID",
NS_DEPT AS "NS DEPT",
TO_CHAR(DATE(DATE_SOLD),'YYYY-MM-DD') AS "MAS DATE", 
'CR' AS "MAS EXP TYPE",
NULL AS "MAS NUM",
NULL AS KILL,
'CR' AS "TYPE",
CASE
WHEN BRANCH='55 BRICKDAM' THEN '55 BDAM Collections'
WHEN BRANCH='79 BRICKDAM' THEN '79 BDAM Collections'
WHEN BRANCH='6 STRAND' THEN 'New Amsterdam Collections'
WHEN BRANCH='69 BRICKDAM' THEN 'Gov''t Account Collections'
WHEN BRANCH='ANNA REGINA' THEN 'Anna Regina Collections'
WHEN BRANCH='BETERVERWAGTING' THEN 'BV Collections'
WHEN BRANCH='CAMP AND ROBB STREET RETAIL STORE' THEN 'Camp & Robb Street Collections'
WHEN BRANCH='FOGARTY''S' THEN 'Fogarty''s Collections'
WHEN BRANCH='FOGARTYS' THEN 'Fogarty''s Collections'
WHEN BRANCH='FRANCHISE - CORRIVERTON' THEN 'Franchise - Corriverton Collections'
WHEN BRANCH='FRANCHISE - NEW AMSTERDAM' THEN 'Franchise - New Amsterdam Collections'
WHEN BRANCH='GIFTLAND KIOSK' THEN 'Giftland Kiosk Collections'
WHEN BRANCH='GIFTLAND RETAIL STORE' THEN 'Giftland Retail Store Collections'
WHEN BRANCH='STREET FAIRS' THEN 'Mobile Sales Collections'
WHEN BRANCH='YURABALLI ST' THEN 'Linden Collections'
ELSE
BRANCH
END AS NOTE,
CASE
 WHEN CREDIT IS NOT NULL THEN -1*(CREDIT)
 WHEN DEBIT IS NOT NULL THEN DEBIT
 ELSE 
     NULL
END AS "END",
CREDIT,
DEBIT,
KIOSK_TRAN_STATUS
FROM(
	SELECT
    DATE_SOLD,
	GL_ACC_NUMBER,
	GL_ACC_DESCRIPTION,
	PRD_TYPE,
	PRD_TYPE_DESCRIPTION,
	BRANCH,
	TOTAL,
	CASE
	   WHEN TOTAL<=-1 AND DTYPE NOT IN('INVENTORY','COST_OF_GOODS') THEN ABS(TOTAL)
	   WHEN DTYPE='COST_OF_GOODS' THEN TOTAL 
	   ELSE
	      NULL
	END AS DEBIT,

	CASE
	   WHEN TOTAL>=1 AND DTYPE NOT IN('INVENTORY','COST_OF_GOODS') THEN ABS(TOTAL)
	   WHEN DTYPE='INVENTORY' THEN TOTAL
	   ELSE
	      NULL
	END AS CREDIT,
	KIOSK_TRAN_STATUS
	FROM(
		SELECT
		DATE(DATE_SOLD) AS DATE_SOLD,
		GL_ACC_NUMBER,
		GL_ACC_DESCRIPTION,
		PRD_TYPE,
		PRD_TYPE_DESCRIPTION,
		BRANCH,
		DTYPE,
		KIOSK_TRAN_STATUS,
		ROUND(SUM(TOTAL),2) AS TOTAL
		
		FROM(
			SELECT
			 DATE_SOLD,
			 GL_ACC_NUMBER,
			 GL_ACC_DESCRIPTION,
		     PRD_TYPE,
			 PRD_TYPE_DESCRIPTION,
			 TOTAL,
			 BRANCH,
			 DTYPE,
			 KIOSK_TRAN_STATUS
			FROM(
				SELECT
					DATE_SOLD,
					CASE
					   WHEN DEPARTMENT IS NOT NULL THEN DEPARTMENT
					   ELSE 
					      PRD_TYPE
					END AS PRD_TYPE,
					NVL(LINE_TOTAL_COST,0) AS TOTAL,
					BRANCH,
					'COST_OF_GOODS' AS DTYPE,
					NULL AS KIOSK_TRAN_STATUS
					FROM
					 (SELECT
					  DATE_SOLD,
					  BRANCH,
					  LINE_TOTAL_COST,
					  PRD_TYPE,
					  DEPARTMENT
					  FROM
					GTT_REPORTING.ALL_MMS_SALES
					  WHERE
					  DATE(DATE_SOLD) BETWEEN DATE_TRUNC('MONTH', DATE(CURRENT_DATE-1))  AND DATE(CURRENT_DATE-1)
					) C
				)  E
				INNER JOIN
				GTT_REPORTING.MMS_CIN_DESC_TBL B USING(PRD_TYPE)
				INNER JOIN
				GTT_REPORTING.MMS_GL_ACNT A ON A.GL_ACC_NUMBER=B.GL_COST_OF_GOODS
				
				UNION ALL
				---INVENTORY
				SELECT 
				DATE_SOLD,
				GL_ACC_NUMBER,
				GL_ACC_DESCRIPTION,
			    PRD_TYPE,
				PRD_TYPE_DESCRIPTION,
				TOTAL,
				BRANCH,
				DTYPE,
				KIOSK_TRAN_STATUS
				FROM(
					SELECT
					DATE_SOLD,
					CASE
					  WHEN DEPARTMENT IS NOT NULL THEN DEPARTMENT
					  ELSE 
					     PRD_TYPE
					END AS PRD_TYPE,
					NVL(LINE_TOTAL_COST,0) AS TOTAL,
					BRANCH,
					'INVENTORY' AS DTYPE,
					NULL AS KIOSK_TRAN_STATUS
					FROM
					(SELECT
					  DATE_SOLD,
					  BRANCH,
					  LINE_TOTAL_COST,
					  PRD_TYPE,
					  DEPARTMENT
					  FROM
					GTT_REPORTING.ALL_MMS_SALES
					  WHERE
					  DATE(DATE_SOLD) BETWEEN DATE_TRUNC('MONTH', DATE(CURRENT_DATE-1))  AND DATE(CURRENT_DATE-1)
					) C
				) AS I
				INNER JOIN
				GTT_REPORTING.MMS_CIN_DESC_TBL B USING(PRD_TYPE) 
				INNER JOIN
				GTT_REPORTING.MMS_GL_ACNT A ON A.GL_ACC_NUMBER=B.GL_INVENTORY
			
				UNION ALL
				--REVENUE
				SELECT
				DATE_SOLD,
			    CASE
				 WHEN GL_ACC_NUMBER='9997' THEN '30850.1210' 
				 ELSE
				 GL_ACC_NUMBER
				END AS GL_ACC_NUMBER ,
				GL_ACC_DESCRIPTION,
				PRD_TYPE,
				PRD_TYPE_DESCRIPTION,
				TOTAL,
				BRANCH,
				'REVENUE' AS DTYPE,
				 KIOSK_TRAN_STATUS
				FROM(
				SELECT
				DATE_SOLD,
				CASE
				WHEN DEPARTMENT IS NOT NULL THEN DEPARTMENT
				ELSE 
				  PRD_TYPE
				END AS PRD_TYPE,
				NVL(LINE_TOTAL,0) AS TOTAL,
				BRANCH,
				'REVENUE' AS DTYPE,
				 NULL AS KIOSK_TRAN_STATUS
				FROM
				(SELECT
				  DATE_SOLD,
				  BRANCH,
				  LINE_TOTAL,
				  PRD_TYPE,
				  DEPARTMENT
				  FROM
				GTT_REPORTING.ALL_MMS_SALES
				  WHERE
				  DATE(DATE_SOLD) BETWEEN DATE_TRUNC('MONTH', DATE(CURRENT_DATE-1))  AND DATE(CURRENT_DATE-1)
				) AS C
				) AS D
				INNER JOIN
				GTT_REPORTING.MMS_CIN_DESC_TBL B  USING(PRD_TYPE)
				INNER JOIN
				GTT_REPORTING.MMS_GL_ACNT A ON A.GL_ACC_NUMBER=B.GL_REVENUE
				UNION ALL
				------------------------------------KIOSK REVENUE---------------------------
				SELECT
				  DATE(EXTERNAL_TRAN_DTTM) AS DATE_SOLD,
				  F.GL_ACC_NUMBER,
				  F.GL_ACC_DESCRIPTION,
				  E.PRD_TYPE,
				  E.PRD_TYPE_DESCRIPTION,
				  LINE_AMT AS TOTAL,
				  EXTERNAL_TERMINAL_NM AS BRANCH,
				  'REVENUE' AS DTYPE,
                  STATUS_DESC AS KIOSK_TRAN_STATUS
				  FROM
				  GTT_REPORTING.EXTERNAL_TRAN A
                  LEFT JOIN 
                  GTT_REPORTING.EXTERNAL_TRAN_LINE B ON A.ID=B.TRAN_ID 
                  LEFT JOIN
                  GTT_REPORTING.CIN_IVEN C ON B.POS_INV_NBR=C.INV_NUMBER
                  LEFT JOIN 
                  GTT_REPORTING.MMS_CIN_DESC_TBL E ON C.PRD_TYPE=E.PRD_TYPE
                  LEFT JOIN 
                  GTT_REPORTING.MMS_GL_ACNT F ON GL_ACC_NUMBER=E.GL_REVENUE 
   				  WHERE
				  DATE(EXTERNAL_TRAN_DTTM) BETWEEN DATE_TRUNC('MONTH', DATE(CURRENT_DATE-1))  AND DATE(CURRENT_DATE-1)
				--TENDER
				UNION ALL
				SELECT
				TRAN_DATE,
				CASE
				  WHEN GL_ACCT='10090 1040' THEN '10090.1040'
				  ELSE
				     GL_ACCT
				END  GL_ACCT,
				GL_ACC_DESCRIPTION,
				DESC_F AS PRD_TYPE,
				DESC_F  AS PRD_TYPE_DESCRIPTION,
				NVL(TOTAL_SELLING,0) AS TOTAL,
				MBRC_NAME,
				'TENDER' AS DTYPE,
				NULL AS KIOSK_TRAN_STATUS
				FROM
				GTT_REPORTING.ALL_MMS_SALES_TEND A
				LEFT JOIN
				GTT_REPORTING.MMS_GL_ACNT B ON A.GL_ACCT=B.GL_ACC_NUMBER
				WHERE
				DATE(TRAN_DATE) BETWEEN DATE_TRUNC('MONTH', DATE(CURRENT_DATE-1))  AND DATE(CURRENT_DATE-1)
				UNION ALL
				SELECT
				DATE_SOLD,
				'10090.1040' AS GL_ACNT,
				'CASH' AS GL_ACC_DESCRIPTION,
				PRD_TYPE,
				TRANSACTION_TYPE AS PRD_TYPE_DESCRIPTION,
				NVL(LINE_TOTAL,0) AS TOTAL,
				BRANCH,
				'TENDER' AS DTYPE,
				 NULL AS KIOSK_TRAN_STATUS
				FROM
				GTT_REPORTING.ALL_MMS_SALES
				WHERE
				DATE(DATE_SOLD) BETWEEN DATE_TRUNC('MONTH', DATE(CURRENT_DATE-1))  AND DATE(CURRENT_DATE-1)
				AND TRANSACTION_TYPE='EMPLOYEE CHQ'
				--------- KIOSK TENDER------------------------
				UNION ALL 
				SELECT
				DATE(EXTERNAL_TRAN_DTTM) AS  TRAN_DATE,
				CASE 
                    WHEN UPPER(A.TENDER_TYP)='CASH' THEN '10090.1040'
                    WHEN UPPER(A.TENDER_TYP)='CREDIT' THEN '10090.1060'
                END AS  GL_ACC_NUMBER,
               	CASE 
                    WHEN UPPER(A.TENDER_TYP)='CASH' THEN 'CASH'
                    WHEN UPPER(A.TENDER_TYP)='CREDIT' THEN 'MASTERCARD/VISA'
                END AS  GL_ACC_DESCRIPTION,
                UPPER(TENDER_TYP) AS PRD_TYPE,
            	CASE 
                    WHEN UPPER(A.TENDER_TYP)='CASH' THEN 'CASH'
                    WHEN UPPER(A.TENDER_TYP)='CREDIT' THEN 'MASTERCARD/VISA'
                END  AS PRD_TYPE_DESCRIPTION,
				NVL(-1*TRAN_AMT,0) AS TOTAL,
				EXTERNAL_TERMINAL_NM AS MBRC_NAME,
				'TENDER' AS DTYPE,
				STATUS_DESC AS KIOSK_TRAN_STATUS
				FROM
				ATNI_PROD.GTT_REPORTING.EXTERNAL_TRAN A
                LEFT JOIN 
                ATNI_PROD.GTT_REPORTING.EXTERNAL_TRAN_LINE B ON A.ID=B.TRAN_ID 
				WHERE
				DATE(EXTERNAL_TRAN_DTTM) BETWEEN DATE_TRUNC('MONTH', DATE(CURRENT_DATE-1))  AND DATE(CURRENT_DATE-1)
				
				--TAX
				UNION ALL
				SELECT
				DATE(DATE_SOLD) AS DATE_SOLD,
				'20660.2800' AS GL_ACC_NUMBER,
				'TAX PAYABLE-VAT STANDARD' AS GL_ACC_DESCRIPTION,
				'TAX' AS PRD_TYPE,
				'TAX' AS PRD_TYPE_DESCRIPTION,
				CASE 
				  WHEN TAX_AMOUNT_1=0 AND TAX_AMOUNT_2<>0  THEN TAX_AMOUNT_2
				  ELSE
				     NVL(TAX_AMOUNT_1,0)
				END AS TAX,
				
				MBRC_NAME,
				'TAX' AS DTYPE,
				 NULL AS KIOSK_TRAN_STATUS
				FROM
				GTT_REPORTING.MMS_TRAN_HEADER_TAX A
				LEFT JOIN
				GTT_REPORTING.CSY_MBRC B ON B.MBRC_BRANCH=A.BRANCH_ID
				WHERE
				DATE(DATE_SOLD) BETWEEN DATE_TRUNC('MONTH', DATE(CURRENT_DATE-1))  AND DATE(CURRENT_DATE-1)
		
			)AS A
			GROUP BY 1,2,3,4,5,6,7,8
	  ) AS B
 ) AS C
 LEFT JOIN
 GTT_REPORTING.RD_FINANCE_NS_MAPPING D ON C.GL_ACC_NUMBER=D.MAS_RAW 
 WHERE
   GL_ACC_NUMBER NOT IN('9999','9998','10090.1165')
