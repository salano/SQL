SELECT 
    distinct
	A.*,
	E.SUBSCR_NO,
	C.OUTSTANDING_BALANCE,
	F.DISPLAY_VALUE DSL_ACCOUNT_STATUS,
	DD.INACTIVE_DATE DSL_INACTIVE_DT,
	max(G.TRANS_DATE) OVER (PARTITION BY G.ACCOUNT_NO) AS LAST_DSL_PAY_DATE,
	min(I.TRANS_DATE) OVER (PARTITION BY I.ACCOUNT_NO) AS FIRST_FIBRE_PAY_DATE
	
FROM 
	ATNI_DEV.GTT_REPORTING.TMP_FIBRE_DSL_CUSTOMERS A
	LEFT JOIN ATNI_DEV.GTT_REPORTING.SV_DSL_MAINTAINED_AFTER_FIBRE_UPGRADE B 
	ON A.ACCOUNTNUMBER = B.ACCOUNTNUMBER 
	LEFT JOIN ATNI_PROD.SALESFORCE.GTT_CRM_ACCOUNTS C 
	ON B.DSL_ACCOUNTNUMBER = C.ACCOUNTNUMBER 
	LEFT JOIN ATNI_PROD.GTT_REPORTING.EXTERNAL_ID_EQUIP_MAP_EXTRACT DD
	ON DD.ACCOUNT_NO = B.DSL_ACCOUNTNUMBER AND date(DD.EXTRACT_FILE_DATE) = date(CURRENT_DATE()) AND DD.EXTERNAL_ID_TYPE =11
	LEFT JOIN ATNI_PROD.GTT_REPORTING.SUBSCRIBER_STATUS_EXTRACT E 
	ON DD.SUBSCR_NO = E.SUBSCR_NO AND date(E.EXTRACT_FILE_DATE) = date(CURRENT_DATE())  AND E.INACTIVE_DT IS null
	JOIN ATNI_DEV.GTT_REPORTING.STATUS_VALUES F 
	ON F.STATUS_ID = E.STATUS_ID 
	LEFT JOIN ATNI_PROD.GTT_REPORTING.BMF_EXTRACT  G
	ON B.DSL_ACCOUNTNUMBER = G.ACCOUNT_NO  AND date(G.EXTRACT_FILE_DATE) = date(CURRENT_DATE())
	LEFT JOIN ATNI_PROD.GTT_REPORTING.BMF_EXTRACT  I
	ON B.FIBRE_ACCOUNTNUMBER = I.ACCOUNT_NO  AND date(I.EXTRACT_FILE_DATE) = date(CURRENT_DATE())
WHERE 
	G.TRANS_AMOUNT/100 > 0 AND G.BMF_TRANS_TYPE NOT IN(16,33,51,52,53,80,90)
	I.TRANS_AMOUNT/100 > 0 AND I.BMF_TRANS_TYPE NOT IN(16,33,51,52,53,80,90)