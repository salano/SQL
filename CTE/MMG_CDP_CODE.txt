WITH PROCESS_PAY_MMG (EXTERNAL_ID,DEBTOR_REFERENCE, Process_pay_MMG ) AS 
	(	
	SELECT 
		    distinct
			E.EXTERNAL_ID
			,T.DEBTOR_REFERENCE
			,IFF(T.DEBTOR_REFERENCE IS NULL,0,1) Process_pay_MMG
			
		FROM 
			ATNI_PROD.GTT_REPORTING.EXTERNAL_ID_EQUIP_MAP_EXTRACT E
			JOIN ATNI_PROD.GTT_REPORTING.CDR_DATA CD 
				ON E.EXTERNAL_ID = CD.EXTERNAL_ID
			LEFT JOIN ATNI_PROD.MFS.TRANS T
			ON SUBSTRING(E.EXTERNAL_ID,4,10) = T.DEBTOR_REFERENCE
			 
		WHERE 
			E.IS_CURRENT = 1
			AND E.EXTERNAL_ID_TYPE = 1
			AND CD.EXTERNAL_ID_TYPE = 1
			AND CD.PAYMENT_MODE <> 1
			AND Date(E.EXTRACT_FILE_DATE) = current_date 
			AND T.CREDITOR_CATEGORY_ID = 'biller' 
			AND T.IS_SUCCESSFUL = 1
			AND T.TRANS_TYPE_ID IN ('gtt_post_pay','gtt_landln_pay','gtt_blaze_pay','gtt_lte_pay','gtt_dsl_pay', 'gtt_bill_pay')
			AND date(T.COMPLETED_DATE) >= ADD_MONTHS(current_date, -3)
			AND date(CD.TRANS_DT) >= ADD_MONTHS(current_date, -3)
	),
	PREPAID_NO_TOPUP(EXTERNAL_ID,DEBTOR_REFERENCE, Process_TOPUP_MMG) AS 
	(
		SELECT 
		    distinct
			E.EXTERNAL_ID
			,T.DEBTOR_REFERENCE
			,IFF(T.DEBTOR_REFERENCE IS NULL,0,1) Process_TOPUP_MMG
			
		FROM 
			ATNI_PROD.GTT_REPORTING.EXTERNAL_ID_EQUIP_MAP_EXTRACT E
			JOIN ATNI_PROD.GTT_REPORTING.CDR_DATA CD 
				ON E.EXTERNAL_ID = CD.EXTERNAL_ID
			LEFT JOIN ATNI_PROD.MFS.TRANS T
			ON SUBSTRING(E.EXTERNAL_ID,4,10) = T.DEBTOR_REFERENCE
		WHERE 
			E.IS_CURRENT = 1
			AND E.EXTERNAL_ID_TYPE = 1
			AND CD.EXTERNAL_ID_TYPE = 1
			AND CD.PAYMENT_MODE = 1
			AND Date(E.EXTRACT_FILE_DATE) = current_date 
			AND T.IS_SUCCESSFUL = 1
			AND T.TRANS_TYPE_ID not  IN ('gtt_pre_pay','gttself_pre_pay')
			AND date(T.COMPLETED_DATE) >= ADD_MONTHS(current_date, -3)
			AND date(CD.TRANS_DT) >= ADD_MONTHS(current_date, -3)
	),
	GTT_PREPAID_NON_MMG(EXTERNAL_ID,UC_reference,NON_MMG_RECHARGE) AS 
	(
		SELECT
			DISTINCT 
			EIEM.EXTERNAL_ID,
			 SUBSTRING(EIEM.EXTERNAL_ID,4,10) UC_reference
			 ,0 AS NON_MMG_RECHARGE
		FROM ATNI_PROD.GTT_REPORTING.RECHARGE_HISTORY RH
			JOIN ATNI_PROD.GTT_REPORTING.RECHARGE_HISTORY_BALANCE RHB
			ON RH.RECHARGE_ID = RHB.RECHARGE_ID AND RH.RECHARGE_ID2 = RHB.RECHARGE_ID2
			LEFT JOIN (
				SELECT DISTINCT 
					SUBSCR_NO, EXTERNAL_ID
				FROM ATNI_PROD.GTT_REPORTING.EXTERNAL_ID_EQUIP_MAP
				WHERE DATE(EFFECTIVE_DT)-1 <= date(current_date) AND DATE(EXPIRY_DT)-1 > date(current_date)
				AND EXTERNAL_ID_TYPE = 1 AND IS_CURRENT = 1) EIEM
			ON RH.SUBSCR_NO = EIEM.SUBSCR_NO
		WHERE DATE(RH.RECHARGE_DATE_TIME) >= ADD_MONTHS(current_date, -3)
		AND substring(nvl(RH.RECHARGE_COMMMENT,' '),1,8) != 'inswitch' AND nvl(RHB.AMOUNT,0) < 0
		AND substring(EIEM.EXTERNAL_ID,1,4) = '5926'
		AND RHB.BALANCE_ID = 89 AND RHB.PAYMENT_MODE = 1
		AND RHB.AMOUNT < 0 AND RH.RECHARGE_USER != 'mmguser' 
	),
	GTT_MOBILE_NON_MMG_SUBSCRIBER(EXTERNAL_ID,REFERENCE, GTT_MOBILE_MMG_SUBSCRIBER ) AS 
	(
		SELECT 
		    distinct
			E.EXTERNAL_ID
			,UR.REFERENCE
			,IFF(UR.REFERENCE IS NULL,0,1) GTT_MOBILE_MMG_SUBSCRIBER
			
		FROM 
			ATNI_PROD.GTT_REPORTING.EXTERNAL_ID_EQUIP_MAP_EXTRACT E
			LEFT JOIN ATNI_PROD.MFS.USER_REFERENCE UR
			ON SUBSTRING(E.EXTERNAL_ID,4,10) = UR.REFERENCE
			 
		WHERE 
			E.IS_CURRENT = 1
			AND E.EXTERNAL_ID_TYPE = 1
			AND Date(E.EXTRACT_FILE_DATE) = current_date 
			AND UR.IS_DELETED = 0
	
	),
	INACTIVE_MMG (REFERENCE,CURRENT_BALANCE,IS_DELETED) AS 
	(
		SELECT 
			DISTINCT 
			UR.REFERENCE
			,W.LATEST_CURRENT_BALANCE
			,UR.IS_DELETED
		FROM 
			ATNI_PROD.MFS.USER_REFERENCE UR
			JOIN ATNI_PROD.MFS.WALLET W 
				ON UR.USER_ID = W.OWNER_USER_ID AND W.WALLET_TYPE_ID = 1

			
		WHERE 
		UR.IS_DELETED = 1
	
	),
	MMG_SUBS_PAY_GTT_BILLS(INITIATOR_REFERENCE, DEBTOR_REFERENCE, MMG_PAYS_GTT_BILLS) AS 
	(
			SELECT 
				INITIATOR_REFERENCE 
				,DEBTOR_REFERENCE
				,1 MMG_PAYS_GTT_BILLS
			FROM ATNI_PROD.MFS.TRANS 
			WHERE CREDITOR_CATEGORY_ID = 'biller' 
			AND  IS_SUCCESSFUL = 1 AND 
			TRANS_TYPE_ID IN ('gtt_post_pay','gtt_landln_pay','gtt_blaze_pay','gtt_lte_pay','gtt_dsl_pay', 'gtt_bill_pay')
			AND date(COMPLETED_DATE) >= ADD_MONTHS(current_date, -3)
			AND try_to_numeric(SUBSTRING(INITIATOR_REFERENCE,0,1)) IN (6,7) 
	),
	AGENTS_PAYS_BILLS (USER_CATEGORY_ID, INITIATOR_REFERENCE,DEBTOR_REFERENCE,CREDITOR_REFERENCE,CREDITOR_CATEGORY_ID, AGENT_PAYS_BILLS) AS 
	(
		SELECT
			U.USER_CATEGORY_ID,
				T.INITIATOR_REFERENCE,
				T.DEBTOR_REFERENCE,
				T.CREDITOR_REFERENCE,
				T.CREDITOR_CATEGORY_ID,
				1 AGENT_PAYS_BILLS
			FROM 
				ATNI_PROD.MFS.TRANS T 
			JOIN 
				ATNI_PROD.MFS.TRANS_PARTY TP 
				ON T.INITIATOR_REFERENCE = TP.REFERENCE
			JOIN ATNI_PROD.MFS.USERS U 
			ON TP.USER_ID = U.ID 
			WHERE 
				U.USER_CATEGORY_ID = 'agent'
				AND date(T.COMPLETED_DATE) >= ADD_MONTHS(current_date, -3)
				AND CREDITOR_CATEGORY_ID = 'biller'
				AND  IS_SUCCESSFUL = 1
				AND T.DESCRIPTION LIKE 'NW%'
	),
	MMG_SUBSCRIBERS(
	
				USER_CATEGORY_ID
				,NAME
				,MIDDLE_NAME
				,FAMILY_NAME
				,EMAIL_ADDRESS
				,ADDRESS
				,ADDRESS_2
				,CITY
				,REGION
				,COUNTRY
				,NATIONALITY
				,CONTACT_NO
				,ID_TYPE
				,ID_NUMBER
				,DOB
				,TIN_NUMBER
				,LANGUAGE
				,STATUS_REGISTERED
				,STATUS_ACTIVE
				,STATUS_SUSPENDED
				,STATUS_FROZEN
				,STATUS_STOPPED
				,STATUS_CHANGE
				,OT_STATUS_CHANGE
				,EMPLOYER
				,EMPLOYEE_NUMBER
				,REGISTRATION_DATE
				,AGENT_TYPE_CASH_AGENT
				,AGENT_TYPE_HIGH_VOLUME_DEBTOR
				,AGENT_TYPE_HIGH_VOLUME_CREDITR
				,CONTACT_NAME
				,OWNER_GIVEN_NAME
				,OWNER_MIDDLE_NAME
				,OWNER_FAMILY_NAME
				,OWNER_ADDRESS
				,OWNER_ADDRESS_2
				,OWNER_CITY
				,OWNER_REGION
				,OWNER_COUNTRY
				,OWNER_NATIONALITY
				,OWNER_ID_TYPE
				,OWNER_ID_NUMBER
				,OWNER_CONTACT_NO
				,OWNER_EMAIL
				,OWNER_TIN_NUMBER
				,REFERAL_CODE
				,PROMO_CODE
				,ACCNTYPE
				,BANK
				,BANK_BRANCH_MANDATE
				,KYC_LEVEL
				,REUPLOAD
				,DORMANCY_LEVEL
				,BLACKLISTED
				,ISDELETEREQ
				,PROGRAM
				,USERTYPE
				,BUSINESS_CTG
				,AGENT_USERTYPE
				,USER_LEVEL
				,ACCOUNT_STATUS
				,SUBSCRIBER_ID
				,MOBILE_NUMBER
				,LATEST_CURRENT_BALANCE
				, PROVIDER_NAME
	
	) AS 
		( 
			SELECT 
			   DISTINCT 
				UD.USER_CATEGORY_ID
				,NAME
				,MIDDLE_NAME
				,FAMILY_NAME
				,EMAIL_ADDRESS
				,ADDRESS
				,ADDRESS_2
				,CITY
				,REGION
				,COUNTRY
				,NATIONALITY
				,CONTACT_NO
				,ID_TYPE
				,ID_NUMBER
				,DOB
				,TIN_NUMBER
				,LANGUAGE
				,STATUS_REGISTERED
				,STATUS_ACTIVE
				,STATUS_SUSPENDED
				,STATUS_FROZEN
				,STATUS_STOPPED
				,STATUS_CHANGE
				,OT_STATUS_CHANGE
				,EMPLOYER
				,EMPLOYEE_NUMBER
				,REGISTRATION_DATE
				,AGENT_TYPE_CASH_AGENT
				,AGENT_TYPE_HIGH_VOLUME_DEBTOR
				,AGENT_TYPE_HIGH_VOLUME_CREDITR
				,CONTACT_NAME
				,OWNER_GIVEN_NAME
				,OWNER_MIDDLE_NAME
				,OWNER_FAMILY_NAME
				,OWNER_ADDRESS
				,OWNER_ADDRESS_2
				,OWNER_CITY
				,OWNER_REGION
				,OWNER_COUNTRY
				,OWNER_NATIONALITY
				,OWNER_ID_TYPE
				,OWNER_ID_NUMBER
				,OWNER_CONTACT_NO
				,OWNER_EMAIL
				,OWNER_TIN_NUMBER
				,REFERAL_CODE
				,PROMO_CODE
				,ACCNTYPE
				,BANK
				,BANK_BRANCH_MANDATE
				,KYC_LEVEL
				,REUPLOAD
				,DORMANCY_LEVEL
				,BLACKLISTED
				,ISDELETEREQ
				,PROGRAM
				,USERTYPE
				,BUSINESS_CTG
				,AGENT_USERTYPE
				,USER_LEVEL
				,ACCOUNT_STATUS
				,U.ID SUBSCRIBER_ID
				,UR.REFERENCE AS MOBILE_NUMBER
				,W.LATEST_CURRENT_BALANCE
				,CASE WHEN substr(UR.REFERENCE,0,3) IN (select PREFIX_SHORT from DIGICEL_PREFIXES) THEN 'DIGICEL'
					WHEN substr(UR.REFERENCE,0,3) IN (select PREFIX_SHORT from GTT_PREFIXES) THEN 'GTT'
					ELSE 'UNKNOWN'
				END PROVIDER_NAME
			
			
			FROM 
				ATNI_PROD.MFS.CDP_QUERY_OUTPUT  UD --WHERE date(UD.SNAPSHOT_DATE) = date(CURRENT_DATE)
							
			 LEFT JOIN ATNI_PROD.MFS.USER_ U 
				ON UD.ID = U.LATEST_USER_DETAILS_ID  
			 LEFT JOIN ATNI_PROD.MFS.USER_REFERENCE UR 
				ON U.ID =  UR.USER_ID AND UR.USER_REF_TYPE_ID = 'msisdn' AND  UR.IS_DELETED = 0
			 LEFT JOIN ATNI_PROD.MFS.WALLET W 
				ON UR.USER_ID = W.OWNER_USER_ID AND W.WALLET_TYPE_ID = 1
				
		WHERE 
			 date(UD.SNAPSHOT_DATE) = date(CURRENT_DATE -1)
				

		
		)
	
	------------------------------------------------------------
	 
	SELECT 
			distinct
				MS.USER_CATEGORY_ID
				,CASE WHEN MS.USER_CATEGORY_ID IN ('agent','merchant','distributor') then  MS.NAME
					ELSE 
						NULL END COMPANY_NAME
				,CASE WHEN MS.USER_CATEGORY_ID = 'subscriber' then MS.NAME
					WHEN MS.USER_CATEGORY_ID IN ('agent','merchant','distributor') THEN MS.OWNER_GIVEN_NAME
					END FIRST_NAME
				,CASE WHEN MS.USER_CATEGORY_ID = 'subscriber' then MS.MIDDLE_NAME
					WHEN MS.USER_CATEGORY_ID IN ('agent','merchant','distributor') THEN MS.OWNER_MIDDLE_NAME
					END MIDDLE_NAME
				,CASE WHEN MS.USER_CATEGORY_ID = 'subscriber' then MS.FAMILY_NAME
					WHEN MS.USER_CATEGORY_ID IN ('agent','merchant','distributor') THEN MS.OWNER_FAMILY_NAME
					END FAMILY_NAME
				,MS.EMAIL_ADDRESS
				,MS.ADDRESS
				,MS.ADDRESS_2
				--,CM.CITY_NAME CITY
				,concat('Region ', MS.REGION) REGION
				,MS.COUNTRY
				,MS.NATIONALITY
				,concat('592', MS.CONTACT_NO) CONTACT_NO
				,MS.ID_TYPE
				,MS.ID_NUMBER
				,MS.DOB
				,MS.TIN_NUMBER
				,MS.LANGUAGE
				,MS.STATUS_REGISTERED
				,MS.STATUS_ACTIVE
				,MS.STATUS_SUSPENDED
				,MS.STATUS_FROZEN
				,MS.STATUS_STOPPED
				,MS.STATUS_CHANGE
				,MS.OT_STATUS_CHANGE
				,MS.EMPLOYER
				,MS.EMPLOYEE_NUMBER
				,MS.REGISTRATION_DATE
				,MS.AGENT_TYPE_CASH_AGENT
				,MS.AGENT_TYPE_HIGH_VOLUME_DEBTOR
				,MS.AGENT_TYPE_HIGH_VOLUME_CREDITR
				,MS.CONTACT_NAME
				,MS.OWNER_GIVEN_NAME
				,MS.OWNER_MIDDLE_NAME
				,MS.OWNER_FAMILY_NAME
				,MS.OWNER_ADDRESS
				,MS.OWNER_ADDRESS_2
				--,CM1.CITY_NAME OWNER_CITY
				,concat('Region ',MS.OWNER_REGION) OWNER_REGION
				,MS.OWNER_COUNTRY
				,MS.OWNER_NATIONALITY
				,MS.OWNER_ID_TYPE
				,MS.OWNER_ID_NUMBER
				,concat('592', MS.OWNER_CONTACT_NO) OWNER_CONTACT_NO
				,MS.OWNER_EMAIL
				,MS.OWNER_TIN_NUMBER
				,MS.REFERAL_CODE
				,MS.PROMO_CODE
				,MS.ACCNTYPE
				,MS.BANK
				,MS.BANK_BRANCH_MANDATE
				,MS.KYC_LEVEL
				,MS.REUPLOAD
				,MS.DORMANCY_LEVEL
				,MS.BLACKLISTED
				,MS.ISDELETEREQ
				,MS.PROGRAM
				,MS.USERTYPE
				,MS.BUSINESS_CTG
				,MS.AGENT_USERTYPE
				,MS.USER_LEVEL
				,MS.ACCOUNT_STATUS
				,MS.SUBSCRIBER_ID
				,MS.MOBILE_NUMBER
				,concat('+592',MS.MOBILE_NUMBER) FormattedE164PhoneNumber
				,MS.LATEST_CURRENT_BALANCE
				, MS.PROVIDER_NAME
		,PM.DEBTOR_REFERENCE, PM.Process_pay_MMG
		, PNT.Process_TOPUP_MMG
		,GTT_PNM.NON_MMG_RECHARGE
		,GTT_MNMS.GTT_MOBILE_MMG_SUBSCRIBER
		,IM.CURRENT_BALANCE inactive_CURRENT_BALANCE,IM.IS_DELETED inactive_status
		,MSGB.MMG_PAYS_GTT_BILLS
		,APB.AGENT_PAYS_BILLS
		FROM 
		MMG_SUBSCRIBERS MS
	LEFT JOIN PROCESS_PAY_MMG PM
		ON  MS.MOBILE_NUMBER = PM.DEBTOR_REFERENCE
	LEFT JOIN AGENTS_PAYS_BILLS APB
		ON MS.MOBILE_NUMBER = APB.INITIATOR_REFERENCE
	LEFT JOIN MMG_SUBS_PAY_GTT_BILLS MSGB 
		ON MS.MOBILE_NUMBER = MSGB.INITIATOR_REFERENCE
	LEFT JOIN INACTIVE_MMG IM 
		ON MS.MOBILE_NUMBER = IM.REFERENCE
	LEFT JOIN GTT_MOBILE_NON_MMG_SUBSCRIBER GTT_MNMS 
		ON MS.MOBILE_NUMBER = GTT_MNMS.REFERENCE
	LEFT JOIN GTT_PREPAID_NON_MMG GTT_PNM
		 ON MS.MOBILE_NUMBER = GTT_PNM.UC_REFERENCE
	LEFT JOIN PREPAID_NO_TOPUP PNT 
		ON MS.MOBILE_NUMBER = PNT.DEBTOR_REFERENCE
	LEFT JOIN ATNI_DEV.GTT_REPORTING.CITIES_MMG CM 
		ON MS.CITY = CM.CITY
	LEFT JOIN ATNI_DEV.GTT_REPORTING.CITIES_MMG CM1 
		ON MS.OWNER_CITY = CM.CITY