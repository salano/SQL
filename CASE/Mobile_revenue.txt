SELECT
       TO_CHAR(Detail.APPLY_DATE, 'YYYY-MM') Month_id,
       Detail.OFFER_ID,
       Detail.OFFER_DESCRIPTION,
       COUNT(DISTINCT Detail.OFFER_INST_ID) AS S_COUNT,
       SUM(Detail.CHARGED_AMOUNT - Detail.TOTAL_TAX) AS REVENUE_PREPAID, 
       SUM(Detail.TOTAL_TAX) AS TAX_PREPAID,
       SUM(Detail.CHARGED_AMOUNT) AS CHARGED_AMOUNT,
       SUM(CASE WHEN Detail.RC_TYPE = 'Unknown' THEN Detail.CHARGED_AMOUNT - Detail.TOTAL_TAX ELSE 0 END) AS REVENUE_PLAN,
       SUM(CASE WHEN Detail.RC_TYPE = 'Voice' THEN Detail.CHARGED_AMOUNT - Detail.TOTAL_TAX ELSE 0 END) AS REVENUE_VOICE,
       SUM(CASE WHEN Detail.RC_TYPE = 'SMS' THEN Detail.CHARGED_AMOUNT - Detail.TOTAL_TAX ELSE 0 END) AS REVENUE_SMS,
       SUM(CASE WHEN Detail.RC_TYPE = 'Data' THEN Detail.CHARGED_AMOUNT - Detail.TOTAL_TAX ELSE 0 END) AS REVENUE_DATA,
       SUM(CASE WHEN Detail.RC_TYPE = 'Unknown' THEN Detail.TOTAL_TAX ELSE 0 END) AS TAX_PLAN,
       SUM(CASE WHEN Detail.RC_TYPE = 'Voice' THEN Detail.TOTAL_TAX ELSE 0 END) AS TAX_VOICE,
       SUM(CASE WHEN Detail.RC_TYPE = 'SMS' THEN Detail.TOTAL_TAX ELSE 0 END) AS TAX_SMS,
       SUM(CASE WHEN Detail.RC_TYPE = 'Data' THEN Detail.TOTAL_TAX ELSE 0 END) AS TAX_DATA
FROM
       (SELECT 
             A.APPLY_DATE,
             A.RC_TERM_INST_ID,
             A.PARENT_ACCOUNT_NO AS ACCOUNT_NO,
             A.PARENT_SUBSCR_NO AS SUBSCR_NO,
             A.OFFER_ID,
             D.DISPLAY_VALUE AS OFFER_DESCRIPTION,
             A.RC_TERM_ID,
             F.DISPLAY_VALUE AS RC_TERM_DISPLAY_VALUE,
             CASE WHEN UPPER(F.DISPLAY_VALUE) LIKE '%DATA%' THEN 'Data'
                    WHEN UPPER(F.DISPLAY_VALUE) LIKE '%VOICE%' THEN 'Voice'
                    WHEN UPPER(F.DISPLAY_VALUE) LIKE '%SMS%' THEN 'SMS'
                    ELSE 'Unknown' END AS RC_TYPE,
             A.NUM_DAYS,
             B.OFFER_TYPE,
             E.OFFER_INST_ID,
             C.BALANCE_ID,
             A.AMOUNT/100 as AMOUNT,
             A.TOTAL_TAX/100 AS TOTAL_TAX,
             C.BALANCE_AMOUNT/100 AS CHARGED_AMOUNT
       FROM RC A
             LEFT JOIN OFFER_REF B
             ON A.OFFER_ID = B.OFFER_ID AND B.RESELLER_VERSION_ID = (SELECT MAX(reseller_version_id) FROM reseller_version)
             JOIN RC_BALANCE C
             ON A.RC_TERM_INST_ID = C.RC_TERM_INST_ID AND A.BILLING_SEQUENCE_NUMBER = C.BILLING_SEQUENCE_NUMBER AND C.PAYMENT_MODE = 1
             LEFT JOIN OFFER_VALUES D
             ON A.OFFER_ID = D.OFFER_ID AND D.RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM OFFER_VALUES)
             LEFT JOIN RC_TERM_INST_EXTRACT E
             ON E.RC_TERM_INST_ID = A.RC_TERM_INST_ID AND DATE(E.EXTRACT_FILE_DATE) = current_date
             LEFT JOIN RC_TERM_VALUES F
             ON F.RC_TERM_ID = A.RC_TERM_ID AND F.RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM RC_TERM_VALUES)
       WHERE B.SERVICE_CATEGORY_ID=4 AND B.PAYMENT_MODE=1 AND C.BALANCE_ID = 89
       AND DATE(A.APPLY_DATE) BETWEEN date_trunc('month',current_date - day(current_date)) AND date(current_date-day(current_date))
       AND A.AMOUNT != 0) Detail
GROUP BY 1,2,3
ORDER BY 1,2
