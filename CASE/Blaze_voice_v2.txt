SELECT
	distinct
    CD.ACCOUNT_NO,
    CD.EXTERNAL_ID,
    acv.DISPLAY_VALUE cust_type, 
    to_char(CD.TRANS_DT, 'YYYY-MM') u_month,
    listagg( DISTINCT O.DISPLAY_VALUE, ', ') offer_list,
    CONTAINS(listagg( DISTINCT O.DISPLAY_VALUE, ', '),'Plus') fibre_voice,
    count(1) num_calls,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=51 AND CD.AMOUNT_PREPAID > 0   THEN CD.PRIMARY_UNITS/60 ELSE 0 END),2) Free_Blaze_to_Blaze,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=50 AND CD.AMOUNT_PREPAID > 0  THEN CD.PRIMARY_UNITS/60 ELSE 0 END),2) Free_Blaze_to_landline,
    round(sum(CD.PRIMARY_UNITS/60),2) AS metered_minutes,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=47 AND CD.AMOUNT_PREPAID > 0  THEN CD.PRIMARY_UNITS/60 ELSE 0 END),2) Free_blaze_to_International,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=51 AND CD.AMOUNT_POSTPAID > 0 THEN CD.PRIMARY_UNITS/60 ELSE 0 END),2) Blaze_to_Blaze,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=50 AND CD.AMOUNT_POSTPAID > 0 THEN CD.PRIMARY_UNITS/60 ELSE 0 END),2) Blaze_to_landline,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=48 AND CD.AMOUNT_POSTPAID > 0 THEN CD.PRIMARY_UNITS/60 ELSE 0 END),2) Blaze_to_gtt_mobile,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=49 AND CD.AMOUNT_POSTPAID > 0 THEN CD.PRIMARY_UNITS/60 ELSE 0 END),2) Blaze_to_digicel_mobile,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID NOT IN (47,48,49,50,51) THEN CD.PRIMARY_UNITS/60 ELSE 0 END),2) Blaze_other,
    round(sum(CD.AMOUNT / 100),2) AS metered_revenue,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=47 THEN CD.AMOUNT_POSTPAID / 100 ELSE 0 END),2) blaze_to_International_revenue,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=51 THEN CD.AMOUNT_POSTPAID / 100 ELSE 0 END),2) Blaze_to_Blaze_revenue,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=50 THEN CD.AMOUNT_POSTPAID / 100 ELSE 0 END),2) Blaze_to_landline_revenue,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=48 THEN CD.AMOUNT_POSTPAID / 100 ELSE 0 END),2) Blaze_to_gtt_mobile_revenue,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID=49 THEN CD.AMOUNT_POSTPAID / 100 ELSE 0 END),2) Blaze_to_digicel_mobile_revenue,
    round(sum(CASE WHEN AGM.AUT_GROUP_ID NOT IN (47,48,49,50,51) THEN CD.AMOUNT / 100 ELSE 0 END),2) Blaze_other_revenue
    

FROM ATNI_PROD.GTT_REPORTING.CDR_DATA CD
    JOIN ATNI_PROD.GTT_REPORTING.AUT_FINAL_VALUES AFV
    ON AFV.AUT_ID = CD.AUT_ID
    AND AFV.RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM ATNI_PROD.GTT_REPORTING.AUT_FINAL_VALUES)
    LEFT JOIN ATNI_PROD.GTT_REPORTING.AUT_GROUP_MAP AGM
        ON AGM.AUT_ID = CD.AUT_ID
        AND AGM.RESELLER_VERSION_ID = (SELECT MAX(RESELLER_VERSION_ID) FROM ATNI_PROD.GTT_REPORTING.AUT_GROUP_MAP)
   LEFT JOIN ATNI_PROD.GTT_REPORTING.CMF_EXTRACT c
   ON CD.ACCOUNT_NO = C.ACCOUNT_NO AND date(c.EXTRACT_FILE_DATE) = date(current_date)
   join ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES acv on c.account_category = acv.account_category and acv.SERVICE_VERSION_ID = (select max(SERVICE_VERSION_ID) from ATNI_PROD.GTT_REPORTING.ACCOUNT_CATEGORY_VALUES)
   
   LEFT JOIN 
   	(SELECT distinct offer_id, ACCOUNT_NO, SUBSCR_NO,disconnect_reason, ACTIVE_DT,INACTIVE_DT FROM  ATNI_PROD.GTT_REPORTING.OFFER_INST WHERE  offer_id IN (
										SELECT
										try_TO_NUMERIC(REPLACE(PRODUCTCODE,'MP',''))
										FROM
										ATNI_PROD.SC_OUTPUT.DIMPRODUCT
										WHERE
										LEAFLEVELNAME='Internet'
										AND SOURCESYSTEMID=1
										AND PRODUCTCODE LIKE 'MP%'
									)  )   ins
   ON ins.SUBSCR_NO = CD.SUBSCR_NO  AND ins.INACTIVE_DT IS null
   JOIN
	 ATNI_PROD.GTT_REPORTING.OFFER_VALUES O ON ins.OFFER_ID=O.OFFER_ID AND O.RESELLER_VERSION_ID IN(SELECT MAX(RESELLER_VERSION_ID) FROM ATNI_PROD.GTT_REPORTING.OFFER_VALUES)
WHERE DATE(CD.TRANS_DT) BETWEEN date_trunc('month',dateadd('month', -1, current_date)) AND last_day(dateadd('month', -1, current_date))
AND CD.EXTERNAL_ID_TYPE = 37
AND CD.PRIMARY_UNITS > 0
AND AFV.DISPLAY_VALUE LIKE '%Voice_GPON%'
GROUP BY 1,2,3,4
ORDER BY 12,1,2,3