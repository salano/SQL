SELECT 

sub2.*


FROM

(

	SELECT 
		distinct
		sub.*,
		SN.SID AS application_number,
		SN.LCP,
		O.DISPLAY_VALUE SO_DESCRIPTION,
		SRV.DISPLAY_VALUE AS DISCONNECTION_TYPE,
		--ins.disconnect_reason,
		DRV.DISPLAY_VALUE DISCONNECTION_REASON
		--count(1)
	
	FROM
	(
		SELECT
		distinct
		a.DATESTART ,
		ifNULL(b.DATEOUT, a.DATESTART) AS DEACT_DATE,
		a.ACCOUNTNUMBER,
		a.BID,
		a.FIRSTNAME,
		a.LASTNAME,
		a.COMPANYNAME,
		a.PRODUCT_NAME,
		abs(a.DEACTIVATIONS) DEACTIVATIONS
		FROM
		ATNI_PROD.ATNI_ANALYTICS.SUBSCRIBER_BG_END_WEEKLY_MONTHLY_SNAPSHOT_DAILYACTIVITY a 
		 LEFT JOIN ATNI_PROD.SC_INPUT.ODSSUBSCRIBERSNAPSHOT b 
		 	ON a.DATESTART = b.DATESTART AND a.ACCOUNTNUMBER = b.ACCOUNTNUMBER  AND a.BID = b.BID AND b.SOURCESYSTEMID=1
		WHERE
		a.DATASET_TYPE='DAILY_SUB_ACTIVITY'
		AND a.SYSTEMID=24
		AND a.OFFICIALLY_COUNTED_SUBSCRIBER='yes'
		AND a.DEACTIVATIONS<>0
		AND a.DATESTART <= '2021-12-31'		
		--AND  a.accountnumber ='22139772'
		UNION
		distinct
		SELECT
		a.DATESTART,
		ifNULL(b.DATEOUT, a.DATESTART) AS DEACT_DATE,
		a.ACCOUNTNUMBER,
		a.SUBSCRIBERNUMBER AS bid,
		a.FIRSTNAME,
		a.LASTNAME,
		a.COMPANYNAME,
		a.PRODUCT_NAME,
		abs(a.DEACTIVATIONS) DEACTIVATIONS
		FROM
		ATNI_PROD.GTT_SAA_HIST.SV_LEGACY_SC_SUB_BG_END_MONTHLY_SNAPSHOT_DAILYACTIVITY a
		LEFT JOIN ATNI_PROD.GTT_REPORTING.SCORECARD_SUBSCRIBER_DETAIL b 
		 	ON a.DATESTART = b.snapshotdate AND a.ACCOUNTNUMBER = b.ACCOUNTNUMBER  AND a.SUBSCRIBERNUMBER = b.SUBSCRIBERNUMBER AND b.SOURCESYSTEMID=1
		WHERE
		a.DATASET_TYPE='DAILY_SUB_ACTIVITY'
		AND a.TECHNOLOGY=24
		AND a.REVENUE_COUNTABLE=1
		AND a.UNIT_COUNTABLE=1
		AND a.DEACTIVATIONS<>0
		AND a.DATESTART  BETWEEN '2020-01-01' AND '2020-02-29'
		
	)
	sub
		left join
		    (SELECT distinct offer_id, ACCOUNT_NO, SUBSCR_NO,disconnect_reason, INACTIVE_DT FROM  ATNI_PROD.GTT_REPORTING.OFFER_INST WHERE  offer_id IN (
										SELECT
										try_TO_NUMERIC(REPLACE(PRODUCTCODE,'MP',''))
										FROM
										ATNI_PROD.SC_OUTPUT.DIMPRODUCT
										WHERE
										LEAFLEVELNAME='Internet'
										AND SOURCESYSTEMID=1
										AND PRODUCTCODE LIKE 'MP%'
									)  )   ins
		    
		    
		        on sub.ACCOUNTNUMBER = ins.ACCOUNT_NO and date(sub.DEACT_DATE) = date(ins.INACTIVE_DT) 
		       left JOIN
				ATNI_PROD.GTT_REPORTING.OFFER_VALUES O ON ins.OFFER_ID=O.OFFER_ID AND RESELLER_VERSION_ID IN(SELECT MAX(RESELLER_VERSION_ID) FROM ATNI_PROD.GTT_REPORTING.OFFER_VALUES)
			   LEFT JOIN (
			   		SELECT 
						DISTINCT a.lcp, a.sid, a.updated, a.GPON_NUMBER, a.ACCOUNT_NUMBER
					FROM 
						ATNI_DEV.GTT_REPORTING.GPON_SERVICE_NOW_ORDER_STATUS_v1 a  
					 JOIN (SELECT sid, max(updated) updated FROM ATNI_DEV.GTT_REPORTING.GPON_SERVICE_NOW_ORDER_STATUS_v1 GROUP BY 1) b
						ON a.sid = b.sid AND a.UPDATED = b.updated
			   
			   ) SN 
		        	ON SUB.ACCOUNTNUMBER = SN.ACCOUNT_NUMBER AND SUB.BID = SN.GPON_NUMBER 
		       left join
		        (
		        	SELECT a.SUBSCR_NO,STATUS_REASON_ID , a.extract_file_date, a.INACTIVE_DT FROM   ATNI_PROD.GTT_REPORTING.SUBSCRIBER_STATUS_EXTRACT a
					JOIN  (SELECT SUBSCR_NO,  max(INACTIVE_DT) INACTIVE_DT FROM ATNI_PROD.GTT_REPORTING.SUBSCRIBER_STATUS_EXTRACT WHERE  date(INACTIVE_DT) >= to_date('2020-01-01','YYYY-MM-DD') AND date(extract_file_date) = date(current_date)  GROUP BY 1 ) b 
					ON a.SUBSCR_NO = b.SUBSCR_NO AND a.INACTIVE_DT = b.INACTIVE_DT 
					
					WHERE  date(a.extract_file_date) = date(current_date)
		        )  s
		          
		        on ins.SUBSCR_NO = s.SUBSCR_NO and date(s.INACTIVE_DT) = date(ins.INACTIVE_DT)  
		        left join ATNI_PROD.GTT_REPORTING.DISCONNECT_REASON_VALUES DRV
		            on ins.disconnect_reason = DRV.disconnect_reason 
		        left join ATNI_DEV.GTT_REPORTING.STATUS_REASON_VALUES SRV
	   				on s.STATUS_REASON_ID = srv.STATUS_REASON_ID
	   				
)
sub2