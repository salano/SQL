SELECT
Q.*,
 RC.MRC_MTH,
 RC.MRC,
 RC.APPLY_DATE MRC_APPLY_DATE
FROM
(
    SELECT
    distinct
    ACCOUNTNUMBER,
    BID,
    PRODUCT_NAME, 
    E.SUBSCR_NO,
    SUM(ENDING_ACTIVE) AS ENDING_ACTIVE
    FROM
    ATNI_PROD.ATNI_ANALYTICS.SUBSCRIBER_BG_END_WEEKLY_MONTHLY_SNAPSHOT_DAILYACTIVITY A
    LEFT JOIN EXTERNAL_ID_EQUIP_MAP E
    	ON A.ACCOUNTNUMBER = E.ACCOUNT_NO AND A.BID = E.EXTERNAL_ID AND E.IS_CURRENT = 1 AND E.EXTERNAL_ID_TYPE =1
    WHERE
    DATESTART>= date_trunc('month',current_date)
    AND OPERATING_COMPANY_CODE=1
    AND SUBLINE_OF_SERVICE IN('Mobile Postpaid', 'Mobile Hybrid','Landline Phone Postpaid','Broadband Postpaid')
    GROUP BY 1,2,3,4
) AS Q
LEFT JOIN 
		(SELECT DISTINCT
			PARENT_ACCOUNT_NO AS ACCOUNT_NO,
			PARENT_SUBSCR_NO AS SUBSCR_NO,
			to_char(APPLY_DATE, 'YYYY-mm') MRC_MTH,
			--OFFER_ID,
			MAX(APPLY_DATE) AS APPLY_DATE,
			MAX(AMOUNT) / 100 AS MRC
		FROM ATNI_PROD.GTT_REPORTING.RC
		WHERE date(APPLY_DATE) between to_date('2022-01-01','YYYY-MM-DD') AND date(CURRENT_DATE)
		GROUP BY 1,2,3) RC
		ON Q.SUBSCR_NO = RC.SUBSCR_NO AND Q.ACCOUNTNUMBER = RC.ACCOUNT_NO --AND ins.OFFER_ID=RC.OFFER_ID 
WHERE
Q.ENDING_ACTIVE=1
ORDER BY 1,2,8